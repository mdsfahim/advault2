<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdVault Admin Panel</title>
    
    <!-- Firestore SDK only -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            /* Modern Emerald Palette */
            --color-primary: #059669; /* Emerald 600 */
            --color-secondary: #10b981; /* Emerald 500 */
            --color-accent: #fbbf24;
            --color-success: #10b981;
            --color-danger: #ef4444;
            --color-warning: #f59e0b;
            --color-info: #3b82f6;
            --sidebar-width: 260px; /* Slightly slimmer for a modern feel */
            --header-height: 72px;
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a; /* Slate 900 */
            --bg-secondary: #1e293b; /* Slate 800 */
            --bg-card: #1e293b;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --hover-bg: #334155;
        }

        [data-theme="light"] {
            --bg-primary: #f8fafc; /* Slate 50 */
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --hover-bg: #f1f5f9;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, sans-serif;
            -webkit-font-smoothing: antialiased;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Loading Screen */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--border-color);
            border-top: 5px solid var(--color-info);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--bg-secondary);
            position: fixed;
            left: 0;
            top: 0;
            border-right: 1px solid var(--border-color);
            padding: 1.5rem 1rem;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #1A5237, #3B7A57);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .nav-links {
            list-style: none;
            margin-bottom: 1rem;
            flex: 1;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        /* UPDATED NAV STYLES FOR DIVS */
.nav-link-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    text-decoration: none;
    color: var(--text-secondary);
    border-radius: 10px;
    font-weight: 500;
    transition: all 0.3s;
    cursor: pointer; /* Ensure it looks clickable */
    
    /* Disable Selection & Long Press Highlight */
    -webkit-tap-highlight-color: transparent;
    user-select: none;
    -webkit-user-select: none;
}

.nav-item:hover .nav-link-item {
    background: var(--bg-card);
    color: var(--text-primary);
}

.nav-item.active .nav-link-item {
    background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
    color: white !important;
    box-shadow: 0 4px 12px rgba(16, 185, 129, 0.25);
}

.nav-link-item i {
    width: 20px;
    text-align: center;
}
        .sidebar-footer {
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        /* Mobile Admin Info in Sidebar */
        .mobile-admin-info {
            display: none;
            padding: 1rem;
            background: var(--bg-card);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }

        .mobile-admin-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #1A5237, #3B7A57);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: calc(var(--header-height) + 1rem) 2rem 2rem 2rem;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
            display: block !important;
        }

        /* Fixed Header */
        .fixed-header {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            height: var(--header-height);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 1rem;
            z-index: 99;
            transition: left 0.3s ease;
            gap: 1rem;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            gap: 1rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
            min-width: 0;
        }

        .header-left-text {
            min-width: 0;
        }

        .header-left h1 {
            font-size: 1.25rem;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .header-left p {
            color: var(--text-secondary);
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-shrink: 0;
        }

        .theme-toggle {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .desktop-admin-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 12px;
            background: var(--bg-card);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .desktop-admin-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #1A5237, #3B7A57);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }

        .desktop-admin-info-text {
            display: flex;
            flex-direction: column;
        }

        .desktop-admin-info-text div:first-child {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .desktop-admin-info-text div:last-child {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .icon-users { background: #dbeafe; color: #1d4ed8; }
        .icon-balance { background: #dcfce7; color: #166534; }
        .icon-earnings { background: #fef3c7; color: #92400e; }
        .icon-withdrawals { background: #fee2e2; color: #991b1b; }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Charts Container - Fixed Height */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 400px), 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            height: 350px; /* Fixed height for charts */
            position: relative;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .chart-wrapper {
            position: relative;
            height: calc(100% - 2rem);
            width: 100%;
        }

        /* Users Table */
        .users-table-container {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .search-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            width: 300px;
            max-width: 100%;
        }

        .search-box input {
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            width: 100%;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th {
            text-align: left;
            padding: 12px 16px;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        tr:hover {
            background: var(--bg-secondary);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            background: linear-gradient(135deg, #1A5237, #3B7A57);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

       /* Modern Status Badges */
        .status-badge {
            padding: 4px 12px;
            border-radius: 9999px; /* Pill shape */
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            display: inline-block;
        }

        .status-active { background: rgba(16, 185, 129, 0.15); color: #10b981; }
        .status-inactive { background: rgba(239, 68, 68, 0.15); color: #ef4444; }

        /* Modern Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
        }

        .btn {
            padding: 6px 10px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85rem;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-edit { background: rgba(59, 130, 246, 0.1); color: #3b82f6; }
        .btn-edit:hover { background: #3b82f6; color: white; transform: translateY(-1px); }

        .btn-delete { background: rgba(239, 68, 68, 0.1); color: #ef4444; }
        .btn-delete:hover { background: #ef4444; color: white; transform: translateY(-1px); }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--border-color);
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .form-control:disabled {
            background: var(--bg-primary);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .form-control:focus {
            outline: none;
            border-color: #3B7A57;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1A5237, #3B7A57);
            color: white;
            padding: 10px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 1rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 82, 55, 0.3);
        }

        /* Mobile Menu Toggle */
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-primary);
            cursor: pointer;
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            align-items: center;
            justify-content: center;
        }

        /* Mobile theme toggle in menu */
        .mobile-theme-toggle {
            display: none;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin: 0.5rem 0;
            cursor: pointer;
            transition: all 0.3s;
            align-items: center;
            justify-content: space-between;
        }

        .mobile-theme-toggle:hover {
            background: var(--bg-secondary);
        }

        .mobile-theme-toggle span {
            font-weight: 500;
            color: var(--text-primary);
        }

        /* Analytics Top Users Table - Mobile Optimized */
        .top-users-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .top-users-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 350px; /* Minimum width for small screens */
        }

        .top-users-table th {
            text-align: left;
            padding: 12px 8px;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .top-users-table td {
            padding: 12px 8px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            white-space: nowrap;
        }

        .top-users-table tr:hover {
            background: var(--bg-secondary);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                z-index: 101;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .fixed-header {
                left: 0;
                padding: 0 1rem;
            }
            
            .main-content {
                margin-left: 0;
                padding: calc(var(--header-height) + 1rem) 1rem 1rem 1rem;
            }
            
            .menu-toggle {
                display: flex;
            }
            
            .chart-card {
                height: 300px;
            }
            
            .header-left-text h1 {
                font-size: 1.1rem;
            }
            
            .header-left-text p {
                font-size: 0.8rem;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .search-box {
                width: 100%;
            }
            
            .table-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .fixed-header {
                padding: 0 0.75rem;
            }
            
            .chart-card {
                height: 280px;
                padding: 1rem;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .header-right {
                gap: 0.5rem;
            }
            
            .desktop-admin-info {
                padding: 4px 8px;
            }
            
            .desktop-admin-info-text div:first-child {
                font-size: 0.85rem;
            }
            
            .desktop-admin-info-text div:last-child {
                font-size: 0.7rem;
            }
        }

        /* Mobile Styles (phones) */
        @media (max-width: 640px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .fixed-header {
                justify-content: space-between;
                padding: 0 0.5rem;
            }
            
            .header-left-text {
                display: none; /* Hide title on mobile */
            }
            
            .desktop-admin-info {
                display: none; /* Hide admin info from header on mobile */
            }
            
            .mobile-admin-info {
                display: block; /* Show mobile admin info in sidebar */
            }
            
            .mobile-theme-toggle {
                display: flex; /* Show theme toggle in sidebar on mobile */
            }
            
            .header-right .theme-toggle {
                display: none; /* Hide theme toggle from header on mobile */
            }
            
            .chart-card {
                height: 250px;
            }
            
            /* Optimize top users table for mobile */
            .top-users-table th,
            .top-users-table td {
                padding: 8px 6px;
                font-size: 0.8rem;
            }
            
            .top-users-table th:nth-child(3),
            .top-users-table td:nth-child(3) {
                text-align: right;
            }
        }

        @media (max-width: 480px) {
            .fixed-header {
                height: 60px; /* Smaller header on mobile */
                justify-content: space-between;
            }
            
            .main-content {
                padding: calc(60px + 1rem) 0.5rem 0.5rem 0.5rem;
            }
            
            .header-left-text h1 {
                font-size: 1rem;
            }
            
            .header-left-text p {
                font-size: 0.75rem;
            }
            
            .theme-toggle, .menu-toggle {
                width: 36px;
                height: 36px;
                padding: 6px;
                font-size: 1.25rem;
            }
            
            .desktop-admin-avatar {
                width: 32px;
                height: 32px;
                font-size: 0.9rem;
            }
            
            .chart-card {
                padding: 0.75rem;
                height: 220px;
            }
            
            .stat-card {
                padding: 1rem;
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
            
            .stat-icon {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
            
            /* Further optimize top users table */
            .top-users-table {
                min-width: 300px;
            }
            
            .top-users-table th,
            .top-users-table td {
                padding: 6px 4px;
                font-size: 0.75rem;
            }
        }

        /* Settings Page */
       
        .settings-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    align-items: start; /* Prevents cards from stretching to fill empty height */
}

        .setting-card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

       
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 2rem;
        }

        .page-btn {
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
        }

        .page-btn:hover:not(:disabled) {
            background: var(--bg-card);
        }

        .page-btn.active {
            background: #1A5237;
            color: white;
            border-color: #1A5237;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Alert */
        .alert {
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1A5237, #3B7A57);
        }

        .login-box {
            
            padding: 2.5rem;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
       
    backdrop-filter: blur(16px);
    background: rgba(255, 255, 255, 0.9);
    border: 1px solid rgba(255, 255, 255, 0.2);
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
}

        .login-title {
            text-align: center;
            margin-bottom: 2rem;
            color: #1A5237;
        }

        .login-input {
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .login-input:focus {
            outline: none;
            border-color: #1A5237;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #1A5237, #3B7A57);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 82, 55, 0.3);
        }

        .login-error {
            color: #dc2626;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            text-align: center;
        }

        /* Forgot Password */
        .forgot-password-link {
            text-align: center;
            margin-top: 1rem;
            color: #3b82f6;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .forgot-password-link:hover {
            text-decoration: underline;
        }

        .back-to-login {
            text-align: center;
            margin-top: 1rem;
            color: #64748b;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .back-to-login:hover {
            text-decoration: underline;
        }

        /* Field Disabled Info */
        .field-info {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            font-style: italic;
        }

        /* Overlay for mobile */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
            display: none;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1rem 1.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 9999;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            max-width: 300px;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast-success {
            border-left: 4px solid #10b981;
        }

        .toast-error {
            border-left: 4px solid #ef4444;
        }

        .toast-info {
            border-left: 4px solid #3b82f6;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .toast-message {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Save Settings Button */
        .save-settings-btn {
            background: linear-gradient(135deg, #1A5237, #3B7A57);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .save-settings-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 82, 55, 0.3);
        }

        .save-settings-btn i {
            font-size: 1rem;
        }

        /* Settings Changed Indicator */
        .settings-changed {
            border: 2px solid #3b82f6 !important;
        }

        .save-indicator {
            font-size: 0.8rem;
            color: #3b82f6;
            margin-top: 0.5rem;
            display: none;
        }

        /* Content Management Styles */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            background: #e2e8f0;
            color: var(--text-primary);
        }

        .grid-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

      /* Content Section Specific - FIXED */
.content-grid {
    display: grid;
    /* Changed 400px to 280px to fit on mobile screens */
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
}
        .content-card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }

        /* Marquee Country Badge */
        .country-badge {
            padding: 4px 10px;
            background: linear-gradient(135deg, #1A5237, #3B7A57);
            color: white;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8rem;
            margin-right: 8px;
        }

        /* Ad Service Status */
        .ad-active {
            opacity: 1;
        }

        .ad-inactive {
            opacity: 0.5;
        }

        .toggle-ad-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .toggle-ad-btn.active {
            color: #10b981;
        }

        .toggle-ad-btn.inactive {
            color: #9ca3af;
        }

        .ad-icon {
            background: #f3f4f6;
            padding: 10px;
            border-radius: 8px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Premium Color Swatches */
.color-swatches {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 12px;
    padding: 4px;
}

.color-swatch {
    width: 32px; 
    height: 32px; 
    border-radius: 50%; 
    cursor: pointer; 
    border: 2px solid white; 
    box-shadow: 0 0 0 2px #e2e8f0; /* Default ring */
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.color-swatch:hover { 
    transform: scale(1.15); 
    box-shadow: 0 0 0 2px #94a3b8; 
}

/* Custom "Rainbow" Picker Button */
.custom-color-btn {
    width: 32px; height: 32px; 
    border-radius: 50%; 
    background: conic-gradient(red, orange, yellow, green, blue, indigo, violet, red);
    border: 2px solid white;
    box-shadow: 0 0 0 2px #e2e8f0;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    position: relative;
    transition: transform 0.2s;
}
.custom-color-btn:active { transform: scale(0.95); }

/* Invisible Native Input sitting on top of the rainbow button */
.custom-color-btn input[type="color"] {
    position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; padding: 0;
}

/* SAFE FIX: Fixes the gap without breaking the navigation */


.settings-grid {
    align-items: start !important; /* This stops elements from dropping to the bottom */
}

.main-content {
    display: block; /* Removed the !important here too just to be safe */
}
    </style>
</head>
<body data-theme="light">
    
    <!-- Login Screen -->
    <div id="loginScreen" class="fixed inset-0 flex items-center justify-center bg-gradient-to-br from-slate-900 via-emerald-900 to-slate-900 z-[9999]">
        <div class="absolute top-0 left-0 w-72 h-72 bg-emerald-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob"></div>
        <div class="absolute top-0 right-0 w-72 h-72 bg-teal-500 rounded-full mix-blend-multiply filter blur-3xl opacity-20 animate-blob animation-delay-2000"></div>

        <div class="relative w-full max-w-md p-8 m-4 rounded-2xl backdrop-blur-xl bg-white/10 border border-white/20 shadow-2xl">
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 rounded-xl bg-gradient-to-tr from-emerald-500 to-teal-400 text-white font-bold text-2xl shadow-lg mb-4">
                    AV
                </div>
                <h2 class="text-2xl font-bold text-white tracking-tight">AdVault Admin</h2>
                <p class="text-emerald-100/70 text-sm mt-2">Sign in to manage your empire</p>
            </div>

            <div id="loginForm" class="space-y-4">
                <div>
                    <input type="email" id="adminEmail" class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 text-white placeholder-emerald-100/50 focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-all" placeholder="Admin Email Address">
                </div>
                <div>
                    <input type="password" id="adminPassword" class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 text-white placeholder-emerald-100/50 focus:outline-none focus:ring-2 focus:ring-emerald-500 transition-all" placeholder="Password">
                </div>
                <div id="loginError" class="text-red-400 text-sm text-center font-medium"></div>
                
                <button id="loginBtn" class="w-full py-3 px-4 bg-gradient-to-r from-emerald-500 to-teal-500 hover:from-emerald-400 hover:to-teal-400 text-white rounded-xl font-semibold shadow-lg shadow-emerald-500/30 transition-all transform hover:-translate-y-0.5">
                    Access Control Panel
                </button>
                
                <div class="text-center pt-4">
                    <span class="text-emerald-100/60 text-sm cursor-pointer hover:text-white transition-colors" id="showForgotPassword">Forgot Password?</span>
                </div>
            </div>

            <div id="forgotPasswordForm" style="display: none;" class="space-y-4">
                <h3 class="text-center text-white font-semibold text-lg">Reset Password</h3>
                <p class="text-emerald-100/70 text-sm text-center">Enter your email to receive a reset link.</p>
                
                <input type="email" id="resetEmail" class="w-full px-4 py-3 rounded-xl bg-white/5 border border-white/10 text-white placeholder-emerald-100/50 focus:outline-none focus:ring-2 focus:ring-emerald-500" placeholder="Enter Admin Email">
                
                <div id="recoveryError" class="text-red-400 text-sm text-center"></div>
                <div id="recoverySuccess" style="display: none;" class="text-emerald-400 text-sm text-center font-medium"></div>
                
                <button id="recoverBtn" class="w-full py-3 px-4 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-xl font-semibold shadow-lg shadow-emerald-500/30 transition-all hover:opacity-90">
                    Send Reset Link
                </button>
                <div class="text-center pt-2">
                    <span class="text-emerald-100/60 text-sm cursor-pointer hover:text-white transition-colors" id="backToLogin">‚Üê Back to Login</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" style="display: none;">
        <div class="spinner"></div>
        <p>Loading Admin Panel...</p>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer"></div>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Admin Panel (hidden until login) -->
    <div id="adminPanel" style="display: none;">
        <!-- Sidebar -->
     <style>
            /* 1. Base Sidebar Settings */
            #sidebar {
                width: 260px !important;
                background-color: var(--bg-secondary) !important;
            }
            
            /* 2. Desktop Layout (Locked in place) */
            @media (min-width: 1024px) {
                #sidebar {
                    transform: translateX(0) !important;
                    display: flex !important;
                }
                #fixedHeader {
                    left: 260px !important;
                    width: calc(100% - 260px) !important;
                }
                #mainContent {
                    margin-left: 260px !important;
                }
            }

            /* 3. Mobile Layout (Full width, hide sidebar) */
            @media (max-width: 1023px) {
                #sidebar {
                    transform: translateX(-100%) !important;
                }
                #sidebar.active {
                    transform: translateX(0) !important;
                }
                #fixedHeader {
                    left: 0 !important;
                    width: 100% !important;
                }
                #mainContent {
                    margin-left: 0 !important;
                }
            }
        </style>

        <nav class="sidebar fixed left-0 top-0 h-screen border-r border-[var(--border-color)] flex flex-col transition-transform duration-300 z-[110]" id="sidebar">
            
            <div class="logo flex items-center gap-3 px-6 py-6 border-b border-[var(--border-color)] mb-2">
                <div class="logo-icon w-10 h-10 rounded-xl bg-gradient-to-tr from-emerald-600 to-teal-400 flex items-center justify-center text-white font-bold text-xl shadow-md">
                    AV
                </div>
                <div>
                    <h2 class="font-bold text-lg text-[var(--text-primary)] tracking-tight leading-tight">AdVault Admin</h2>
                    <p class="text-xs text-emerald-500 font-medium">Control Panel</p>
                </div>
            </div>
            
            <ul class="nav-links flex-1 px-4 overflow-y-auto space-y-1 pb-4">
                
                <div class="text-[10px] font-bold text-[var(--text-secondary)] uppercase tracking-widest mb-2 mt-4 pl-3">Main Menu</div>
                
                <li class="nav-item active rounded-xl mb-1" data-section="dashboard">
                    <div class="nav-link-item flex items-center gap-3 px-4 py-2.5 text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--hover-bg)] transition-all cursor-pointer font-medium text-sm">
                        <i class="fas fa-tachometer-alt w-5 text-center"></i> <span>Dashboard</span>
                    </div>
                </li>
                <li class="nav-item rounded-xl mb-1" data-section="analytics">
                    <div class="nav-link-item flex items-center gap-3 px-4 py-2.5 text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--hover-bg)] transition-all cursor-pointer font-medium text-sm">
                        <i class="fas fa-chart-line w-5 text-center"></i> <span>Analytics</span>
                    </div>
                </li>
                
                <div class="text-[10px] font-bold text-[var(--text-secondary)] uppercase tracking-widest mb-2 mt-6 pl-3">Management</div>
                
                <li class="nav-item rounded-xl mb-1" data-section="users">
                    <div class="nav-link-item flex items-center gap-3 px-4 py-2.5 text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--hover-bg)] transition-all cursor-pointer font-medium text-sm">
                        <i class="fas fa-users w-5 text-center"></i> <span>Users</span>
                    </div>
                </li>
                <li class="nav-item rounded-xl mb-1" data-section="withdrawals">
                    <div class="nav-link-item flex items-center gap-3 px-4 py-2.5 text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--hover-bg)] transition-all cursor-pointer font-medium text-sm">
                        <i class="fas fa-money-check-alt w-5 text-center"></i> <span>Withdrawals</span>
                    </div>
                </li>
                <li class="nav-item rounded-xl mb-1" data-section="notifications">
                    <div class="nav-link-item flex items-center gap-3 px-4 py-2.5 text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--hover-bg)] transition-all cursor-pointer font-medium text-sm">
                        <i class="fas fa-bell w-5 text-center"></i> <span>Notifications</span>
                    </div>
                </li>

                <div class="text-[10px] font-bold text-[var(--text-secondary)] uppercase tracking-widest mb-2 mt-6 pl-3">Configuration</div>
                
                <li class="nav-item rounded-xl mb-1" data-section="content">
                    <div class="nav-link-item flex items-center gap-3 px-4 py-2.5 text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--hover-bg)] transition-all cursor-pointer font-medium text-sm">
                        <i class="fas fa-newspaper w-5 text-center"></i> <span>Content</span>
                    </div>
                </li>
                <li class="nav-item rounded-xl mb-1" data-section="ads">
                    <div class="nav-link-item flex items-center gap-3 px-4 py-2.5 text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--hover-bg)] transition-all cursor-pointer font-medium text-sm">
                        <i class="fas fa-ad w-5 text-center"></i> <span>Ads Manager</span>
                    </div>
                </li>
                <li class="nav-item rounded-xl mb-1" data-section="settings">
                    <div class="nav-link-item flex items-center gap-3 px-4 py-2.5 text-[var(--text-secondary)] hover:text-[var(--text-primary)] hover:bg-[var(--hover-bg)] transition-all cursor-pointer font-medium text-sm">
                        <i class="fas fa-cog w-5 text-center"></i> <span>Settings</span>
                    </div>
                </li>
                
                <div class="mobile-theme-toggle flex items-center justify-between px-4 py-3 mt-6 rounded-xl bg-[var(--bg-card)] border border-[var(--border-color)] text-[var(--text-primary)] font-medium text-sm cursor-pointer lg:hidden hover:bg-[var(--hover-bg)] transition-all" id="mobileThemeToggle">
                    <span>Dark Mode</span>
                    <i class="fas fa-moon text-[var(--text-secondary)]"></i>
                </div>
                
                <li class="nav-item rounded-xl mt-4 mb-2" data-section="logout">
                    <div class="nav-link-item flex items-center gap-3 px-4 py-2.5 text-red-500 hover:text-white hover:bg-red-500 transition-all cursor-pointer font-medium text-sm">
                        <i class="fas fa-sign-out-alt w-5 text-center"></i> <span>Logout</span>
                    </div>
                </li>
            </ul>
            
            <div class="mobile-admin-info lg:hidden p-4 mx-4 mb-4 bg-[var(--bg-card)] rounded-xl border border-[var(--border-color)] shadow-sm flex items-center gap-3">
                <div class="mobile-admin-avatar w-10 h-10 bg-gradient-to-tr from-emerald-600 to-teal-400 rounded-full flex items-center justify-center text-white font-bold shadow-sm" id="mobileAdminAvatar">A</div>
                <div>
                    <div class="font-bold text-sm text-[var(--text-primary)] leading-tight" id="mobileAdminDisplayName">Admin</div>
                    <div class="text-xs text-[var(--text-secondary)] font-medium mt-0.5">Super Admin</div>
                </div>
            </div>
            
            <div class="sidebar-footer p-4 border-t border-[var(--border-color)] bg-[var(--bg-card)]/30 backdrop-blur-sm">
                <div class="text-xs text-[var(--text-secondary)] text-center font-medium flex flex-col items-center gap-1.5">
                    <div class="flex items-center gap-3">
                        <span><i class="fas fa-code-branch mr-1"></i> v2.1.1</span>
                        <span class="w-1 h-1 rounded-full bg-[var(--border-color)]"></span>
                        <span><i class="fas fa-users mr-1"></i> <span id="userCount">0</span> users</span>
                    </div>
                    <div id="settingsStatus" class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-emerald-500/10 text-emerald-600 dark:text-emerald-400 rounded-full text-[10px] uppercase tracking-wider font-bold">
                        <div class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse"></div> System Active
                    </div>
                </div>
            </div>
        </nav>

        <!-- Fixed Header -->
       <header class="fixed-header fixed top-0 right-0 h-[72px] backdrop-blur-md bg-[var(--bg-secondary)]/90 border-b border-[var(--border-color)] w-full lg:w-[calc(100%-260px)] z-[99] transition-all duration-300" id="fixedHeader">
            <div class="header-content flex items-center justify-between w-full h-full px-4 lg:px-6">
                
                <div class="flex items-center gap-4">
                    <button class="menu-toggle lg:hidden flex items-center justify-center w-10 h-10 rounded-lg hover:bg-[var(--hover-bg)] text-[var(--text-secondary)] transition-colors" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="header-left-text hidden sm:block">
                        <h1 id="pageTitle" class="text-lg lg:text-xl font-bold text-[var(--text-primary)] tracking-tight">Dashboard</h1>
                        <p id="pageSubtitle" class="text-xs text-[var(--text-secondary)] font-medium uppercase tracking-wider mt-0.5">AdVault Overview</p>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <button class="theme-toggle flex items-center justify-center w-10 h-10 rounded-full bg-[var(--bg-card)] border border-[var(--border-color)] text-[var(--text-secondary)] hover:text-emerald-500 hover:border-emerald-500 transition-all shadow-sm" id="themeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                    
                    <div class="desktop-admin-info hidden sm:flex items-center gap-3 pl-3 border-l border-[var(--border-color)]">
                        <div class="desktop-admin-avatar w-9 h-9 rounded-full bg-gradient-to-tr from-emerald-600 to-teal-400 flex items-center justify-center text-white font-bold shadow-sm" id="desktopAdminAvatar">A</div>
                        <div class="desktop-admin-info-text flex flex-col justify-center">
                            <div id="desktopAdminDisplayName" class="text-sm font-semibold text-[var(--text-primary)] leading-none mb-1">Admin</div>
                            <div class="text-xs text-emerald-500 font-medium leading-none">Super Admin</div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
       <main class="main-content pt-[88px] pb-6 px-4 lg:px-8 lg:ml-[260px] min-h-screen transition-all duration-300 block" id="mainContent">
            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <!-- Dashboard Section -->
           <section id="dashboardSection" class="section active">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-[var(--bg-card)] rounded-2xl p-6 border border-[var(--border-color)] shadow-sm hover:shadow-md transition-all duration-300 transform hover:-translate-y-1">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-[var(--text-secondary)] text-sm font-medium mb-1">Total Users</p>
                                <h3 class="text-3xl font-bold text-[var(--text-primary)] tracking-tight" id="totalUsers">0</h3>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-blue-500/10 text-blue-500 flex items-center justify-center text-xl shadow-sm">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="text-sm font-medium" id="usersGrowth">+0 this week</div>
                    </div>
                    
                    <div class="bg-[var(--bg-card)] rounded-2xl p-6 border border-[var(--border-color)] shadow-sm hover:shadow-md transition-all duration-300 transform hover:-translate-y-1">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-[var(--text-secondary)] text-sm font-medium mb-1">Total Balance</p>
                                <h3 class="text-3xl font-bold text-[var(--text-primary)] tracking-tight" id="totalBalance">BDT 0</h3>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-emerald-500/10 text-emerald-500 flex items-center justify-center text-xl shadow-sm">
                                <i class="fas fa-wallet"></i>
                            </div>
                        </div>
                        <div class="text-sm font-medium" id="balanceGrowth">+0 BDT today</div>
                    </div>
                    
                    <div class="bg-[var(--bg-card)] rounded-2xl p-6 border border-[var(--border-color)] shadow-sm hover:shadow-md transition-all duration-300 transform hover:-translate-y-1">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-[var(--text-secondary)] text-sm font-medium mb-1">Total Earnings</p>
                                <h3 class="text-3xl font-bold text-[var(--text-primary)] tracking-tight" id="totalEarnings">BDT 0</h3>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-amber-500/10 text-amber-500 flex items-center justify-center text-xl shadow-sm">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                        </div>
                        <div class="text-sm font-medium" id="earningsGrowth">+0 BDT today</div>
                    </div>
                    
                    <div class="bg-[var(--bg-card)] rounded-2xl p-6 border border-[var(--border-color)] shadow-sm hover:shadow-md transition-all duration-300 transform hover:-translate-y-1">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-[var(--text-secondary)] text-sm font-medium mb-1">Withdrawals</p>
                                <h3 class="text-3xl font-bold text-[var(--text-primary)] tracking-tight" id="totalWithdrawals">BDT 0</h3>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-rose-500/10 text-rose-500 flex items-center justify-center text-xl shadow-sm">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                        </div>
                        <div class="text-sm font-medium" id="withdrawalsGrowth">0 pending</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-[var(--bg-card)] rounded-2xl p-6 border border-[var(--border-color)] shadow-sm flex flex-col h-[380px]">
                        <h3 class="text-lg font-bold text-[var(--text-primary)] mb-4 flex items-center gap-2"><i class="fas fa-chart-line text-emerald-500"></i> User Growth</h3>
                        <div class="relative flex-1 w-full">
                            <canvas id="userGrowthChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-[var(--bg-card)] rounded-2xl p-6 border border-[var(--border-color)] shadow-sm flex flex-col h-[380px]">
                        <h3 class="text-lg font-bold text-[var(--text-primary)] mb-4 flex items-center gap-2"><i class="fas fa-chart-bar text-teal-500"></i> Revenue Overview</h3>
                        <div class="relative flex-1 w-full">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="bg-[var(--bg-card)] rounded-2xl p-6 border border-[var(--border-color)] shadow-sm">
                    <h3 class="text-lg font-bold text-[var(--text-primary)] mb-4 flex items-center gap-2"><i class="fas fa-bolt text-amber-500"></i> Recent Activity</h3>
                    <div id="recentActivity" class="space-y-1">
                        <p class="text-[var(--text-secondary)] text-sm py-4 text-center">Loading recent activity...</p>
                    </div>
                </div>
            </section>

            <!-- Analytics Section -->
           <section id="analyticsSection" class="section" style="display: none;">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-[var(--bg-card)] rounded-2xl p-6 border border-[var(--border-color)] shadow-sm hover:shadow-md transition-all duration-300">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="text-[var(--text-secondary)] text-sm font-medium mb-1">Active Users</p>
                                <h3 class="text-3xl font-bold text-[var(--text-primary)] tracking-tight" id="activeUsers">0</h3>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-blue-500/10 text-blue-500 flex items-center justify-center text-xl shadow-sm">
                                <i class="fas fa-user-check"></i>
                            </div>
                        </div>
                        <div class="text-xs text-[var(--text-secondary)] font-medium">Last 24 hours</div>
                    </div>
                    
                    <div class="bg-[var(--bg-card)] rounded-2xl p-6 border border-[var(--border-color)] shadow-sm hover:shadow-md transition-all duration-300">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="text-[var(--text-secondary)] text-sm font-medium mb-1">Avg. Earnings</p>
                                <h3 class="text-3xl font-bold text-[var(--text-primary)] tracking-tight" id="avgEarnings">BDT 0</h3>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-amber-500/10 text-amber-500 flex items-center justify-center text-xl shadow-sm">
                                <i class="fas fa-hand-holding-usd"></i>
                            </div>
                        </div>
                        <div class="text-xs text-[var(--text-secondary)] font-medium">Per active user</div>
                    </div>
                    
                    <div class="bg-[var(--bg-card)] rounded-2xl p-6 border border-[var(--border-color)] shadow-sm hover:shadow-md transition-all duration-300">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="text-[var(--text-secondary)] text-sm font-medium mb-1">Ads Watched</p>
                                <h3 class="text-3xl font-bold text-[var(--text-primary)] tracking-tight" id="totalAdsWatched">0</h3>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-purple-500/10 text-purple-500 flex items-center justify-center text-xl shadow-sm">
                                <i class="fas fa-eye"></i>
                            </div>
                        </div>
                        <div class="text-xs text-[var(--text-secondary)] font-medium">Global total</div>
                    </div>
                    
                    <div class="bg-[var(--bg-card)] rounded-2xl p-6 border border-[var(--border-color)] shadow-sm hover:shadow-md transition-all duration-300">
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <p class="text-[var(--text-secondary)] text-sm font-medium mb-1">Completion Rate</p>
                                <h3 class="text-3xl font-bold text-[var(--text-primary)] tracking-tight" id="completionRate">0%</h3>
                            </div>
                            <div class="w-12 h-12 rounded-xl bg-emerald-500/10 text-emerald-500 flex items-center justify-center text-xl shadow-sm">
                                <i class="fas fa-percentage"></i>
                            </div>
                        </div>
                        <div class="text-xs text-[var(--text-secondary)] font-medium">Task success rate</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                    <div class="bg-[var(--bg-card)] rounded-2xl p-6 border border-[var(--border-color)] shadow-sm flex flex-col h-[380px]">
                        <h3 class="text-lg font-bold text-[var(--text-primary)] mb-4 flex items-center gap-2"><i class="fas fa-chart-pie text-purple-500"></i> User Distribution</h3>
                        <div class="relative flex-1 w-full">
                            <canvas id="sourceChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-[var(--bg-card)] rounded-2xl p-6 border border-[var(--border-color)] shadow-sm flex flex-col h-[380px]">
                        <h3 class="text-lg font-bold text-[var(--text-primary)] mb-4 flex items-center gap-2"><i class="fas fa-wave-square text-amber-500"></i> Daily Activity Trend</h3>
                        <div class="relative flex-1 w-full">
                            <canvas id="activityChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="bg-[var(--bg-card)] rounded-2xl p-6 border border-[var(--border-color)] shadow-sm">
                    <h3 class="text-lg font-bold text-[var(--text-primary)] mb-4 flex items-center gap-2"><i class="fas fa-trophy text-yellow-500"></i> Top Performing Users</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead>
                                <tr class="border-b border-[var(--border-color)] text-[var(--text-secondary)] text-xs uppercase tracking-wider">
                                    <th class="py-3 px-4 font-semibold">User</th>
                                    <th class="py-3 px-4 font-semibold">Earnings</th>
                                    <th class="py-3 px-4 font-semibold text-right">Ads</th>
                                </tr>
                            </thead>
                            <tbody id="topUsersBody" class="divide-y divide-[var(--border-color)]">
                                <tr><td colspan="3" class="text-center py-8 text-[var(--text-secondary)]">Loading top users...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Users Section -->
           <section id="usersSection" class="section" style="display: none;">
                <div class="bg-[var(--bg-card)] rounded-2xl border border-[var(--border-color)] shadow-sm overflow-hidden flex flex-col">
                    <div class="p-6 border-b border-[var(--border-color)] flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 bg-[var(--bg-secondary)]/50">
                        <h2 class="text-xl font-bold text-[var(--text-primary)] flex items-center gap-2">
                            <i class="fas fa-users text-blue-500"></i> User Management
                        </h2>
                        <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                            <div class="relative w-full sm:w-72">
                                <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-[var(--text-secondary)]"></i>
                                <input type="text" id="userSearch" placeholder="Search by name or ID..." class="w-full pl-11 pr-4 py-2.5 bg-[var(--bg-primary)] border border-[var(--border-color)] rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 text-[var(--text-primary)] transition-all text-sm">
                            </div>
                            <button onclick="exportUsersData()" class="px-5 py-2.5 bg-gradient-to-r from-slate-700 to-slate-800 hover:from-slate-600 hover:to-slate-700 text-white rounded-xl font-medium shadow-md transition-all flex items-center justify-center gap-2 whitespace-nowrap text-sm">
                                <i class="fas fa-file-export"></i> Export CSV
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto w-full">
                        <table id="usersTable" class="w-full text-left border-collapse">
                            <thead class="bg-[var(--bg-secondary)]">
                                <tr class="text-[var(--text-secondary)] text-[11px] uppercase tracking-wider border-b border-[var(--border-color)]">
                                    <th class="p-4 font-semibold">ID</th>
                                    <th class="p-4 font-semibold">User</th>
                                    <th class="p-4 font-semibold">Telegram ID</th>
                                    <th class="p-4 font-semibold">Balance</th>
                                    <th class="p-4 font-semibold">Earnings</th>
                                    <th class="p-4 font-semibold">Ads</th>
                                    <th class="p-4 font-semibold text-center">Country</th>
                                    <th class="p-4 font-semibold">Source</th>
                                    <th class="p-4 font-semibold text-center">Status</th>
                                    <th class="p-4 font-semibold">Last Active</th>
                                    <th class="p-4 font-semibold text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody" class="divide-y divide-[var(--border-color)] [&>tr]:transition-colors hover:[&>tr]:bg-[var(--hover-bg)] [&>tr>td]:p-4 [&>tr>td]:text-sm [&>tr>td]:text-[var(--text-primary)] [&>tr>td:last-child]:text-right [&>tr>td:nth-child(9)]:text-center">
                                <tr><td colspan="11" class="text-center py-10 text-[var(--text-secondary)]"><i class="fas fa-spinner fa-spin mr-2"></i> Loading users...</td></tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="p-4 border-t border-[var(--border-color)] flex justify-between items-center bg-[var(--bg-secondary)]/50" id="pagination">
                        <button class="px-5 py-2 bg-[var(--bg-card)] border border-[var(--border-color)] rounded-xl text-sm font-medium text-[var(--text-primary)] hover:bg-[var(--hover-bg)] disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-sm" id="prevPage" disabled>Previous</button>
                        <span id="pageInfo" class="text-sm font-semibold text-[var(--text-secondary)] px-4 py-1.5 bg-[var(--bg-primary)] rounded-lg border border-[var(--border-color)]">Page 1 of 1</span>
                        <button class="px-5 py-2 bg-[var(--bg-card)] border border-[var(--border-color)] rounded-xl text-sm font-medium text-[var(--text-primary)] hover:bg-[var(--hover-bg)] disabled:opacity-50 disabled:cursor-not-allowed transition-all shadow-sm" id="nextPage" disabled>Next</button>
                    </div>
                </div>
            </section>

            <section id="withdrawalsSection" class="section" style="display: none;">
                <div class="bg-[var(--bg-card)] rounded-2xl border border-[var(--border-color)] shadow-sm overflow-hidden flex flex-col">
                    <div class="p-6 border-b border-[var(--border-color)] flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 bg-[var(--bg-secondary)]/50">
                        <h2 class="text-xl font-bold text-[var(--text-primary)] flex items-center gap-2">
                            <i class="fas fa-money-check-alt text-rose-500"></i> Payout Requests
                        </h2>
                        <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto">
                            <select id="withdrawalFilter" class="w-full sm:w-48 px-4 py-2.5 bg-[var(--bg-primary)] border border-[var(--border-color)] rounded-xl focus:outline-none focus:ring-2 focus:ring-emerald-500 text-[var(--text-primary)] text-sm font-medium appearance-none">
                                <option value="all">All Statuses</option>
                                <option value="pending">Pending</option>
                                <option value="completed">Completed</option>
                                <option value="rejected">Rejected</option>
                            </select>
                            <button onclick="refreshWithdrawals()" class="px-5 py-2.5 bg-gradient-to-r from-emerald-600 to-teal-500 hover:from-emerald-500 hover:to-teal-400 text-white rounded-xl font-medium shadow-md transition-all flex items-center justify-center gap-2 whitespace-nowrap text-sm">
                                <i class="fas fa-sync-alt"></i> Refresh Data
                            </button>
                        </div>
                    </div>
                    
                    <div class="overflow-x-auto w-full">
                        <table id="withdrawalsTable" class="w-full text-left border-collapse">
                            <thead class="bg-[var(--bg-secondary)]">
                                <tr class="text-[var(--text-secondary)] text-[11px] uppercase tracking-wider border-b border-[var(--border-color)]">
                                    <th class="p-4 font-semibold">Req ID</th>
                                    <th class="p-4 font-semibold">User</th>
                                    <th class="p-4 font-semibold">Amount</th>
                                    <th class="p-4 font-semibold">Method</th>
                                    <th class="p-4 font-semibold">Address / Number</th>
                                    <th class="p-4 font-semibold">Date</th>
                                    <th class="p-4 font-semibold text-center">Status</th>
                                    <th class="p-4 font-semibold text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="withdrawalsTableBody" class="divide-y divide-[var(--border-color)] [&>tr]:transition-colors hover:[&>tr]:bg-[var(--hover-bg)] [&>tr>td]:p-4 [&>tr>td]:text-sm [&>tr>td]:text-[var(--text-primary)] [&>tr>td:nth-child(7)]:text-center [&>tr>td:last-child]:text-right">
                                <tr><td colspan="8" class="text-center py-10 text-[var(--text-secondary)]"><i class="fas fa-spinner fa-spin mr-2"></i> Loading requests...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
<section id="notificationsSection" class="section" style="display: none;">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    
                    <div class="bg-[var(--bg-card)] rounded-2xl p-6 border border-[var(--border-color)] shadow-sm">
                        <h3 class="text-lg font-bold text-[var(--text-primary)] mb-6 flex items-center gap-2">
                            <i class="fas fa-paper-plane text-emerald-500"></i> Send Notification
                        </h3>
                        
                        <div class="space-y-4">
                            <div class="space-y-1.5">
                                <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Title</label>
                                <input type="text" id="notifTitle" class="w-full px-4 py-2.5 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none transition-all" placeholder="e.g. Weekend Bonus!">
                            </div>
                            
                            <div class="space-y-1.5">
                                <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Message</label>
                                <textarea id="notifMessage" rows="4" class="w-full px-4 py-3 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none transition-all resize-none" placeholder="Type your message here..."></textarea>
                            </div>

                            <div class="bg-[var(--bg-primary)] p-4 rounded-xl border border-[var(--border-color)]">
                                <label class="block text-xs font-semibold text-[var(--text-secondary)] uppercase mb-3">Delivery Method</label>
                                <div class="flex flex-col sm:flex-row gap-5">
                                    <label class="flex items-center gap-3 cursor-pointer group">
                                        <div class="relative flex items-center justify-center w-5 h-5">
                                            <input type="checkbox" id="sendToApp" checked class="peer appearance-none w-5 h-5 border-2 border-[var(--border-color)] rounded bg-[var(--bg-card)] checked:bg-emerald-500 checked:border-emerald-500 transition-all cursor-pointer">
                                            <i class="fas fa-check absolute text-white text-[10px] opacity-0 peer-checked:opacity-100 pointer-events-none"></i>
                                        </div>
                                        <span class="text-sm font-medium text-[var(--text-primary)] group-hover:text-emerald-500 transition-colors">üì± In-App Popup</span>
                                    </label>

                                    <label class="flex items-center gap-3 cursor-pointer group">
                                        <div class="relative flex items-center justify-center w-5 h-5">
                                            <input type="checkbox" id="sendToTelegram" class="peer appearance-none w-5 h-5 border-2 border-[var(--border-color)] rounded bg-[var(--bg-card)] checked:bg-blue-500 checked:border-blue-500 transition-all cursor-pointer">
                                            <i class="fas fa-check absolute text-white text-[10px] opacity-0 peer-checked:opacity-100 pointer-events-none"></i>
                                        </div>
                                        <span class="text-sm font-medium text-[var(--text-primary)] group-hover:text-blue-500 transition-colors">‚úàÔ∏è Telegram DM</span>
                                    </label>
                                </div>
                            </div>
                            
                            <button onclick="sendNotification()" class="w-full py-3 px-4 mt-2 bg-gradient-to-r from-emerald-600 to-teal-500 hover:from-emerald-500 hover:to-teal-400 text-white rounded-xl font-bold shadow-lg shadow-emerald-500/20 transition-all transform hover:-translate-y-0.5">
                                <i class="fas fa-paper-plane mr-2"></i> Send Broadcast
                            </button>
                        </div>
                    </div>

                    <div class="bg-[var(--bg-card)] rounded-2xl p-6 border border-[var(--border-color)] shadow-sm flex flex-col h-full lg:max-h-[500px]">
                        <h3 class="text-lg font-bold text-[var(--text-primary)] mb-4 flex items-center gap-2">
                            <i class="fas fa-history text-blue-500"></i> Recent Broadcasts
                        </h3>
                        <div class="overflow-y-auto flex-1 pr-2">
                            <table class="w-full text-left border-collapse">
                                <thead class="bg-[var(--bg-primary)] sticky top-0 z-10">
                                    <tr class="text-[var(--text-secondary)] text-[11px] uppercase tracking-wider border-y border-[var(--border-color)]">
                                        <th class="py-3 px-4 font-semibold">Date</th>
                                        <th class="py-3 px-4 font-semibold">Title</th>
                                        <th class="py-3 px-4 font-semibold text-right">Action</th>
                                    </tr>
                                </thead>
                                <tbody id="notificationHistoryBody" class="divide-y divide-[var(--border-color)] [&>tr]:transition-colors hover:[&>tr]:bg-[var(--hover-bg)] [&>tr>td]:p-4 [&>tr>td]:text-sm [&>tr>td]:text-[var(--text-primary)] [&>tr>td:last-child]:text-right">
                                    <tr><td colspan="3" class="text-center py-8 text-[var(--text-secondary)]">Loading history...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                </div>
            </section>
            <!-- Content & Ads Section -->
           <section id="contentSection" class="section" style="display: none;">
               <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    
                    <div class="bg-[var(--bg-card)] rounded-2xl p-6 border border-[var(--border-color)] shadow-sm flex flex-col">
                        <h3 class="text-lg font-bold text-[var(--text-primary)] mb-6 flex items-center gap-2">
                            <i class="fas fa-bullhorn text-amber-500"></i> Flash Text (Marquee)
                        </h3>
                        
                        <div class="space-y-4 flex-1">
                            <div class="space-y-1.5">
                                <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Country Code (e.g. BD, US)</label>
                                <input type="text" id="mqCountry" class="w-full px-4 py-2.5 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none uppercase" placeholder="BD" maxlength="2">
                            </div>
                            <div class="space-y-1.5">
                                <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Marquee Message</label>
                                <input type="text" id="mqText" class="w-full px-4 py-2.5 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="Enter marquee text...">
                            </div>
                            
                            <button onclick="addMarquee()" class="w-full py-2.5 bg-gradient-to-r from-emerald-600 to-teal-500 text-white rounded-xl font-bold shadow-md hover:-translate-y-0.5 transition-all mt-2">
                                <i class="fas fa-plus mr-2"></i> Add/Update Marquee
                            </button>

                            <div class="mt-6 bg-[var(--bg-primary)] border border-[var(--border-color)] rounded-xl p-4 flex-1">
                                <h4 class="text-xs font-bold text-[var(--text-secondary)] uppercase mb-3">Active Marquees</h4>
                                <div id="marqueeList" class="space-y-2 [&>div]:flex [&>div]:justify-between [&>div]:items-center [&>div]:bg-[var(--bg-card)] [&>div]:p-3 [&>div]:rounded-lg [&>div]:border [&>div]:border-[var(--border-color)] [&>div]:text-sm">
                                    <p class="text-center text-[var(--text-secondary)] text-sm py-2">No marquees added yet</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-[var(--bg-card)] rounded-2xl p-6 border border-[var(--border-color)] shadow-sm flex flex-col">
                        <h3 class="text-lg font-bold text-[var(--text-primary)] mb-6 flex items-center gap-2">
                            <i class="fas fa-credit-card text-blue-500"></i> Payment Methods
                        </h3>
                        
                        <div class="space-y-4 flex-1">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-1.5">
                                    <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Method Name</label>
                                    <input type="text" id="pmName" class="w-full px-4 py-2.5 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none" placeholder="e.g. bKash">
                                </div>
                                <div class="space-y-1.5">
                                    <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Input Type</label>
                                    <select id="pmType" onchange="updatePmIcon()" class="w-full px-4 py-2.5 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none appearance-none">
                                        <option value="number">Phone Number</option>
                                        <option value="email">Email Address</option>
                                        <option value="text">Text Input</option>
                                    </select>
                                </div>
                            </div>
                            
                            <input type="hidden" id="pmIcon" value="fas fa-mobile-alt">

                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-1.5">
                                    <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Brand Color</label>
                                    <div class="flex items-center gap-2">
                                        <div id="colorPreview" class="w-10 h-10 rounded-lg shadow-sm border border-[var(--border-color)] shrink-0 transition-colors" style="background: #E2136E;"></div>
                                        <input type="text" id="pmColor" class="w-full px-3 py-2.5 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none text-sm" value="#E2136E" oninput="setPmColor(this.value)">
                                    </div>
                                </div>
                                <div class="space-y-1.5">
                                    <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Min Withdraw</label>
                                    <input type="number" id="pmMin" class="w-full px-4 py-2.5 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none" value="100">
                                </div>
                            </div>

                            <div class="flex flex-wrap gap-2 pt-1">
                                <div class="w-7 h-7 rounded-full cursor-pointer hover:scale-110 transition-transform shadow-sm" style="background: #E2136E;" onclick="setPmColor('#E2136E')" title="bKash"></div>
                                <div class="w-7 h-7 rounded-full cursor-pointer hover:scale-110 transition-transform shadow-sm" style="background: #F7921E;" onclick="setPmColor('#F7921E')" title="Nagad"></div>
                                <div class="w-7 h-7 rounded-full cursor-pointer hover:scale-110 transition-transform shadow-sm" style="background: #8C3494;" onclick="setPmColor('#8C3494')" title="Rocket"></div>
                                <div class="w-7 h-7 rounded-full cursor-pointer hover:scale-110 transition-transform shadow-sm" style="background: #003087;" onclick="setPmColor('#003087')" title="Bank/Upay"></div>
                                <div class="w-7 h-7 rounded-full cursor-pointer hover:scale-110 transition-transform shadow-sm" style="background: #25D366;" onclick="setPmColor('#25D366')" title="Green"></div>
                                <div class="w-7 h-7 rounded-full cursor-pointer hover:scale-110 transition-transform shadow-sm" style="background: #0F172A;" onclick="setPmColor('#0F172A')" title="Dark"></div>
                                <div class="w-7 h-7 rounded-full flex items-center justify-center cursor-pointer hover:scale-110 transition-transform shadow-sm relative overflow-hidden" style="background: conic-gradient(red, orange, yellow, green, blue, indigo, violet, red);" title="Custom">
                                    <input type="color" oninput="setPmColor(this.value)" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full p-0">
                                </div>
                            </div>

                            <button onclick="addPaymentMethod()" class="w-full py-2.5 bg-gradient-to-r from-emerald-600 to-teal-500 text-white rounded-xl font-bold shadow-md hover:-translate-y-0.5 transition-all mt-2">
                                <i class="fas fa-plus mr-2"></i> Add Payment Method
                            </button>

                            <div class="mt-4 bg-[var(--bg-primary)] border border-[var(--border-color)] rounded-xl p-4 flex-1">
                                <h4 class="text-xs font-bold text-[var(--text-secondary)] uppercase mb-3">Available Methods</h4>
                                <div id="paymentMethodList" class="space-y-2 [&>div]:flex [&>div]:justify-between [&>div]:items-center [&>div]:bg-[var(--bg-card)] [&>div]:p-3 [&>div]:rounded-lg [&>div]:border [&>div]:border-[var(--border-color)] [&>div]:text-sm">
                                    <p class="text-center text-[var(--text-secondary)] text-sm py-2">No methods added yet</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

<section id="adsSection" class="section" style="display: none;">
                
                <div class="flex flex-col sm:flex-row gap-2 mb-6 bg-[var(--bg-card)] p-2 rounded-2xl border border-[var(--border-color)] shadow-sm">
                    <button onclick="switchAdTab('tab-pop-social')" id="btn-tab-pop-social" class="ad-tab-btn flex-1 py-2.5 px-4 rounded-xl font-bold text-sm transition-all bg-gradient-to-r from-purple-600 to-pink-500 text-white shadow-md">
                        <i class="fas fa-layer-group mr-2"></i> Popunder & Social
                    </button>
                    <button onclick="switchAdTab('tab-smartlink')" id="btn-tab-smartlink" class="ad-tab-btn flex-1 py-2.5 px-4 rounded-xl font-bold text-sm transition-all bg-transparent text-[var(--text-secondary)] hover:bg-[var(--bg-secondary)]">
                        <i class="fas fa-link mr-2"></i> Smart Links
                    </button>
                    <button onclick="switchAdTab('tab-banners')" id="btn-tab-banners" class="ad-tab-btn flex-1 py-2.5 px-4 rounded-xl font-bold text-sm transition-all bg-transparent text-[var(--text-secondary)] hover:bg-[var(--bg-secondary)]">
                        <i class="fas fa-images mr-2"></i> Banners
                    </button>
                </div>

                <div id="tab-pop-social" class="ad-tab-content grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-[var(--bg-card)] rounded-2xl p-6 shadow-sm border-l-4 border-purple-500 flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-[var(--text-primary)] flex items-center gap-2">
                                <i class="fas fa-window-restore text-purple-500"></i> Popunder Ads
                            </h3>
                            <button id="popunderToggleBtn" onclick="togglePopunder()" class="w-10 h-10 rounded-full flex items-center justify-center transition-all shadow-sm">
                                <i class="fas fa-power-off"></i>
                            </button>
                        </div>
                        <p class="text-[var(--text-secondary)] text-sm mb-4">Runs automatically in the background when users click.</p>
                        <textarea id="popunderScript" rows="4" class="w-full px-4 py-3 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-purple-500 outline-none transition-all font-mono text-xs resize-none" placeholder="<script>...popunder code...</script>"></textarea>
                        <button onclick="savePopunder()" class="w-full py-2.5 mt-4 bg-gradient-to-r from-purple-600 to-fuchsia-500 text-white rounded-xl font-bold shadow-md hover:-translate-y-0.5 transition-all">
                            <i class="fas fa-save mr-2"></i> Save Popunder
                        </button>
                    </div>

                    <div class="bg-[var(--bg-card)] rounded-2xl p-6 shadow-sm border-l-4 border-pink-500 flex flex-col">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-[var(--text-primary)] flex items-center gap-2">
                                <i class="fas fa-comment-alt text-pink-500"></i> Social Bar
                            </h3>
                            <button id="socialBarToggleBtn" onclick="toggleSocialBar()" class="w-10 h-10 rounded-full flex items-center justify-center transition-all shadow-sm">
                                <i class="fas fa-power-off"></i>
                            </button>
                        </div>
                        <p class="text-[var(--text-secondary)] text-sm mb-4">Floats over the app content for high visibility.</p>
                        <textarea id="socialBarScript" rows="4" class="w-full px-4 py-3 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-pink-500 outline-none transition-all font-mono text-xs resize-none" placeholder="<script>...social bar code...</script>"></textarea>
                        <button onclick="saveSocialBar()" class="w-full py-2.5 mt-4 bg-gradient-to-r from-pink-600 to-rose-500 text-white rounded-xl font-bold shadow-md hover:-translate-y-0.5 transition-all">
                            <i class="fas fa-save mr-2"></i> Save Social Bar
                        </button>
                    </div>
                </div>

                <div id="tab-smartlink" class="ad-tab-content grid grid-cols-1 gap-6" style="display: none;">
                    <div class="bg-[var(--bg-card)] rounded-2xl p-6 shadow-sm border-l-4 border-amber-500 flex flex-col">
                        <h3 class="text-lg font-bold text-[var(--text-primary)] mb-4 flex items-center gap-2">
                            <i class="fas fa-link text-amber-500"></i> Smartlink Tasks
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div class="space-y-1">
                                <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Task Title</label>
                                <input type="text" id="adName" class="w-full px-4 py-2.5 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-amber-500 outline-none text-sm" placeholder="e.g. Watch Ad 1">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Reward (BDT)</label>
                                <input type="number" id="adReward" class="w-full px-4 py-2.5 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-amber-500 outline-none text-sm" step="0.01" placeholder="0.50">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                            <div class="space-y-1 md:col-span-1">
                                <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Wait (Sec)</label>
                                <input type="number" id="adDurationInput" class="w-full px-4 py-2.5 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-amber-500 outline-none text-sm" placeholder="30">
                            </div>
                            <div class="space-y-1 md:col-span-2">
                                <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Smartlink URL</label>
                                <input type="text" id="adCode" class="w-full px-4 py-2.5 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-amber-500 outline-none font-mono text-sm" placeholder="https://...">
                            </div>
                        </div>

                        <button onclick="addSmartLink()" class="w-full py-2.5 bg-gradient-to-r from-amber-500 to-orange-400 text-white rounded-xl font-bold shadow-md hover:-translate-y-0.5 transition-all md:w-auto md:px-8">
                            <i class="fas fa-plus-circle mr-2"></i> Add Task
                        </button>

                        <div class="mt-6 flex-1">
                            <h4 class="text-xs font-bold text-[var(--text-secondary)] uppercase mb-3">Active Tasks</h4>
                            <div id="smartLinkList" class="space-y-2"></div>
                        </div>
                    </div>
                </div>

                <div id="tab-banners" class="ad-tab-content grid grid-cols-1 lg:grid-cols-3 gap-6" style="display: none;">
                    <div class="bg-[var(--bg-card)] rounded-2xl p-6 shadow-sm border-l-4 border-blue-500 flex flex-col lg:col-span-1">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold text-[var(--text-primary)] flex items-center gap-2">
                                <i class="fas fa-th-large text-blue-500"></i> Native Banner
                            </h3>
                            <button id="nativeToggle" onclick="toggleAdGroup('native')" class="px-3 py-1 text-xs font-bold rounded-full bg-blue-100 text-blue-700 shadow-sm transition-all">ON</button>
                        </div>
                        <p class="text-[var(--text-secondary)] text-sm mb-4">Displayed cleanly inside the Profile section.</p>
                        <textarea id="script_native" rows="4" class="w-full px-4 py-3 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-blue-500 outline-none transition-all font-mono text-xs resize-none" placeholder="Paste Native Banner Code..."></textarea>
                        <button onclick="saveNativeAd()" class="w-full py-2.5 mt-4 bg-gradient-to-r from-blue-600 to-cyan-500 text-white rounded-xl font-bold shadow-md hover:-translate-y-0.5 transition-all">
                            <i class="fas fa-save mr-2"></i> Save Native Script
                        </button>
                    </div>

                    <div class="bg-[var(--bg-card)] rounded-2xl p-6 shadow-sm border-l-4 border-emerald-500 lg:col-span-2 flex flex-col">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-[var(--text-primary)] flex items-center gap-2">
                                <i class="fas fa-image text-emerald-500"></i> Section Banners (320x50)
                            </h3>
                            <button id="bannerMasterToggle" onclick="toggleAdGroup('banners')" class="px-4 py-1.5 text-xs font-bold rounded-full bg-emerald-100 text-emerald-700 shadow-sm transition-all">ON</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-[var(--text-secondary)] uppercase"><i class="fas fa-home text-[var(--border-color)] mr-1"></i> Home</label>
                                <textarea id="script_home" rows="3" class="w-full px-3 py-2 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none font-mono text-xs resize-none" placeholder="Paste JS..."></textarea>
                            </div>
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-[var(--text-secondary)] uppercase"><i class="fas fa-coins text-[var(--border-color)] mr-1"></i> Earn</label>
                                <textarea id="script_earn" rows="3" class="w-full px-3 py-2 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none font-mono text-xs resize-none" placeholder="Paste JS..."></textarea>
                            </div>
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-[var(--text-secondary)] uppercase"><i class="fas fa-gamepad text-[var(--border-color)] mr-1"></i> Game</label>
                                <textarea id="script_game" rows="3" class="w-full px-3 py-2 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none font-mono text-xs resize-none" placeholder="Paste JS..."></textarea>
                            </div>
                            <div class="space-y-2">
                                <label class="text-xs font-bold text-[var(--text-secondary)] uppercase"><i class="fas fa-user text-[var(--border-color)] mr-1"></i> Profile</label>
                                <textarea id="script_profile" rows="3" class="w-full px-3 py-2 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none font-mono text-xs resize-none" placeholder="Paste JS..."></textarea>
                            </div>
                        </div>
                        
                        <button onclick="saveBannerGroup()" class="w-full md:w-auto py-2.5 px-8 mt-auto bg-gradient-to-r from-emerald-600 to-teal-500 text-white rounded-xl font-bold shadow-md hover:-translate-y-0.5 transition-all">
                            <i class="fas fa-save mr-2"></i> Save All Banners
                        </button>
                    </div>
                </div>

                <script>
                    function switchAdTab(tabId) {
                        // Hide all content areas
                        document.querySelectorAll('.ad-tab-content').forEach(el => {
                            el.style.display = 'none';
                        });

                        // Reset all buttons to inactive state
                        document.querySelectorAll('.ad-tab-btn').forEach(btn => {
                            btn.className = 'ad-tab-btn flex-1 py-2.5 px-4 rounded-xl font-bold text-sm transition-all bg-transparent text-[var(--text-secondary)] hover:bg-[var(--bg-secondary)]';
                        });

                        // Show selected content
                        document.getElementById(tabId).style.display = 'grid';

                        // Apply gradient styling to the active button
                        const activeBtn = document.getElementById('btn-' + tabId);
                        if (tabId === 'tab-pop-social') {
                            activeBtn.className = 'ad-tab-btn flex-1 py-2.5 px-4 rounded-xl font-bold text-sm transition-all bg-gradient-to-r from-purple-600 to-pink-500 text-white shadow-md';
                        } else if (tabId === 'tab-smartlink') {
                            activeBtn.className = 'ad-tab-btn flex-1 py-2.5 px-4 rounded-xl font-bold text-sm transition-all bg-gradient-to-r from-amber-500 to-orange-400 text-white shadow-md';
                        } else if (tabId === 'tab-banners') {
                            activeBtn.className = 'ad-tab-btn flex-1 py-2.5 px-4 rounded-xl font-bold text-sm transition-all bg-gradient-to-r from-blue-600 to-emerald-500 text-white shadow-md';
                        }
                    }
                </script>
            </section>

            <!-- Settings Section -->
         <section id="settingsSection" class="section" style="display: none;">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    
                    <div class="bg-[var(--bg-card)] rounded-2xl p-6 shadow-sm border border-[var(--border-color)]">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-[var(--text-primary)] flex items-center gap-2">
                                <i class="fas fa-sliders-h text-blue-500"></i> General Settings
                            </h3>
                            <span id="generalSaveIndicator" class="text-xs font-bold text-emerald-500 hidden"><i class="fas fa-check-circle mr-1"></i>Saved</span>
                        </div>
                        
                        <div class="space-y-6">
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="text-sm font-semibold text-[var(--text-primary)]">Maintenance Mode</h4>
                                    <p class="text-xs text-[var(--text-secondary)]">Temporarily disable the app for all users</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="maintenanceMode" data-setting="maintenanceMode" class="sr-only peer">
                                    <div class="w-11 h-6 bg-[var(--bg-primary)] border border-[var(--border-color)] rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-[var(--text-secondary)] peer-checked:after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500 peer-checked:border-emerald-500"></div>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="text-sm font-semibold text-[var(--text-primary)]">Auto Approve Withdrawals</h4>
                                    <p class="text-xs text-[var(--text-secondary)]">Process payouts without admin verification</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="autoApprove" data-setting="autoApprove" class="sr-only peer">
                                    <div class="w-11 h-6 bg-[var(--bg-primary)] border border-[var(--border-color)] rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-[var(--text-secondary)] peer-checked:after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500 peer-checked:border-emerald-500"></div>
                                </label>
                            </div>
                            
                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="text-sm font-semibold text-[var(--text-primary)]">Enable Ads Penalty</h4>
                                    <p class="text-xs text-[var(--text-secondary)]">Penalize users for closing ads early</p>
                                </div>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="enablePenalty" data-setting="enablePenalty" class="sr-only peer">
                                    <div class="w-11 h-6 bg-[var(--bg-primary)] border border-[var(--border-color)] rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-[var(--text-secondary)] peer-checked:after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-emerald-500 peer-checked:border-emerald-500"></div>
                                </label>
                            </div>

                            <hr class="border-[var(--border-color)]">

                            <div class="flex items-center justify-between">
                                <div>
                                    <h4 class="text-sm font-semibold text-[var(--text-primary)]">Min Withdrawal (BDT)</h4>
                                </div>
                                <input type="number" id="minWithdrawal" data-setting="minWithdrawal" class="w-24 px-3 py-1.5 text-center rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none font-bold">
                            </div>

                            <button onclick="saveSettings('general')" class="w-full py-2.5 mt-2 bg-gradient-to-r from-emerald-600 to-teal-500 text-white rounded-xl font-bold shadow-md hover:-translate-y-0.5 transition-all">
                                <i class="fas fa-save mr-2"></i> Save General
                            </button>
                        </div>
                    </div>

                    <div class="bg-[var(--bg-card)] rounded-2xl p-6 shadow-sm border border-[var(--border-color)]">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-[var(--text-primary)] flex items-center gap-2">
                                <i class="fas fa-play-circle text-purple-500"></i> Ad Settings
                            </h3>
                            <span id="adSaveIndicator" class="text-xs font-bold text-emerald-500 hidden"><i class="fas fa-check-circle mr-1"></i>Saved</span>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-6">
                            <div class="space-y-1">
                                <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Earnings Per Ad</label>
                                <input type="number" step="0.01" id="earningsPerAd" data-setting="earningsPerAd" class="w-full px-4 py-2 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Daily Task Limit</label>
                                <input type="number" id="dailyTasks" data-setting="dailyTasks" class="w-full px-4 py-2 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Duration (Sec)</label>
                                <input type="number" id="adDuration" data-setting="adDuration" class="w-full px-4 py-2 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none">
                            </div>
                            <div class="space-y-1">
                                <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Penalty (Min)</label>
                                <input type="number" id="penaltyDuration" data-setting="penaltyDuration" class="w-full px-4 py-2 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none">
                            </div>
                        </div>

                        <button onclick="saveSettings('ad')" class="w-full py-2.5 bg-gradient-to-r from-emerald-600 to-teal-500 text-white rounded-xl font-bold shadow-md hover:-translate-y-0.5 transition-all">
                            <i class="fas fa-save mr-2"></i> Save Ad Settings
                        </button>
                    </div>

                    <div class="bg-[var(--bg-card)] rounded-2xl p-6 shadow-sm border border-[var(--border-color)]">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-[var(--text-primary)] flex items-center gap-2">
                                <i class="fas fa-mobile-alt text-purple-500"></i> App Information
                            </h3>
                            <span id="appInfoSaveIndicator" class="text-xs font-bold text-emerald-500 hidden"><i class="fas fa-check-circle mr-1"></i>Saved</span>
                        </div>

                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="space-y-1.5">
                                    <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">App Version</label>
                                    <input type="text" id="appVersion" data-setting="appVersion" class="w-full px-4 py-2.5 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none text-sm" placeholder="e.g. v2.5.0">
                                </div>
                                <div class="space-y-1.5">
                                    <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Build Number</label>
                                    <input type="text" id="buildNumber" data-setting="buildNumber" class="w-full px-4 py-2.5 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none text-sm" placeholder="e.g. 20260220">
                                </div>
                            </div>

                            <div class="space-y-1.5">
                                <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Last Update Date</label>
                                <input type="text" id="infoDate" data-setting="infoDate" class="w-full px-4 py-2.5 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none text-sm" placeholder="e.g. 29 Jan, 2026">
                            </div>

                            <div class="space-y-1.5">
                                <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Telegram Channel Link</label>
                                <input type="url" id="infoChannel" data-setting="infoChannel" class="w-full px-4 py-2.5 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none text-sm" placeholder="https://t.me/your_channel">
                            </div>

                            <div class="space-y-1.5">
                                <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Telegram Group Link</label>
                                <input type="url" id="infoGroup" data-setting="infoGroup" class="w-full px-4 py-2.5 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none text-sm" placeholder="https://t.me/your_group">
                            </div>
                            
                            <button onclick="saveSettings('appInfo')" class="w-full py-2.5 mt-2 bg-gradient-to-r from-emerald-600 to-teal-500 text-white rounded-xl font-bold shadow-md hover:-translate-y-0.5 transition-all">
                                <i class="fas fa-save mr-2"></i> Save App Info
                            </button>
                        </div>
                    </div>

                    <div class="bg-[var(--bg-card)] rounded-2xl p-6 shadow-sm border border-[var(--border-color)]">
                        <h3 class="text-lg font-bold text-[var(--text-primary)] mb-4 flex items-center gap-2">
                            <i class="fas fa-shield-alt text-amber-500"></i> Admin Configuration
                        </h3>
                        
                        <div class="bg-blue-500/10 border border-blue-500/20 rounded-xl p-3 mb-4 flex items-start gap-3">
                            <i class="fas fa-info-circle text-blue-500 mt-0.5"></i>
                            <p class="text-xs text-blue-600 dark:text-blue-400 font-medium">To change your password, use the "Forgot Password" link on the login screen or manage via Firebase Auth Console.</p>
                        </div>

                        <div class="space-y-2 mb-4">
                            <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Telegram Admin ID (Auto-Login)</label>
                            <div class="flex gap-2">
                                <input type="number" id="adminTelegramId" class="flex-1 px-4 py-2.5 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none">
                                <button onclick="detectMyTelegramId()" class="px-4 bg-blue-500 hover:bg-blue-600 text-white rounded-xl transition-colors shadow-sm" title="Detect ID">
                                    <i class="fab fa-telegram-plane"></i>
                                </button>
                            </div>
                            <p class="text-[10px] text-[var(--text-secondary)]">Enable automatic login when opening the panel inside Telegram.</p>
                        </div>

                        <button onclick="saveAdminSecurity()" class="w-full py-2.5 bg-gradient-to-r from-emerald-600 to-teal-500 text-white rounded-xl font-bold shadow-md hover:-translate-y-0.5 transition-all">
                            <i class="fas fa-save mr-2"></i> Save Security Config
                        </button>
                    </div>

                    <div class="bg-[var(--bg-card)] rounded-2xl p-6 shadow-sm border border-[var(--border-color)] lg:col-span-2">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-lg font-bold text-[var(--text-primary)] flex items-center gap-2">
                                <i class="fas fa-server text-rose-500"></i> System Info
                            </h3>
                        </div>

                        <div class="grid grid-cols-3 gap-2 bg-[var(--bg-primary)] rounded-xl p-4 border border-[var(--border-color)] mb-4 text-center">
                            <div>
                                <p class="text-[10px] text-[var(--text-secondary)] uppercase font-semibold">Database</p>
                                <p class="text-sm font-bold text-emerald-500">Firestore</p>
                            </div>
                            <div class="border-x border-[var(--border-color)]">
                                <p class="text-[10px] text-[var(--text-secondary)] uppercase font-semibold">Total Users</p>
                                <p class="text-sm font-bold text-[var(--text-primary)]" id="systemUserCount">0</p>
                            </div>
                            <div>
                                <p class="text-[10px] text-[var(--text-secondary)] uppercase font-semibold">Last Update</p>
                                <p class="text-xs font-bold text-[var(--text-primary)] mt-0.5 truncate px-1" id="lastSettingsUpdate">Never</p>
                            </div>
                        </div>

                        <div class="flex gap-3 max-w-md mx-auto">
                            <button onclick="testSettings()" class="flex-1 py-2.5 border border-blue-500 text-blue-500 hover:bg-blue-500 hover:text-white rounded-xl font-bold transition-colors text-sm">
                                <i class="fas fa-vial mr-1"></i> Test Config
                            </button>
                            <button onclick="resetToDefaults()" class="flex-1 py-2.5 border border-red-500 text-red-500 hover:bg-red-500 hover:text-white rounded-xl font-bold transition-colors text-sm">
                                <i class="fas fa-undo mr-1"></i> Reset Default
                            </button>
                        </div>
                    </div>

                </div>
            </section>
        </main>
    </div>

    <!-- Edit User Modal -->
  <style>
        /* Override display behavior for perfect Tailwind integration */
        .modal { display: none !important; }
        .modal.show { display: flex !important; }
    </style>

    <div class="modal fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[1000] items-center justify-center p-4" id="editUserModal">
        <div class="bg-[var(--bg-card)] w-full max-w-lg rounded-2xl shadow-2xl border border-[var(--border-color)] overflow-hidden flex flex-col max-h-[90vh]">
            <div class="px-6 py-4 border-b border-[var(--border-color)] flex justify-between items-center bg-[var(--bg-secondary)]/50">
                <h3 class="text-lg font-bold text-[var(--text-primary)]"><i class="fas fa-user-edit text-blue-500 mr-2"></i>Edit User</h3>
                <button class="text-[var(--text-secondary)] hover:text-red-500 transition-colors text-xl w-8 h-8 flex items-center justify-center rounded-lg hover:bg-red-500/10" onclick="closeEditUserModal()">&times;</button>
            </div>
            
            <form id="editUserForm" class="p-6 overflow-y-auto space-y-4 flex-1">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">User ID</label>
                        <input type="text" id="editUserId" class="w-full px-3 py-2 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] text-sm opacity-70 cursor-not-allowed" readonly>
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Telegram ID</label>
                        <input type="text" id="editTelegramId" class="w-full px-3 py-2 rounded-xl bg-[var(--bg-primary)] border border-[var(--border-color)] text-[var(--text-primary)] text-sm opacity-70 cursor-not-allowed" readonly>
                    </div>
                </div>

                <div class="space-y-1">
                    <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Full Name</label>
                    <input type="text" id="editName" class="w-full px-4 py-2.5 rounded-xl bg-[var(--bg-secondary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                    <div class="text-[10px] text-amber-500 italic hidden" id="nameInfo">Managed by Telegram</div>
                </div>

                <div class="space-y-1">
                    <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Username</label>
                    <input type="text" id="editUsername" class="w-full px-4 py-2.5 rounded-xl bg-[var(--bg-secondary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                    <div class="text-[10px] text-amber-500 italic hidden" id="usernameInfo">Managed by Telegram</div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 border-t border-[var(--border-color)] pt-4 mt-2">
                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-emerald-500 uppercase">Balance (BDT)</label>
                        <input type="number" step="0.01" id="editBalance" class="w-full px-4 py-2.5 rounded-xl bg-emerald-500/5 border border-emerald-500/20 text-[var(--text-primary)] font-bold focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-emerald-500 uppercase">Total Earnings (BDT)</label>
                        <input type="number" step="0.01" id="editTotalEarnings" class="w-full px-4 py-2.5 rounded-xl bg-emerald-500/5 border border-emerald-500/20 text-[var(--text-primary)] font-bold focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Ads Watched</label>
                        <input type="number" id="editAdsWatched" class="w-full px-3 py-2 rounded-xl bg-[var(--bg-secondary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                    </div>
                    <div class="space-y-1">
                        <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Completed Tasks</label>
                        <input type="number" id="editCompletedTasks" class="w-full px-3 py-2 rounded-xl bg-[var(--bg-secondary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 hidden">
                    <input type="text" id="editSource">
                    <input type="text" id="editTelegramDetected">
                </div>

                <div class="pt-4 border-t border-[var(--border-color)]">
                    <button type="submit" class="w-full py-3 px-4 bg-gradient-to-r from-emerald-600 to-teal-500 hover:from-emerald-500 hover:to-teal-400 text-white rounded-xl font-bold shadow-lg shadow-emerald-500/20 transition-all transform hover:-translate-y-0.5">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[1000] items-center justify-center p-4" id="withdrawalModal">
        <div class="bg-[var(--bg-card)] w-full max-w-lg rounded-2xl shadow-2xl border border-[var(--border-color)] overflow-hidden max-h-[90vh] flex flex-col">
            
            <div class="px-6 py-4 border-b border-[var(--border-color)] flex justify-between items-center bg-[var(--bg-secondary)]/50 shrink-0">
                <h3 class="text-lg font-bold text-[var(--text-primary)]"><i class="fas fa-file-invoice-dollar text-rose-500 mr-2"></i>Payout Details</h3>
                <button class="text-[var(--text-secondary)] hover:text-red-500 transition-colors text-xl w-8 h-8 flex items-center justify-center rounded-lg hover:bg-red-500/10" onclick="closeWithdrawalModal()">&times;</button>
            </div>
            
            <div id="withdrawalDetails" class="p-6 space-y-4 overflow-y-auto flex-1">
                </div>
            
        </div>
    </div>

    <div class="modal fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[1000] items-center justify-center p-4" id="rejectReasonModal">
        <div class="bg-[var(--bg-card)] w-full max-w-sm rounded-2xl shadow-2xl border border-[var(--border-color)] overflow-hidden">
            <div class="px-6 py-4 border-b border-[var(--border-color)] flex justify-between items-center bg-red-500/10">
                <h3 class="text-lg font-bold text-red-500"><i class="fas fa-exclamation-triangle mr-2"></i>Reject Payout</h3>
                <button class="text-red-400 hover:text-red-600 transition-colors text-xl w-8 h-8 flex items-center justify-center rounded-lg hover:bg-red-500/20" onclick="closeRejectModal()">&times;</button>
            </div>
            
            <div class="p-6">
                <p class="text-[var(--text-secondary)] text-sm mb-4">
                    Please provide a reason for rejecting this request. The funds will be returned to the user, and they will receive this message.
                </p>

                <div class="space-y-2 mb-6">
                    <label class="text-xs font-semibold text-[var(--text-secondary)] uppercase">Rejection Reason</label>
                    <textarea id="rejectionReason" class="w-full px-4 py-3 rounded-xl bg-[var(--bg-secondary)] border border-[var(--border-color)] text-[var(--text-primary)] focus:ring-2 focus:ring-red-500 outline-none transition-all resize-none" rows="3" placeholder="e.g. Invalid wallet number provided..."></textarea>
                </div>

                <div class="flex gap-3">
                    <button class="flex-1 py-2.5 px-4 bg-[var(--bg-secondary)] hover:bg-[var(--hover-bg)] text-[var(--text-primary)] rounded-xl font-medium border border-[var(--border-color)] transition-all" onclick="closeRejectModal()">Cancel</button>
                    <button class="flex-1 py-2.5 px-4 bg-red-500 hover:bg-red-600 text-white rounded-xl font-medium shadow-md shadow-red-500/20 transition-all" onclick="submitRejection()">Confirm Reject</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Firebase Configuration -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
  apiKey: "AIzaSyAH-6VEsx8Jp2KVeltSlvBFU1nn6M-2r1w",
  authDomain: "adbot-s4.firebaseapp.com",
  projectId: "adbot-s4",
  storageBucket: "adbot-s4.firebasestorage.app",
  messagingSenderId: "422990164333",
  appId: "1:422990164333:web:34c170382c4a87915f2a64"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Collections
        const USERS_COLLECTION = "adv2_users";
        const WITHDRAWALS_COLLECTION = "adv2_withdrawals";
        const ADMIN_SETTINGS_DOC_ID = "_admin_settings_";

       // ==========================================
        // 1. GLOBAL VARIABLES (Replace your old list with this)
        // ==========================================
        
        const TELEGRAM_BOT_TOKEN = "8314081756:AAEHtIG4dDL6HzvTTKr2OVr0nh2EDayqMj8"; // Keep your token
        
        // --- AUTH VARIABLES ---
        let currentUser = null;      // Stores the logged-in Firebase User
        let adminLoggedIn = false;   // Tracks if admin is logged in
        
        // --- DATA VARIABLES ---
        let users = [];
        let withdrawals = [];
        let currentPage = 1;
        const itemsPerPage = 15;
        let filteredUsers = [];
        let charts = {};
        let settings = {};

        // --- CONTENT SETTINGS ---
        let contentSettings = {
            marqueeSettings: {},
            paymentMethods: [],
            adServices: [],
            popunder: { code: '', active: false },
            socialBar: { code: '', active: false },
            appInfo: {} 
        };
        
        // NOTE: We deleted 'adminCredentials' because we use Firebase Auth now.
        // Check login from localStorage
        // --- AUTH STATE LISTENER (Runs on load) ---
// --- AUTH STATE LISTENER (Runs on load) ---
auth.onAuthStateChanged(async (user) => {
    if (user) {
        // Check if user has an email (Anonymous users don't)
        if (!user.email) {
            console.log("Anonymous user detected. Signing out to force Email Login...");
            auth.signOut(); // Force logout so you can log in with Email/Pass
            return;
        }

        console.log("User is signed in:", user.email);
        currentUser = user;
        adminLoggedIn = true;
        
        // Show Admin Panel
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
        
        // Safe Name Display (Fixes the split error)
        const displayName = user.email ? user.email.split('@')[0] : 'Admin';
        
        const desktopNameEl = document.getElementById('desktopAdminDisplayName');
        if(desktopNameEl) desktopNameEl.textContent = displayName;
        
        const mobileNameEl = document.getElementById('mobileAdminDisplayName');
        if(mobileNameEl) mobileNameEl.textContent = displayName;
        
        // Initialize the panel
        initAdminPanel();
    } else {
        // --- SCENARIO 2: NOT LOGGED IN ---
        console.log("No Firebase user. Checking Telegram...");
        
        // Check Telegram Auto-Login
        const telegramSuccess = await checkTelegramAutoLogin();
        
        if (!telegramSuccess) {
            adminLoggedIn = false;
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('adminPanel').style.display = 'none';
        }
    }
});
        // Update admin display in header
        function updateAdminDisplay() {
            const adminName = adminCredentials.username;
            const firstLetter = adminName.charAt(0).toUpperCase();
            
            // Update desktop admin info
            document.getElementById('desktopAdminDisplayName').textContent = adminName;
            document.getElementById('desktopAdminAvatar').textContent = firstLetter;
            
            // Update mobile admin info
            document.getElementById('mobileAdminDisplayName').textContent = adminName;
            document.getElementById('mobileAdminAvatar').textContent = firstLetter;
            
            // Update admin info in settings
            if (document.getElementById('adminNewUsername')) {
                document.getElementById('adminNewUsername').value = adminCredentials.username;
                document.getElementById('adminSecurityQuestion').value = adminCredentials.securityQuestion;
                document.getElementById('adminSecurityAnswer').value = adminCredentials.securityAnswer;
            }
        }

        // UPDATED: Login Logic (Checks Firestore)
        // --- NEW LOGIN LOGIC (Firebase Auth) ---
// --- NEW LOGIN LOGIC (Firebase Auth) ---
document.getElementById('loginBtn').addEventListener('click', function() {
    const email = document.getElementById('adminEmail').value.trim();
    // FIX: Added space between 'const' and 'password'
    const password = document.getElementById('adminPassword').value.trim(); 
    const loginBtn = document.getElementById('loginBtn');
    const errorDiv = document.getElementById('loginError');
    
    if (!email || !password) {
        errorDiv.textContent = 'Please enter email and password';
        return;
    }

    // UI Loading State
    const originalText = loginBtn.innerHTML;
    loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
    loginBtn.disabled = true;
    errorDiv.textContent = '';

    // Firebase Sign In
    auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            console.log("Logged in as:", userCredential.user.email);
            // The authStateChanged listener will handle the redirect automatically
        })
        .catch((error) => {
            console.error("Login Error:", error);
            let msg = error.message;
            if(error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') {
                msg = "Invalid Email or Password.";
            } else if(error.code === 'auth/too-many-requests') {
                msg = "Too many failed attempts. Please try again later.";
            }
            errorDiv.textContent = msg;
            loginBtn.innerHTML = originalText;
            loginBtn.disabled = false;
        });
});

       
        // Show forgot password form
        document.getElementById('showForgotPassword').addEventListener('click', function() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'block';
        });

        // Back to login
        document.getElementById('backToLogin').addEventListener('click', function() {
            document.getElementById('forgotPasswordForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('recoveryResult').style.display = 'none';
            document.getElementById('recoveryError').textContent = '';
        });

        // Recover password
        // UPDATED: Recover Password (Fetches from Firestore)
        // --- NEW PASSWORD RESET (Firebase Email) ---
document.getElementById('recoverBtn').addEventListener('click', function() {
    const email = document.getElementById('resetEmail').value.trim();
    const errorDiv = document.getElementById('recoveryError');
    const successDiv = document.getElementById('recoverySuccess');
    const btn = document.getElementById('recoverBtn');

    if (!email) {
        errorDiv.textContent = 'Please enter your admin email.';
        return;
    }

    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
    btn.disabled = true;
    errorDiv.textContent = '';
    successDiv.style.display = 'none';

    auth.sendPasswordResetEmail(email)
        .then(() => {
            successDiv.textContent = `Reset link sent to ${email}. Check your inbox.`;
            successDiv.style.display = 'block';
            document.getElementById('resetEmail').value = '';
        })
        .catch((error) => {
            errorDiv.textContent = error.message;
        })
        .finally(() => {
            btn.innerHTML = 'Send Reset Link';
            btn.disabled = false;
        });
});
        // Update admin credentials
        async function updateAdminCredentials() {
            const newUsername = document.getElementById('adminNewUsername').value.trim();
            const newPassword = document.getElementById('adminNewPassword').value;
            const confirmPassword = document.getElementById('adminConfirmPassword').value;
            const securityQuestion = document.getElementById('adminSecurityQuestion').value;
            const securityAnswer = document.getElementById('adminSecurityAnswer').value.trim();
            
            if (!newUsername || !newPassword || !confirmPassword || !securityQuestion || !securityAnswer) {
                showAlert('Please fill all fields', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showAlert('Passwords do not match', 'error');
                return;
            }
            
            adminCredentials = {
                username: newUsername,
                password: newPassword,
                securityQuestion: securityQuestion,
                securityAnswer: securityAnswer
            };
            
            localStorage.setItem('advault_admin_credentials', JSON.stringify(adminCredentials));
            updateAdminDisplay();
            showToast('Admin credentials updated successfully!', 'success');
            
            // Clear password fields
            document.getElementById('adminNewPassword').value = '';
            document.getElementById('adminConfirmPassword').value = '';
        }

        // Logout
        function logout() {
    auth.signOut().then(() => {
        // Sign-out successful.
        adminLoggedIn = false;
        // The onAuthStateChanged listener will automatically show the login screen
        window.location.reload(); // Reload to clear any Telegram session states
    }).catch((error) => {
        console.error("Logout Error:", error);
    });
}
        // Initialize Admin Panel
        // Initialize Admin Panel
        async function initAdminPanel() {
            try {
                document.getElementById('loadingScreen').style.display = 'flex';
                
                // REMOVED: await auth.signInAnonymously(); 
                // Reason: We are already logged in via Email/Password or Telegram. 
                // calling this would log us out!

                // Load settings
                await loadSettings();
                
                // Load content settings
                await loadContentSettings();
                
                // Load initial data
                await loadDashboardData();
                await loadUsers();
                await loadWithdrawals();
                
                // Initialize charts
                initializeCharts();
                
                // Update UI
                updateDashboardStats();
                updateRecentActivity();
                updateUsersTable();
                updateWithdrawalsTable();
                updateTopUsers();
                
                // Hide loading screen
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                }, 500);
                
            } catch (error) {
                console.error("Error initializing admin panel:", error);
                // Do not use showAlert here as it might not be defined yet or cause issues during init
                console.log("Failed to initialize panel");
            }
        }

        // Load settings
        async function loadSettings() {
            try {
                const snapshot = await db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID).get();
                if (snapshot.exists) {
                    settings = snapshot.data();
                    applySettingsToUI();
                    
                    // Update last settings update time
                    if (settings.lastUpdated) {
                        const date = new Date(settings.lastUpdated);
                        document.getElementById('lastSettingsUpdate').textContent = date.toLocaleString();
                    }
                } else {
                    // Default settings
                    settings = {
                        maintenanceMode: false,
                        autoApprove: false,
                        enablePenalty: true,
                        minWithdrawal: 100,
                        earningsPerAd: 0.05,
                        dailyTasks: 1000,
                        adDuration: 15,
                        penaltyDuration: 2,
                        lastUpdated: new Date().toISOString(),
                        isAdminSettings: true
                    };
                    await db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID).set(settings);
                    applySettingsToUI();
                    
                    document.getElementById('lastSettingsUpdate').textContent = 'Just now';
                }
                
                // Set up real-time listener for settings changes
                setupSettingsListener();
                
            } catch (error) {
                console.error("Error loading settings:", error);
                showToast('Failed to load settings', 'error');
            }
        }
// ================= NOTIFICATION LOGIC =================

// Make sure to add your token at the top of the script if you haven't yet:
    // const TELEGRAM_BOT_TOKEN = "YOUR_BOT_TOKEN_HERE"; 

    async function sendNotification() {
        const title = document.getElementById('notifTitle').value.trim();
        const message = document.getElementById('notifMessage').value.trim();
        
        // Get Checkbox Values
        const sendToApp = document.getElementById('sendToApp').checked;
        const sendToTelegram = document.getElementById('sendToTelegram').checked;

        if(!title || !message) {
            showToast("Please enter a Title and Message", "error");
            return;
        }

        if(!sendToApp && !sendToTelegram) {
            showToast("Please select at least one destination (App or Telegram)", "error");
            return;
        }

        const btn = document.querySelector('#notificationsSection .btn-primary');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
        btn.disabled = true;

        try {
            let statusMsg = "";

            // --- 1. SEND TO APP (FIRESTORE) ---
            if (sendToApp) {
                await db.collection('adv2_notifications').add({
                    title: title,
                    message: message,
                    createdAt: new Date().toISOString(),
                    createdBy: "Admin"
                });
                statusMsg += "App Popup Sent. ";
            }

            // --- 2. SEND TO TELEGRAM (DM) ---
            if (sendToTelegram) {
                if(!TELEGRAM_BOT_TOKEN || TELEGRAM_BOT_TOKEN.includes("YOUR_BOT_TOKEN")) {
                    alert("Error: TELEGRAM_BOT_TOKEN is missing in code!");
                } else {
                    // Fetch users who have an ID that looks like a Telegram ID (numbers)
                    const snapshot = await db.collection(USERS_COLLECTION).get();
                    const telegramUsers = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.id && /^\d+$/.test(data.id)) { 
                            telegramUsers.push(data.id);
                        }
                    });

                    // Send DMs loop
                    let sentCount = 0;
                    const fullMessage = `üì¢ *${title}*\n\n${message}\n\nüëá _Open app to check!_`;

                    for (const userId of telegramUsers) {
                        try {
                            // Don't await the fetch result to speed it up (Fire & Forget)
                            fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({
                                    chat_id: userId,
                                    text: fullMessage,
                                    parse_mode: 'Markdown'
                                })
                            });
                            sentCount++;
                            // Tiny delay to be safe
                            await new Promise(r => setTimeout(r, 20));
                        } catch (err) { console.error(err); }
                    }
                    statusMsg += `Sent to ${sentCount} Telegram users.`;
                }
            }
            
            // Clear inputs and reload list
            showToast("Success! " + statusMsg, "success");
            document.getElementById('notifTitle').value = '';
            document.getElementById('notifMessage').value = '';
            
            // Only reload list if we saved to database (otherwise list won't change)
            if(sendToApp) loadNotifications(); 

        } catch(e) {
            console.error(e);
            showToast("Error: " + e.message, "error");
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

async function loadNotifications() {
    const tbody = document.getElementById('notificationHistoryBody');
    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 1rem;">Loading...</td></tr>';
    
    try {
        const snap = await db.collection('adv2_notifications')
            .orderBy('createdAt', 'desc')
            .limit(20)
            .get();
        
        tbody.innerHTML = '';
        
        if(snap.empty) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 1rem; color: var(--text-secondary);">No notifications found</td></tr>';
            return;
        }

        snap.forEach(doc => {
            const data = doc.data();
            const date = new Date(data.createdAt).toLocaleDateString();
            const row = `
                <tr style="border-bottom: 1px solid var(--border-color);">
                    <td style="padding: 12px 8px;">${date}</td>
                    <td style="padding: 12px 8px; font-weight: 500;">${data.title}</td>
                    <td style="padding: 12px 8px; text-align: right;">
                        <button onclick="deleteNotification('${doc.id}')" class="btn btn-delete" style="padding: 4px 8px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    } catch(e) {
        console.error(e);
        tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 1rem; color: #ef4444;">Error loading history</td></tr>';
    }
}

async function deleteNotification(id) {
    if(!confirm("Are you sure? This will remove the notification for all users.")) return;
    
    try {
        await db.collection('adv2_notifications').doc(id).delete();
        showToast("Notification deleted", "success");
        loadNotifications();
    } catch(e) {
        showToast("Error deleting: " + e.message, "error");
    }
}
        // Load content settings
        // ================= CONTENT SETTINGS (LOAD & SAVE) =================

        // 1. Load Content Settings (Includes App Info now)
        async function loadContentSettings() {
    try {
        const snapshot = await db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID).get();
        if (snapshot.exists) {
            const data = snapshot.data();
            
            // --- Existing Data Loading ---
            if (data.marqueeSettings) contentSettings.marqueeSettings = data.marqueeSettings;
            if (data.paymentMethods) contentSettings.paymentMethods = data.paymentMethods;
            if (data.adServices) contentSettings.adServices = data.adServices;
            if (data.popunder) contentSettings.popunder = data.popunder;
            if (data.socialBar) contentSettings.socialBar = data.socialBar;
            if (data.appInfo) contentSettings.appInfo = data.appInfo;

            // --- NEW: Load Banner Scripts into the 4 new inputs ---
            if (data.bannerAds) {
                contentSettings.bannerAds = data.bannerAds;
                document.getElementById('script_home').value = data.bannerAds.home || '';
                document.getElementById('script_earn').value = data.bannerAds.earn || '';
                document.getElementById('script_game').value = data.bannerAds.game || '';
                document.getElementById('script_profile').value = data.bannerAds.profile || '';
            }

            // --- NEW: Load Native Ad Script ---
            if (data.nativeAd) {
                contentSettings.nativeAd = data.nativeAd;
                document.getElementById('script_native').value = data.nativeAd.code || '';
            }

            // --- Render UI ---
            renderMarqueeList();
            renderPaymentMethodList();
            renderSmartLinkList(); // Call the new Smartlink renderer
            updateAdBlockUI();
        }
    } catch (error) {
        console.error("Error loading content settings:", error);
        showToast("Error loading content settings", "error");
    }
}

        // 2. Save Content Settings (Now saves App Info too)
        // 2. Save Content Settings (Cleaned up - App Info removed)
        async function saveContentSettings(showNotification = true) {
            try {
                // Save Content to Firestore
                await db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID).set({
                    marqueeSettings: contentSettings.marqueeSettings,
                    paymentMethods: contentSettings.paymentMethods,
                    adServices: contentSettings.adServices,
                    popunder: contentSettings.popunder,
                    socialBar: contentSettings.socialBar,
                    lastUpdated: new Date().toISOString()
                }, { merge: true });
                
                if (showNotification) {
                    showToast('Content settings saved successfully!', 'success');
                }
                return true;
            } catch (error) {
                console.error("Error saving content settings:", error);
                showToast('Failed to save content settings', 'error');
                return false;
            }
        }
// --- Helper: Update Color Input ---
function setPmColor(color) {
    // Update the Text Input
    document.getElementById('pmColor').value = color;
    
    // Update the Preview Box
    document.getElementById('colorPreview').style.backgroundColor = color;
}
        // Helper to update the UI state
        function updateAdBlockUI() {
            // Popunder
            document.getElementById('popunderScript').value = contentSettings.popunder.code || '';
            const popBtn = document.getElementById('popunderToggleBtn');
            if(contentSettings.popunder.active) {
                popBtn.style.background = '#dcfce7';
                popBtn.style.color = '#166534';
            } else {
                popBtn.style.background = '#fee2e2';
                popBtn.style.color = '#991b1b';
            }

            // Social Bar
            document.getElementById('socialBarScript').value = contentSettings.socialBar.code || '';
            const socialBtn = document.getElementById('socialBarToggleBtn');
            if(contentSettings.socialBar.active) {
                socialBtn.style.background = '#dcfce7';
                socialBtn.style.color = '#166534';
            } else {
                socialBtn.style.background = '#fee2e2';
                socialBtn.style.color = '#991b1b';
            }
        }
        
       // --- POPUNDER FUNCTIONS ---
        async function savePopunder() {
            const code = document.getElementById('popunderScript').value.trim();
            contentSettings.popunder.code = code;
            
            // Pass 'false' to stop the generic "Saved" message
            await saveContentSettings(false); 
            showToast('Popunder script saved!', 'success');
        }

        async function togglePopunder() {
            contentSettings.popunder.active = !contentSettings.popunder.active;
            
            // Pass 'false' here too
            await saveContentSettings(false);
            updateAdBlockUI();
            showToast(`Popunder ${contentSettings.popunder.active ? 'Enabled' : 'Disabled'}`, 'info');
        }

        // --- SOCIAL BAR FUNCTIONS ---
        async function saveSocialBar() {
            const code = document.getElementById('socialBarScript').value.trim();
            contentSettings.socialBar.code = code;
            
            await saveContentSettings(false);
            showToast('Social Bar script saved!', 'success');
        }

        async function toggleSocialBar() {
            contentSettings.socialBar.active = !contentSettings.socialBar.active;
            
            await saveContentSettings(false);
            updateAdBlockUI();
            showToast(`Social Bar ${contentSettings.socialBar.active ? 'Enabled' : 'Disabled'}`, 'info');
        }
        
        // Save content settings (Updated: Can silence notification)
        

        // Set up real-time listener for settings
        function setupSettingsListener() {
            db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const newSettings = doc.data();
                        settings = newSettings;
                        applySettingsToUI();
                        
                        // Update content settings if they exist
                        if (newSettings.marqueeSettings) contentSettings.marqueeSettings = newSettings.marqueeSettings;
                        if (newSettings.paymentMethods) contentSettings.paymentMethods = newSettings.paymentMethods;
                        if (newSettings.adServices) contentSettings.adServices = newSettings.adServices;
                        
                        // Update content UI if content section is active
                        if (document.getElementById('contentSection').style.display !== 'none') {
                            renderMarqueeList();
                            renderPaymentMethodList();
                            renderAdServiceList();
                        }
                        
                        // Update last settings update time
                        if (settings.lastUpdated) {
                            const date = new Date(settings.lastUpdated);
                            document.getElementById('lastSettingsUpdate').textContent = date.toLocaleString();
                        }
                        
                        // Update settings status
                        document.getElementById('settingsStatus').textContent = 'Settings: Active';
                        document.getElementById('settingsStatus').style.color = '#10b981';
                        
                    }
                }, (error) => {
                    console.error("Settings listener error:", error);
                    document.getElementById('settingsStatus').textContent = 'Settings: Error';
                    document.getElementById('settingsStatus').style.color = '#ef4444';
                });
        }

        // Save settings
        async function saveSettings(type = 'all') {
    try {
        let settingsData = {
            lastUpdated: new Date().toISOString(),
            isAdminSettings: true
        };

        // 1. General Settings
        if (type === 'general' || type === 'all') {
            settingsData.maintenanceMode = document.getElementById('maintenanceMode').checked;
            settingsData.autoApprove = document.getElementById('autoApprove').checked;
            settingsData.enablePenalty = document.getElementById('enablePenalty').checked;
            settingsData.minWithdrawal = parseFloat(document.getElementById('minWithdrawal').value);
        }

        // 2. Ad Settings
        if (type === 'ad' || type === 'all') {
            settingsData.earningsPerAd = parseFloat(document.getElementById('earningsPerAd').value);
            settingsData.dailyTasks = parseInt(document.getElementById('dailyTasks').value);
            settingsData.adDuration = parseInt(document.getElementById('adDuration').value);
            settingsData.penaltyDuration = parseInt(document.getElementById('penaltyDuration').value);
        }

       // 3. App Information
        if (type === 'appInfo' || type === 'all') {
            settingsData.appVersion = document.getElementById('appVersion').value.trim();
            settingsData.buildNumber = document.getElementById('buildNumber').value.trim();
            settingsData.infoDate = document.getElementById('infoDate').value.trim();
            settingsData.infoChannel = document.getElementById('infoChannel').value.trim();
            settingsData.infoGroup = document.getElementById('infoGroup').value.trim();
        }

        // Merge with existing settings
        const updatedSettings = {
            ...settings,
            ...settingsData,
            marqueeSettings: contentSettings.marqueeSettings,
            paymentMethods: contentSettings.paymentMethods,
            adServices: contentSettings.adServices
        };

        await db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID).set(updatedSettings, { merge: true });
        settings = updatedSettings;
        
        // Show success indicator based on type
        // Show success indicator based on type
        if (type === 'general') showIndicator('generalSaveIndicator', 'Saved!');
        else if (type === 'ad') showIndicator('adSaveIndicator', 'Saved!');
        else if (type === 'appInfo') showIndicator('appInfoSaveIndicator', 'Saved!');
         // New indicator
        
        showToast(`${type === 'all' ? 'All' : 'System'} settings saved successfully!`, 'success');
        
        document.getElementById('lastSettingsUpdate').textContent = new Date().toLocaleString();
        return true;
    } catch (error) {
        console.error("Error saving settings:", error);
        showToast(`Failed to save ${type} settings.`, 'error');
        return false;
    }
}

// --- SMART AUTO-LOGIN CHECK ---
    async function checkTelegramAutoLogin() {
        // 1. Check if running inside Telegram
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe.user) {
            const tgUser = window.Telegram.WebApp.initDataUnsafe.user;
            const myTgId = tgUser.id.toString();
            
            console.log("Checking Auto-Login for ID:", myTgId);

            try {
                // 2. Check database
                const doc = await db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID).get();
                if (doc.exists) {
                    const data = doc.data();
                    // Compare saved ID with current ID
                    if (data.adminTelegramId && data.adminTelegramId.toString() === myTgId) {
                        
                        // 3. SUCCESS: Log in automatically
                        showToast(`Auto-login success! Welcome ${tgUser.first_name}`, 'success');
                        
                        // Set credentials locally so the panel works
                        adminCredentials.username = data.username || "Admin";
                        adminCredentials.password = data.password || "";
                        adminLoggedIn = true;
                        
                        // Update UI
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('adminPanel').style.display = 'block';
                        updateAdminDisplay();
                        initAdminPanel();
                        return true;
                    }
                }
            } catch (e) {
                console.error("Auto-login failed:", e);
            }
        }
        return false;
    }

// --- ADMIN SECURITY FUNCTIONS ---

    // 1. Helper to auto-fill your ID if you are using the bot
    function detectMyTelegramId() {
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe.user) {
            const myId = window.Telegram.WebApp.initDataUnsafe.user.id;
            document.getElementById('adminTelegramId').value = myId;
            showToast("ID Detected: " + myId, "success");
        } else {
            showToast("Open this in Telegram to detect ID automatically", "info");
        }
    }

    // 2. Save Function (Username, Password, Telegram UID)
    async function saveAdminSecurity() {
    const telegramId = document.getElementById('adminTelegramId').value.trim();
    
    // We only update the Telegram ID in the database now.
    // Password changes are handled via Firebase Console or "Forgot Password" email.
    
    const btn = event.target; 
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    btn.disabled = true;

    try {
        await db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID).set({
            adminTelegramId: telegramId,
            // We do NOT save username/password/security questions here anymore
        }, { merge: true });

        showToast('Telegram ID updated successfully!', 'success');

    } catch (error) {
        console.error("Error saving security settings:", error);
        showToast('Failed to update settings', 'error');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}
        // Show save indicator
        function showIndicator(elementId, message) {
            const indicator = document.getElementById(elementId);
            if (indicator) {
                indicator.textContent = message;
                indicator.style.display = 'block';
                indicator.style.color = '#10b981';
                
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 2000);
            }
        }

        // Apply settings to UI
        // Apply settings to UI
        // Apply settings to UI
        function applySettingsToUI() {
            if (!settings) return;
            
            // General
            if(document.getElementById('maintenanceMode')) document.getElementById('maintenanceMode').checked = settings.maintenanceMode || false;
            if(document.getElementById('autoApprove')) document.getElementById('autoApprove').checked = settings.autoApprove || false;
            if(document.getElementById('enablePenalty')) document.getElementById('enablePenalty').checked = settings.enablePenalty !== false;
            if(document.getElementById('minWithdrawal')) document.getElementById('minWithdrawal').value = settings.minWithdrawal || 100;
            
            // Ad
            if(document.getElementById('earningsPerAd')) document.getElementById('earningsPerAd').value = settings.earningsPerAd || 0.05;
            if(document.getElementById('dailyTasks')) document.getElementById('dailyTasks').value = settings.dailyTasks || 1000;
            if(document.getElementById('adDuration')) document.getElementById('adDuration').value = settings.adDuration || 15;
            if(document.getElementById('penaltyDuration')) document.getElementById('penaltyDuration').value = settings.penaltyDuration || 2;
            
            // App Information
            if (document.getElementById('appVersion')) document.getElementById('appVersion').value = settings.appVersion || '';
            if (document.getElementById('buildNumber')) document.getElementById('buildNumber').value = settings.buildNumber || '';
            if (document.getElementById('infoDate')) document.getElementById('infoDate').value = settings.infoDate || '';
            if (document.getElementById('infoChannel')) document.getElementById('infoChannel').value = settings.infoChannel || '';
            if (document.getElementById('infoGroup')) document.getElementById('infoGroup').value = settings.infoGroup || '';
            
            // Security
            if (document.getElementById('adminTelegramId')) {
                document.getElementById('adminTelegramId').value = settings.adminTelegramId || '';
            }
            
            updateMaintenanceStatus();
        }

        // Update maintenance status display
        function updateMaintenanceStatus() {
            const statusElement = document.getElementById('settingsStatus');
            if (!statusElement) return;
            
            if (settings.maintenanceMode) {
                statusElement.textContent = 'Maintenance: ACTIVE';
                statusElement.style.color = '#f59e0b';
                statusElement.style.fontWeight = 'bold';
            } else {
                statusElement.textContent = 'Settings: Active';
                statusElement.style.color = '#10b981';
                statusElement.style.fontWeight = 'normal';
            }
        }

        // Test settings
        async function testSettings() {
            showToast('Testing settings connection...', 'info');
            
            try {
                // Test Firestore connection
                const testDoc = await db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID).get();
                
                if (testDoc.exists) {
                    showToast('Settings connection successful!', 'success');
                    
                    // Show current settings in alert
                    const currentSettings = testDoc.data();
                    let settingsSummary = 'Current Settings:\n\n';
                    
                    // General settings
                    settingsSummary += 'GENERAL SETTINGS:\n';
                    settingsSummary += `‚Ä¢ Maintenance Mode: ${currentSettings.maintenanceMode ? 'ON' : 'OFF'}\n`;
                    settingsSummary += `‚Ä¢ Auto Approve: ${currentSettings.autoApprove ? 'ON' : 'OFF'}\n`;
                    settingsSummary += `‚Ä¢ Enable Penalty: ${currentSettings.enablePenalty !== false ? 'ON' : 'OFF'}\n`;
                    settingsSummary += `‚Ä¢ Min Withdrawal: ${currentSettings.minWithdrawal || 100} BDT\n\n`;
                    
                    // Ad settings
                    settingsSummary += 'AD SETTINGS:\n';
                    settingsSummary += `‚Ä¢ Earnings Per Ad: ${currentSettings.earningsPerAd || 0.05} BDT\n`;
                    settingsSummary += `‚Ä¢ Daily Tasks: ${currentSettings.dailyTasks || 1000}\n`;
                    settingsSummary += `‚Ä¢ Ad Duration: ${currentSettings.adDuration || 15} seconds\n`;
                    settingsSummary += `‚Ä¢ Penalty Duration: ${currentSettings.penaltyDuration || 2} minutes\n\n`;
                    
                    settingsSummary += `Last Updated: ${currentSettings.lastUpdated ? new Date(currentSettings.lastUpdated).toLocaleString() : 'Never'}`;
                    
                    alert(settingsSummary);
                } else {
                    showToast('Settings document not found', 'error');
                }
            } catch (error) {
                console.error('Settings test failed:', error);
                showToast(`Test failed: ${error.message}`, 'error');
            }
        }

        // Reset to defaults
        async function resetToDefaults() {
            if (!confirm('Are you sure you want to reset all settings to defaults? This will affect all users immediately.')) {
                return;
            }

            try {
                const defaultSettings = {
                    maintenanceMode: false,
                    autoApprove: false,
                    enablePenalty: true,
                    minWithdrawal: 100,
                    earningsPerAd: 0.05,
                    dailyTasks: 1000,
                    adDuration: 15,
                    penaltyDuration: 2,
                    lastUpdated: new Date().toISOString(),
                    isAdminSettings: true
                };

                await db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID).set(defaultSettings);
                settings = defaultSettings;
                applySettingsToUI();
                
                showToast('Settings reset to defaults!', 'success');
                document.getElementById('lastSettingsUpdate').textContent = new Date().toLocaleString();
            } catch (error) {
                console.error('Error resetting settings:', error);
                showToast('Failed to reset settings', 'error');
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load users data
                const usersSnapshot = await db.collection(USERS_COLLECTION).get();
                users = usersSnapshot.docs
                    .filter(doc => doc.id !== ADMIN_SETTINGS_DOC_ID && !doc.data().isAdminSettings)
                    .map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                // Load withdrawals data
                const withdrawalsSnapshot = await db.collection(WITHDRAWALS_COLLECTION).get();
                withdrawals = withdrawalsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

            } catch (error) {
                console.error("Error loading dashboard data:", error);
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const snapshot = await db.collection(USERS_COLLECTION).get();
                users = snapshot.docs
                    .filter(doc => doc.id !== ADMIN_SETTINGS_DOC_ID && !doc.data().isAdminSettings)
                    .map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                filteredUsers = [...users];
                updateUsersTable();
                updateTopUsers();
            } catch (error) {
                console.error("Error loading users:", error);
                showAlert("Failed to load users.", "error");
            }
        }

        // Load withdrawals
        async function loadWithdrawals() {
            try {
                const snapshot = await db.collection(WITHDRAWALS_COLLECTION)
                    .orderBy('timestamp', 'desc')
                    .limit(100)
                    .get();
                withdrawals = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                updateWithdrawalsTable();
            } catch (error) {
                console.error("Error loading withdrawals:", error);
                showAlert("Failed to load withdrawals.", "error");
            }
        }

        // Refresh withdrawals
        async function refreshWithdrawals() {
            await loadWithdrawals();
            showToast("Withdrawals refreshed successfully!", "success");
        }

        // Update dashboard statistics
        // Update dashboard statistics
        function updateDashboardStats() {
            // 1. Calculate Totals
            const totalUsers = users.length;
            const totalBalance = users.reduce((sum, user) => sum + (user.balance || 0), 0);
            const totalEarnings = users.reduce((sum, user) => sum + (user.totalEarnings || 0), 0);
            const totalWithdrawals = withdrawals.reduce((sum, w) => sum + (w.amount || 0), 0);
            const pendingWithdrawals = withdrawals.filter(w => w.status === 'pending').length;

            // 2. Calculate "Today" Stats safely
            const todayStr = new Date().toISOString().split('T')[0];
            
            // Count users who joined today
            const newUsersToday = users.filter(u => {
                const date = getSafeDate(u.joinDate);
                if (!date) return false;
                return date.toISOString().startsWith(todayStr);
            }).length;

            // Count users active today
            const activeToday = users.filter(u => {
                const date = getSafeDate(u.lastUpdated);
                if (!date) return false;
                return date.toISOString().startsWith(todayStr);
            }).length;

            // 3. Update UI Elements
            if(document.getElementById('totalUsers')) document.getElementById('totalUsers').textContent = totalUsers.toLocaleString();
            if(document.getElementById('userCount')) document.getElementById('userCount').textContent = totalUsers.toLocaleString();
            if(document.getElementById('systemUserCount')) document.getElementById('systemUserCount').textContent = totalUsers.toLocaleString();
            
            if(document.getElementById('totalBalance')) document.getElementById('totalBalance').textContent = `BDT ${totalBalance.toFixed(2)}`;
            if(document.getElementById('totalEarnings')) document.getElementById('totalEarnings').textContent = `BDT ${totalEarnings.toFixed(2)}`;
            if(document.getElementById('totalWithdrawals')) document.getElementById('totalWithdrawals').textContent = `BDT ${totalWithdrawals.toFixed(2)}`;
            
            const userGrowthEl = document.getElementById('usersGrowth');
            if(userGrowthEl) {
                userGrowthEl.textContent = `+${newUsersToday} joined today`;
                userGrowthEl.style.color = newUsersToday > 0 ? '#166534' : 'var(--text-secondary)';
            }

            const balanceGrowthEl = document.getElementById('balanceGrowth');
            if(balanceGrowthEl) {
                balanceGrowthEl.textContent = `${activeToday} active today`;
                balanceGrowthEl.style.color = activeToday > 0 ? '#166534' : 'var(--text-secondary)';
            }

            const withdrawalsGrowthEl = document.getElementById('withdrawalsGrowth');
            if(withdrawalsGrowthEl) {
                withdrawalsGrowthEl.textContent = `${pendingWithdrawals} pending`;
                withdrawalsGrowthEl.style.color = pendingWithdrawals > 0 ? '#d97706' : 'var(--text-secondary)';
            }

            // Analytics stats
            const avgEarnings = activeToday > 0 ? totalEarnings / activeToday : 0;
            const totalAdsWatched = users.reduce((sum, user) => sum + (user.adsWatched || 0), 0);
            const completionRate = users.length > 0 ? (users.reduce((sum, user) => sum + (user.completedTasks || 0), 0) / (users.length * 1000)) * 100 : 0;

            if(document.getElementById('activeUsers')) document.getElementById('activeUsers').textContent = activeToday.toLocaleString();
            if(document.getElementById('avgEarnings')) document.getElementById('avgEarnings').textContent = `BDT ${avgEarnings.toFixed(2)}`;
            if(document.getElementById('totalAdsWatched')) document.getElementById('totalAdsWatched').textContent = totalAdsWatched.toLocaleString();
            if(document.getElementById('completionRate')) document.getElementById('completionRate').textContent = `${completionRate.toFixed(1)}%`;
        }
        // Helper to safely parse dates from any format (String, Timestamp, null)
function getSafeDate(dateInput) {
    if (!dateInput) return null;
    
    // Handle Firestore Timestamp objects (seconds/nanoseconds)
    if (dateInput && typeof dateInput === 'object' && dateInput.seconds) {
        return new Date(dateInput.seconds * 1000);
    }
    
    // Handle standard strings/numbers
    const date = new Date(dateInput);
    
    // Check if valid
    if (isNaN(date.getTime())) return null;
    
    return date;
}

        // Update recent activity
        function updateRecentActivity() {
            const recentWithdrawals = withdrawals
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 5);
            
            const container = document.getElementById('recentActivity');
            if (recentWithdrawals.length === 0) {
                container.innerHTML = '<p>No recent activity</p>';
                return;
            }

            let html = '';
            recentWithdrawals.forEach(withdrawal => {
                const date = new Date(withdrawal.timestamp).toLocaleDateString();
                const time = new Date(withdrawal.timestamp).toLocaleTimeString();
                const statusClass = withdrawal.status === 'completed' ? 'status-active' : 
                                   withdrawal.status === 'pending' ? 'status-badge' : 'status-inactive';
                
                html += `
                    <div class="setting-item">
                        <div>
                            <div style="font-weight: 500;">${withdrawal.username || 'User'}</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                ${withdrawal.method} ‚Ä¢ ${date} ${time}
                            </div>
                        </div>
                        <div>
                            <div style="font-weight: 600;">BDT ${withdrawal.amount?.toFixed(2) || '0.00'}</div>
                            <span class="status-badge ${statusClass}" style="font-size: 0.75rem;">
                                ${withdrawal.status || 'pending'}
                            </span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Update top users
        function updateTopUsers() {
            const topUsers = [...users]
                .sort((a, b) => (b.totalEarnings || 0) - (a.totalEarnings || 0))
                .slice(0, 10);
            
            const tbody = document.getElementById('topUsersBody');
            
            if (topUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 1rem;">No users found</td></tr>';
                return;
            }

            let html = '';
            topUsers.forEach((user, index) => {
                html += `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 24px; height: 24px; background: #1A5237; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">
                                    ${index + 1}
                                </div>
                                <div>
                                    <div style="font-weight: 500;">${user.name || user.username || 'Unknown'}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">${user.adsWatched || 0} ads</div>
                                </div>
                            </div>
                        </td>
                        <td style="font-weight: 600;">
                            BDT ${(user.totalEarnings || 0).toFixed(2)}
                        </td>
                        <td style="text-align: right;">
                            ${(user.adsWatched || 0).toLocaleString()}
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // Update users table
        function updateUsersTable() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedUsers = filteredUsers.slice(startIndex, endIndex);
            
            const tbody = document.getElementById('usersTableBody');
            
            if (paginatedUsers.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" style="text-align: center; padding: 2rem;">No users found</td></tr>`;
                return;
            }

            let html = '';
            paginatedUsers.forEach(user => {
                // USE SAFE DATE HERE
                const safeDate = getSafeDate(user.lastUpdated);
                const lastActive = safeDate ? safeDate.toLocaleString() : 'Never';
                    
                const statusClass = user.telegramDetected ? 'status-active' : 'status-inactive';
                const statusText = user.telegramDetected ? 'Active' : 'Inactive';
                
                let avatarHtml;
                if (user.profilePhoto) {
                    avatarHtml = `<img src="${user.profilePhoto}" class="user-avatar" alt="User">`;
                } else {
                    const initial = user.name ? user.name.charAt(0).toUpperCase() : (user.username ? user.username.charAt(0).toUpperCase() : 'U');
                    avatarHtml = `<div class="user-avatar">${initial}</div>`;
                }
                
                // ... inside updateUsersTable loop ...

html += `
    <tr>
        <td style="font-family: monospace; font-size: 0.85rem;">${user.id.substring(0, 8)}...</td>
        <td>
            <div style="display: flex; align-items: center; gap: 10px;">
                ${avatarHtml}
                <div>
                    <div style="font-weight: 500;">${user.name || 'N/A'}</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">
                        ${user.username || 'N/A'}
                    </div>
                </div>
            </div>
        </td>
        <td style="font-family: monospace; font-size: 0.85rem;">${user.id || 'N/A'}</td>
        <td style="font-weight: 600;">BDT ${(user.balance || 0).toFixed(2)}</td>
        <td>BDT ${(user.totalEarnings || 0).toFixed(2)}</td>
        <td>${(user.adsWatched || 0).toLocaleString()}</td>
        
        <td style="text-align: center; font-weight: 500;">
            ${user.country || '-'}
        </td>
        
        <td>${user.source === 'telegram' ? 'Telegram' : 'Web'}</td>
        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
        <td style="font-size: 0.85rem;">${lastActive}</td>
        <td>
            <div class="action-buttons">
                <button class="btn btn-edit" onclick="editUser('${user.id}')">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-delete" onclick="deleteUser('${user.id}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </td>
    </tr>
`;
            });
            
            tbody.innerHTML = html;
            updatePagination();
        }

        // Update withdrawals table
        function updateWithdrawalsTable() {
            const statusFilter = document.getElementById('withdrawalFilter').value;
            let filteredWithdrawals = withdrawals;
            
            if (statusFilter !== 'all') {
                filteredWithdrawals = withdrawals.filter(w => w.status === statusFilter);
            }
            
            const tbody = document.getElementById('withdrawalsTableBody');
            
            if (filteredWithdrawals.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 2rem;">
                            No withdrawal requests found
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            filteredWithdrawals.forEach(withdrawal => {
                const date = new Date(withdrawal.timestamp).toLocaleDateString();
                const statusClass = withdrawal.status === 'completed' ? 'status-active' : 
                                   withdrawal.status === 'pending' ? 'status-badge' : 'status-inactive';
                
                // ... inside the loop in updateWithdrawalsTable ...
                
// ... inside updateWithdrawalsTable loop ...

// 1. DEFINE THE ACCOUNT VALUE HERE
const accountDetail = withdrawal.accountNumber || withdrawal.address || 'N/A';

html += `
    <tr>
        <td style="font-family: monospace; font-size: 0.85rem;">${withdrawal.id.substring(0, 8)}...</td>
        <td>${withdrawal.username || 'N/A'}</td>
        <td style="font-weight: 600;">BDT ${withdrawal.amount?.toFixed(2) || '0.00'}</td>
        <td>${withdrawal.method || 'N/A'}</td>
        
        <td style="font-family: monospace; font-size: 0.85rem;">
            ${accountDetail.substring(0, 20) + (accountDetail.length > 20 ? '...' : '')}
        </td>

        <td style="font-size: 0.85rem;">${date}</td>
        <td><span class="status-badge ${statusClass}">${withdrawal.status || 'pending'}</span></td>
        <td>
            <div class="action-buttons">
                ${withdrawal.status === 'pending' ? `
                <div id="row-btns-${withdrawal.id}" style="display: flex; gap: 8px;">
                    <button class="btn btn-edit" onclick="processWithdrawal('${withdrawal.id}', 'approve')">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-delete" onclick="processWithdrawal('${withdrawal.id}', 'reject')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="row-spinner-${withdrawal.id}" style="display: none; align-items: center; justify-content: center; width: 60px; color: var(--text-secondary);">
                    <i class="fas fa-circle-notch fa-spin"></i>
                </div>
                ` : ''}
                
                <button class="btn" style="background: #dbeafe; color: #1d4ed8;" onclick="viewWithdrawal('${withdrawal.id}')">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
        </td>
    </tr>
`;
            });
            
            tbody.innerHTML = html;
        }

        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages || totalPages === 0;
        }

       // --- NEW: REAL CHART DATA FUNCTIONS ---

        // Helper to get last 7 days labels (e.g., "Mon", "Tue")
        function getLast7DaysLabels() {
            const labels = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                labels.push(d.toLocaleDateString('en-US', { weekday: 'short' }));
            }
            return labels;
        }

        // Helper to check if a date was X days ago
        function isDaysAgo(dateString, daysAgo) {
            if (!dateString) return false;
            const target = new Date();
            target.setDate(target.getDate() - daysAgo);
            const check = new Date(dateString);
            return check.getDate() === target.getDate() && 
                   check.getMonth() === target.getMonth() && 
                   check.getFullYear() === target.getFullYear();
        }

        function initializeCharts() {
            // Destroy existing charts to prevent overlays
            if (charts.userGrowth) charts.userGrowth.destroy();
            if (charts.revenue) charts.revenue.destroy();
            if (charts.source) charts.source.destroy();
            if (charts.activity) charts.activity.destroy();

            // Get contexts
            const userGrowthCtx = document.getElementById('userGrowthChart').getContext('2d');
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            const sourceCtx = document.getElementById('sourceChart').getContext('2d');
            const activityCtx = document.getElementById('activityChart').getContext('2d');

            // --- 1. CALCULATE REAL USER GROWTH (Last 7 Days) ---
            const labels = getLast7DaysLabels();
            const growthData = [];
            
            // Calculate cumulative users for each day
            let runningTotal = 0;
            
            // First, count users who joined BEFORE the last 7 days
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            runningTotal = users.filter(u => {
                const joinDate = getSafeDate(u.joinDate);
                return joinDate && joinDate < sevenDaysAgo;
            }).length;

            // Now add daily growth
            for (let i = 6; i >= 0; i--) {
                const newUsersToday = users.filter(u => {
                    const joinDate = getSafeDate(u.joinDate);
                    return joinDate && isDaysAgo(u.joinDate, i);
                }).length;
                
                runningTotal += newUsersToday;
                growthData.push(runningTotal);
            }

            // --- 2. CALCULATE REAL WITHDRAWALS (Last 7 Days) ---
            // (Note: We show Withdrawals because we don't have an "Earnings History" collection)
            const withdrawalData = [];
            for (let i = 6; i >= 0; i--) {
                const dailyTotal = withdrawals
                    .filter(w => isDaysAgo(w.timestamp, i))
                    .reduce((sum, w) => sum + (w.amount || 0), 0);
                withdrawalData.push(dailyTotal);
            }

            // --- 3. CALCULATE REAL ACTIVITY (Last 7 Days) ---
            const activityData = [];
            for (let i = 6; i >= 0; i--) {
                const activeCount = users.filter(u => {
                    const lastActive = getSafeDate(u.lastUpdated);
                    return lastActive && isDaysAgo(u.lastUpdated, i);
                }).length;
                activityData.push(activeCount);
            }

            // --- 4. SOURCE DISTRIBUTION (Real) ---
            const telegramUsers = users.filter(u => u.source === 'telegram').length;
            const webUsers = users.filter(u => u.source === 'web').length;


            // === RENDER CHARTS ===

            // 1. User Growth Chart
            charts.userGrowth = new Chart(userGrowthCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Users',
                        data: growthData,
                        borderColor: '#1A5237',
                        backgroundColor: 'rgba(26, 82, 55, 0.1)',
                        tension: 0.3,
                        fill: true,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                }
            });

            // 2. Financial Chart (Withdrawals)
            charts.revenue = new Chart(revenueCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Withdrawals (BDT)',
                        data: withdrawalData,
                        backgroundColor: '#3B7A57',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });

            // 3. Source Chart
            charts.source = new Chart(sourceCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Telegram', 'Web'],
                    datasets: [{
                        data: [telegramUsers, webUsers],
                        backgroundColor: ['#1A5237', '#3B7A57'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            // 4. Activity Chart
            charts.activity = new Chart(activityCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Active Users',
                        data: activityData,
                        borderColor: '#FFD700',
                        backgroundColor: 'rgba(255, 215, 0, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                }
            });
        }
        // Edit user with Telegram restrictions
        async function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            document.getElementById('editUserId').value = user.id;
            document.getElementById('editName').value = user.name || '';
            document.getElementById('editUsername').value = user.username || '';
            document.getElementById('editTelegramId').value = user.id || '';
            document.getElementById('editBalance').value = user.balance || 0;
            document.getElementById('editTotalEarnings').value = user.totalEarnings || 0;
            document.getElementById('editAdsWatched').value = user.adsWatched || 0;
            document.getElementById('editCompletedTasks').value = user.completedTasks || 0;
            document.getElementById('editSource').value = user.source || 'web';
            document.getElementById('editTelegramDetected').value = user.telegramDetected ? 'Yes' : 'No';

            // Handle Telegram user restrictions
            const isTelegramUser = user.source === 'telegram' && user.telegramDetected;
            
            if (isTelegramUser) {
                // Disable fields for Telegram users
                document.getElementById('editName').disabled = true;
                document.getElementById('editUsername').disabled = true;
                document.getElementById('editTelegramId').disabled = true;
                document.getElementById('editSource').disabled = true;
                document.getElementById('editTelegramDetected').disabled = true;
                
                // Show info messages
                document.getElementById('nameInfo').style.display = 'block';
                document.getElementById('usernameInfo').style.display = 'block';
            } else {
                // Enable fields for web users
                document.getElementById('editName').disabled = false;
                document.getElementById('editUsername').disabled = false;
                document.getElementById('editTelegramId').disabled = false;
                document.getElementById('editSource').disabled = false;
                document.getElementById('editTelegramDetected').disabled = false;
                
                // Hide info messages
                document.getElementById('nameInfo').style.display = 'none';
                document.getElementById('usernameInfo').style.display = 'none';
            }

            document.getElementById('editUserModal').classList.add('show');
        }

        // Delete user
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }

            try {
                await db.collection(USERS_COLLECTION).doc(userId).delete();
                showToast('User deleted successfully!', 'success');
                await loadUsers();
                await loadDashboardData();
                updateDashboardStats();
                updateTopUsers();
            } catch (error) {
                console.error("Error deleting user:", error);
                showToast('Failed to delete user.', 'error');
            }
        }

        // Process withdrawal - FIXED VERSION (no double deduction)
        // Process withdrawal - FIXED VERSION (Firebase Auth Compatible)
// ==========================================
// WITHDRAWAL PROCESSING LOGIC (FIXED)
// ==========================================

// 1. Global Variable to track which withdrawal we are rejecting
let currentWithdrawalId = null;

// 2. Entry Point: Triggered by Approve/Reject buttons in the table
function processWithdrawal(withdrawalId, action) {
    if (action === 'approve') {
        if(confirm("Are you sure you want to approve this withdrawal?")) {
            executeWithdrawalAction(withdrawalId, 'approve', null);
        }
    } else if (action === 'reject') {
        // Store the ID globally
        currentWithdrawalId = withdrawalId;
        console.log("Selected for rejection:", currentWithdrawalId); // Debugging
        
        // Reset and show modal
        document.getElementById('rejectionReason').value = ""; 
        document.getElementById('rejectReasonModal').classList.add('show');
    }
}

// 3. Triggered by 'Confirm Rejection' button in the Modal
function submitRejection() {
    const reason = document.getElementById('rejectionReason').value.trim();
    
    if (!reason) {
        showToast("Please enter a rejection reason", "error");
        return;
    }

    // CRITICAL FIX: Capture the ID *before* closing the modal
    const idToProcess = currentWithdrawalId;
    
    if (!idToProcess) {
        showToast("Error: Selection lost. Please try again.", "error");
        closeRejectModal();
        return;
    }

    // Now close the modal (which clears the global variable)
    closeRejectModal();
    
    // Execute the action with the captured ID
    executeWithdrawalAction(idToProcess, 'reject', reason);
}

// 4. Helper to Close Modal
function closeRejectModal() {
    document.getElementById('rejectReasonModal').classList.remove('show');
    currentWithdrawalId = null; // Clear the global variable
}

// 5. Main Execution Function (Database & Notifications)
async function executeWithdrawalAction(withdrawalId, action, reason) {
    console.log(`Executing ${action} for ID: ${withdrawalId}`);

    // UI Feedback: Toggle spinners
    const rowBtns = document.getElementById(`row-btns-${withdrawalId}`);
    const rowSpinner = document.getElementById(`row-spinner-${withdrawalId}`);
    if (rowBtns) rowBtns.style.display = 'none';
    if (rowSpinner) rowSpinner.style.display = 'flex';

    try {
        // Double check ID
        if (!withdrawalId) throw new Error('Invalid Withdrawal ID');

        // Find data locally
        const withdrawal = withdrawals.find(w => w.id === withdrawalId);
        if (!withdrawal) throw new Error('Withdrawal data not found. Please refresh page.');

        const newStatus = action === 'approve' ? 'completed' : 'rejected';
        const adminName = currentUser && currentUser.email ? currentUser.email : 'Admin';

        // --- A. Update Firestore Document ---
        await db.collection(WITHDRAWALS_COLLECTION).doc(withdrawalId).update({
            status: newStatus,
            processedAt: new Date().toISOString(),
            processedBy: adminName,
            adminNote: reason || "Processed by Admin"
        });

        // --- B. Refund Balance (If Rejected) ---
        if (action === 'reject' && withdrawal.userId) {
            const userRef = db.collection(USERS_COLLECTION).doc(withdrawal.userId);
            const userDoc = await userRef.get(); // Get fresh data
            
            if (userDoc.exists) {
                const userData = userDoc.data();
                // Ensure we handle numbers correctly
                const currentBalance = parseFloat(userData.balance || 0);
                const refundAmount = parseFloat(withdrawal.amount || 0);
                
                await userRef.update({ 
                    balance: currentBalance + refundAmount,
                    lastUpdated: new Date().toISOString()
                });
                console.log(`Refunded ${refundAmount} to user.`);
            }
        }

        // --- C. Send Notifications ---
        let notifTitle = "";
        let notifMessage = "";

        if (action === 'approve') {
            notifTitle = "Withdrawal Approved ‚úÖ";
            notifMessage = `Your withdrawal of BDT ${withdrawal.amount} has been verified. Payment is currently being processed.`;
        } else {
            notifTitle = "Withdrawal Rejected ‚ùå";
            notifMessage = `Your withdrawal was rejected and funds returned.\n\nReason: ${reason}`;
        }

        await sendPrivateNotification(withdrawal.userId, notifTitle, notifMessage);

        showToast(`Withdrawal ${newStatus} successfully!`, "success");

        // --- D. Cleanup & Refresh ---
        closeWithdrawalModal(); // Close detail modal if open
        
        setTimeout(async () => {
            await loadWithdrawals();
            await loadDashboardData(); // Refresh top stats
            updateDashboardStats();
        }, 1000);

    } catch (error) {
        console.error("Processing Error:", error);
        showToast(error.message, "error");
        
        // Restore buttons if it failed
        if (rowBtns) rowBtns.style.display = 'flex';
        if (rowSpinner) rowSpinner.style.display = 'none';
    }
}

// 6. Notification Sender Helper
async function sendPrivateNotification(userId, title, message) {
    if (!userId) return;

    try {
        // 1. Add to In-App History
        await db.collection('adv2_notifications').add({
            // Only valid if your User App filters by this field. 
            // If not, this will show to everyone. See note below.
            targetUserId: userId, 
            title: title,
            message: message,
            createdAt: new Date().toISOString(),
            type: title.includes('Approved') ? 'success' : 'alert' 
        });

        // 2. Send Telegram Message
        if (TELEGRAM_BOT_TOKEN && /^\d+$/.test(userId)) {
            const telegramMsg = `üîî *${title}*\n\n${message}`;
            
            // Fire and forget (don't await to keep UI fast)
            fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    chat_id: userId,
                    text: telegramMsg,
                    parse_mode: 'Markdown'
                })
            }).catch(e => console.error("Telegram API Error:", e));
        }
    } catch (e) {
        console.error("Notification Error:", e);
    }
}

        // View withdrawal details
        async function viewWithdrawal(withdrawalId) {
            try {
                const withdrawal = withdrawals.find(w => w.id === withdrawalId);
                if (!withdrawal) {
                    showToast('Withdrawal not found!', 'error');
                    return;
                }

                const details = document.getElementById('withdrawalDetails');
                const date = new Date(withdrawal.timestamp).toLocaleString();
                const processedDate = withdrawal.processedAt ? 
                    new Date(withdrawal.processedAt).toLocaleString() : 'Not processed';
                
                // ... inside viewWithdrawal function ...

// 1. DEFINE THE ACCOUNT VALUE HERE
const accountDetail = withdrawal.accountNumber || withdrawal.address || 'N/A';

details.innerHTML = `
    <div class="form-group">
        <label>Withdrawal ID</label>
        <input type="text" value="${withdrawal.id || 'N/A'}" class="form-control" readonly>
    </div>
    
    <div class="form-group">
        <label>User ID</label>
        <input type="text" value="${withdrawal.userId || 'N/A'}" class="form-control" readonly>
    </div>
    
    <div class="form-group">
        <label>Username</label>
        <input type="text" value="${withdrawal.username || 'N/A'}" class="form-control" readonly>
    </div>
    
    <div class="form-group">
        <label>Amount</label>
        <input type="text" value="BDT ${withdrawal.amount?.toFixed(2) || '0.00'}" class="form-control" readonly>
    </div>
    
    <div class="form-group">
        <label>Method</label>
        <input type="text" value="${withdrawal.method || 'N/A'}" class="form-control" readonly>
    </div>
    
    <div class="form-group">
        <label>Account Number / Email</label>
        <textarea class="form-control" rows="2" readonly>${accountDetail}</textarea>
    </div>
    
    <div class="form-group">
        <label>Requested At</label>
        <input type="text" value="${date}" class="form-control" readonly>
    </div>
    
    <div class="form-group">
        <label>Status</label>
        <input type="text" value="${withdrawal.status || 'pending'}" class="form-control" readonly>
    </div>
    
    ${withdrawal.status === 'pending' ? `
    <div id="modal-btns-${withdrawalId}" style="display: flex; gap: 1rem; margin-top: 1.5rem;">
        <button class="btn-primary" style="flex: 1; background: #1A5237;" onclick="processWithdrawal('${withdrawalId}', 'approve')">
            <i class="fas fa-check mr-2"></i> Approve
        </button>
        <button class="btn-primary" style="flex: 1; background: #dc2626;" onclick="processWithdrawal('${withdrawalId}', 'reject')">
            <i class="fas fa-times mr-2"></i> Reject
        </button>
    </div>
    ` : ''}
`;

                document.getElementById('withdrawalModal').classList.add('show');
            } catch (error) {
                console.error("Error viewing withdrawal:", error);
                showToast('Failed to load withdrawal details.', 'error');
            }
        }

        // Close modals
        function closeEditUserModal() {
            document.getElementById('editUserModal').classList.remove('show');
            // Re-enable all fields
            document.getElementById('editName').disabled = false;
            document.getElementById('editUsername').disabled = false;
            document.getElementById('editTelegramId').disabled = false;
            document.getElementById('editSource').disabled = false;
            document.getElementById('editTelegramDetected').disabled = false;
        }

        function closeWithdrawalModal() {
            document.getElementById('withdrawalModal').classList.remove('show');
        }

        // Show alert
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const title = type === 'success' ? 'Success!' : 
                         type === 'error' ? 'Error!' : 
                         type === 'info' ? 'Info' : 'Notification';
            
            toast.innerHTML = `
                <div class="toast-title">${title}</div>
                <div class="toast-message">${message}</div>
            `;
            
            container.appendChild(toast);
            
            // Show toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        // Export users data
        function exportUsersData() {
            if (users.length === 0) {
                showToast("No users to export", "error");
                return;
            }

            const headers = ["ID", "Name", "Username", "Telegram ID", "Balance", "Earnings", "Ads Watched", "Completed Tasks", "Source", "Telegram Detected", "Last Updated"];
            
            const csvData = users.map(user => [
                user.id,
                user.name || "",
                user.username || "",
                user.id || "",
                user.balance || 0,
                user.totalEarnings || 0,
                user.adsWatched || 0,
                user.completedTasks || 0,
                user.source || "web",
                user.telegramDetected ? "Yes" : "No",
                user.lastUpdated || "Never"
            ]);

            const csvContent = [
                headers.join(","),
                ...csvData.map(row => row.map(cell => `"${cell}"`).join(","))
            ].join("\n");

            const blob = new Blob([csvContent], { type: "text/csv" });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `advault_users_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showToast("Users data exported successfully!", "success");
        }

        // Auto-save settings when changed
        function setupAutoSaveListeners() {
            // Get all setting inputs
            const settingInputs = document.querySelectorAll('[data-setting]');
            
            settingInputs.forEach(input => {
                // Remove existing listeners to avoid duplicates
                const newInput = input.cloneNode(true);
                input.parentNode.replaceChild(newInput, input);
                
                // Add change listener
                newInput.addEventListener('change', function() {
                    const settingCard = this.closest('.setting-card');
                    if (settingCard) {
                        // Add visual feedback
                        settingCard.classList.add('settings-changed');
                        
                        // Remove feedback after 1 second
                        setTimeout(() => {
                            settingCard.classList.remove('settings-changed');
                        }, 1000);
                    }
                });
            });
        }

        // ============================================
        // CONTENT & ADS MANAGEMENT FUNCTIONS
        // ============================================

        // Marquee Management
        async function addMarquee() {
            const country = document.getElementById('mqCountry').value.toUpperCase() || 'default';
            const text = document.getElementById('mqText').value.trim();
            
            if (!text) {
                showToast('Please enter marquee text', 'error');
                return;
            }

            contentSettings.marqueeSettings[country] = text;
            await saveContentSettings();
            
            // Clear inputs
            document.getElementById('mqCountry').value = '';
            document.getElementById('mqText').value = '';
            
            renderMarqueeList();
        }

        async function deleteMarquee(country) {
            if (!confirm('Are you sure you want to delete this marquee?')) {
                return;
            }
            
            delete contentSettings.marqueeSettings[country];
            await saveContentSettings();
            renderMarqueeList();
        }

        function renderMarqueeList() {
            const list = document.getElementById('marqueeList');
            
            const marquees = Object.entries(contentSettings.marqueeSettings);
            
            if (marquees.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 1rem;">No marquees added yet</p>';
                return;
            }

            let html = '';
            marquees.forEach(([country, text]) => {
                html += `
                    <div class="list-item">
                        <div>
                            <span class="country-badge">${country}</span>
                            <span>${text}</span>
                        </div>
                        <button onclick="deleteMarquee('${country}')" class="btn btn-delete" style="padding: 4px 8px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }
// --- NEW HELPER: Auto-Update Icon based on Type ---
function updatePmIcon() {
    const type = document.getElementById('pmType').value;
    const iconInput = document.getElementById('pmIcon');
    
    if (type === 'number') {
        iconInput.value = 'fas fa-mobile-alt'; // Mobile Icon
    } else if (type === 'email') {
        iconInput.value = 'fas fa-credit-card'; // Card Icon (as requested)
    } else {
        iconInput.value = 'fas fa-wallet'; // Wallet Icon
    }
}
        // Payment Methods Management
        async function addPaymentMethod() {
    const name = document.getElementById('pmName').value.trim();
    const type = document.getElementById('pmType').value;
    // NEW: Get values from new inputs
    const icon = document.getElementById('pmIcon').value.trim() || 'fas fa-wallet';
    const color = document.getElementById('pmColor').value.trim() || '#10b981';
    const minWithdraw = parseFloat(document.getElementById('pmMin').value) || 100;
    
    if (!name) {
        showToast('Please enter payment method name', 'error');
        return;
    }

    const id = name.toLowerCase().replace(/\s+/g, '_');
    
    // Check if already exists
    const exists = contentSettings.paymentMethods.some(pm => pm.id === id);
    if (exists) {
        showToast('Payment method already exists', 'error');
        return;
    }

    // Save full object structure
    contentSettings.paymentMethods.push({ id, name, type, icon, color, minWithdraw });
    await saveContentSettings();
    
    // Clear inputs & Reset Icon
    document.getElementById('pmName').value = '';
    document.getElementById('pmColor').value = '';
    updatePmIcon(); // Reset icon to default based on current selection
    
    renderPaymentMethodList();
}

async function deletePaymentMethod(idx) {
            if (!confirm('Are you sure you want to delete this payment method?')) {
                return;
            }
            
            // Remove from array
            contentSettings.paymentMethods.splice(idx, 1);
            
            // Save to database
            await saveContentSettings();
            
            // Refresh list
            renderPaymentMethodList();
        }
        function renderPaymentMethodList() {
            const list = document.getElementById('paymentMethodList');
            
            if (contentSettings.paymentMethods.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 1rem;">No payment methods added yet</p>';
                return;
            }

            let html = '';
            contentSettings.paymentMethods.forEach((pm, idx) => {
                const typeBadge = pm.type === 'email' ? 'Email' : 
                                pm.type === 'number' ? 'Phone' : 'Text';
                
                html += `
                    <div class="list-item">
                        <div>
                            <span style="font-weight: 600;">${pm.name}</span>
                            <span class="badge ml-2">${typeBadge}</span>
                        </div>
                        <button onclick="deletePaymentMethod(${idx})" class="btn btn-delete" style="padding: 4px 8px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }

       async function addAdService() {
    const name = document.getElementById('adName').value.trim();
    const type = document.getElementById('adType').value;
    const code = document.getElementById('adCode').value.trim();
    const reward = parseFloat(document.getElementById('adReward').value) || 0.10;
    // NEW VALUE
    const duration = parseInt(document.getElementById('adDurationInput').value) || 30;
    
    if (!name || !code) {
        showToast('Please fill all fields', 'error');
        return;
    }

    contentSettings.adServices.push({ 
        id: Date.now().toString(), 
        name, 
        type, 
        code, 
        reward,
        duration, // Save duration
        active: true 
    });
    
    await saveContentSettings();
    
    // Clear inputs
    document.getElementById('adName').value = '';
    document.getElementById('adCode').value = '';
    document.getElementById('adReward').value = '';
    
    renderAdServiceList();
}

        async function toggleAdService(idx) {
            contentSettings.adServices[idx].active = !contentSettings.adServices[idx].active;
            await saveContentSettings();
            renderAdServiceList();
        }

        async function deleteAdService(idx) {
            if (!confirm('Are you sure you want to delete this ad service?')) {
                return;
            }
            
            contentSettings.adServices.splice(idx, 1);
            await saveContentSettings();
            renderAdServiceList();
        }

        function renderAdServiceList() {
    const list = document.getElementById('adServiceList');
    
    // THE GUARD: MUST BE AT THE VERY TOP
    if (!list) return; 

    if (!contentSettings.adServices || contentSettings.adServices.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 1rem;">No ad services added yet</p>';
        return;
    }

    let html = '';
    contentSettings.adServices.forEach((ad, idx) => {
        const icon = ad.type === 'smartlink' ? 'fa-link' : 'fa-image';
        const opacityClass = ad.active ? 'ad-active' : 'ad-inactive';
        const toggleClass = ad.active ? 'active' : 'inactive';
        const toggleIcon = ad.active ? 'fa-power-off' : 'fa-power-off';
        const toggleColor = ad.active ? '#10b981' : '#9ca3af';
        const rewardDisplay = ad.reward ? `${parseFloat(ad.reward).toFixed(2)} BDT` : '0.10 BDT';
        
        html += `
            <div class="list-item ${opacityClass}">
                <div style="display: flex; align-items: center; gap: 12px; overflow: hidden;">
                    <div class="ad-icon" style="flex-shrink: 0;"><i class="fas ${icon}"></i></div>
                    <div style="min-width: 0;">
                        <div style="font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${ad.name}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); display: flex; gap: 8px;">
                            <span style="text-transform: uppercase;">${ad.type}</span>
                            <span style="color: #10b981; font-weight: 600;">‚Ä¢ ${rewardDisplay}</span>
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 8px; flex-shrink: 0;">
                    <button onclick="toggleAdService(${idx})" class="toggle-ad-btn ${toggleClass}" style="color: ${toggleColor};"><i class="fas ${toggleIcon}"></i></button>
                    <button onclick="deleteAdService(${idx})" class="btn btn-delete" style="padding: 4px 8px;"><i class="fas fa-trash"></i></button>
                </div>
            </div>
        `;
    });
    list.innerHTML = html;
}
        // Event Listeners
        // Event Listeners
document.addEventListener('DOMContentLoaded', async () => {
    
    // 1. Check for Telegram Auto-Login first
    await checkTelegramAutoLogin();
    
    // REMOVED: checkLogin(); 
    // Reason: auth.onAuthStateChanged now handles this automatically.

    // 2. Navigation Logic
    // Optimized Navigation Logic
document.querySelectorAll('.nav-item').forEach(item => {
    item.addEventListener('click', (e) => {
        e.preventDefault();
        const section = item.dataset.section;
        
        if (section === 'logout') {
            logout();
            return;
        }
        
        // 1. Update Active State
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        
        // 2. Sidebar Management: Force close on mobile
        document.getElementById('sidebar').classList.remove('active');
        document.getElementById('sidebarOverlay').classList.remove('active');
        
        // 3. UI Titles
        const titles = {
            dashboard: 'Dashboard', analytics: 'Analytics', users: 'Users',
            withdrawals: 'Withdrawals', notifications: 'Notifications',
            content: 'Content', ads: 'Ads Manager', settings: 'Settings'
        };
        document.getElementById('pageTitle').textContent = titles[section] || 'Admin';

        // 4. Section Switching
        document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
        const target = document.getElementById(`${section}Section`);
        if (target) target.style.display = 'block';

        // 5. Safe Rendering: Prevents "innerHTML of null" errors
        setTimeout(() => {
            if (section === 'ads') {
                if(typeof renderSmartLinkList === 'function') renderSmartLinkList();
                if(typeof renderAdServiceList === 'function') renderAdServiceList();
            }
            if (section === 'notifications') loadNotifications();
            if (section === 'content') {
                renderMarqueeList();
                renderPaymentMethodList();
            }
            if (section === 'settings') setupAutoSaveListeners();
        }, 60); // 60ms delay ensures DOM is painted
   
// MERGED AND OPTIMIZED ADS SECTION
if (section === 'ads') {
    // Small delay ensures the browser has rendered the hidden section
    setTimeout(() => {
        renderSmartLinkList();
        renderAdServiceList(); // Make sure this is also called here
    }, 50);
}
        });
    });

    // 3. Theme toggle listeners
    document.getElementById('themeToggle').addEventListener('click', () => toggleTheme());
    document.getElementById('mobileThemeToggle').addEventListener('click', () => toggleTheme());

    // Theme toggle function
    function toggleTheme() {
        const currentTheme = document.body.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        document.body.setAttribute('data-theme', newTheme);
        
        // Update icons
        const desktopIcon = document.querySelector('#themeToggle i');
        if (desktopIcon) desktopIcon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        
        const mobileIcon = document.querySelector('#mobileThemeToggle i');
        if (mobileIcon) mobileIcon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        
        localStorage.setItem('adminTheme', newTheme);
        
        if (charts.userGrowth) initializeCharts();
    }

    // 4. Mobile menu toggle
    document.getElementById('menuToggle').addEventListener('click', () => {
        document.getElementById('sidebar').classList.add('active');
        document.getElementById('sidebarOverlay').classList.add('active');
    });

    document.getElementById('sidebarOverlay').addEventListener('click', () => {
        document.getElementById('sidebar').classList.remove('active');
        document.getElementById('sidebarOverlay').classList.remove('active');
    });

    // 5. Search & Filters
    document.getElementById('userSearch').addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        filteredUsers = users.filter(user => 
            (user.name && user.name.toLowerCase().includes(searchTerm)) ||
            (user.username && user.username.toLowerCase().includes(searchTerm)) ||
            (user.id && user.id.toLowerCase().includes(searchTerm))
        );
        currentPage = 1;
        updateUsersTable();
    });

    document.getElementById('withdrawalFilter').addEventListener('change', updateWithdrawalsTable);

    // 6. Pagination
    document.getElementById('prevPage').addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            updateUsersTable();
        }
    });

    document.getElementById('nextPage').addEventListener('click', () => {
        const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            updateUsersTable();
        }
    });

    // 7. Edit User Form Submit
    document.getElementById('editUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const userId = document.getElementById('editUserId').value;
        const user = users.find(u => u.id === userId);
        const isTelegramUser = user && user.source === 'telegram' && user.telegramDetected;
        
        const updates = {
            balance: parseFloat(document.getElementById('editBalance').value),
            totalEarnings: parseFloat(document.getElementById('editTotalEarnings').value),
            adsWatched: parseInt(document.getElementById('editAdsWatched').value),
            completedTasks: parseInt(document.getElementById('editCompletedTasks').value),
            lastUpdated: new Date().toISOString()
        };

        if (!isTelegramUser) {
            updates.name = document.getElementById('editName').value;
            updates.username = document.getElementById('editUsername').value;
            updates.source = document.getElementById('editSource').value;
            updates.telegramDetected = document.getElementById('editTelegramDetected').value === 'Yes';
        }

        try {
            await db.collection(USERS_COLLECTION).doc(userId).update(updates);
            showToast('User updated successfully!', 'success');
            closeEditUserModal();
            await loadUsers();
            await loadDashboardData();
            updateDashboardStats();
            updateTopUsers();
        } catch (error) {
            console.error("Error updating user:", error);
            showToast('Failed to update user.', 'error');
        }
    });

    // 8. Enter Key for Login
    document.getElementById('adminPassword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('loginBtn').click();
        }
    });

    // 9. Add "Save All" Button
    const saveAllBtn = document.createElement('button');
    saveAllBtn.className = 'save-settings-btn';
    saveAllBtn.innerHTML = '<i class="fas fa-save"></i> Save All Settings';
    saveAllBtn.style.marginTop = '2rem';
    saveAllBtn.style.width = '100%';
    saveAllBtn.onclick = () => saveSettings('all');
    
    const settingsSection = document.getElementById('settingsSection');
    if (settingsSection) settingsSection.appendChild(saveAllBtn);

    // 10. Load Saved Theme
    const savedTheme = localStorage.getItem('adminTheme') || 'light';
    document.body.setAttribute('data-theme', savedTheme);
    
    const desktopIcon = document.querySelector('#themeToggle i');
    if (desktopIcon) desktopIcon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
    
    const mobileIcon = document.querySelector('#mobileThemeToggle i');
    if (mobileIcon) mobileIcon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';

    // 11. Auto-refresh Interval
    setInterval(async () => {
        if (adminLoggedIn) {
            await loadDashboardData();
            updateDashboardStats();
            updateRecentActivity();
            updateTopUsers();
            if (charts.userGrowth) initializeCharts();
        }
    }, 60000);
});
// Save Banners
async function saveBannerGroup() {
    const bannerData = {
        home: document.getElementById('script_home').value.trim(),
        earn: document.getElementById('script_earn').value.trim(),
        game: document.getElementById('script_game').value.trim(),
        profile: document.getElementById('script_profile').value.trim(),
        active: true // Or link to the toggle button state
    };
    
    await db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID).set({
        bannerAds: bannerData
    }, { merge: true });
    showToast('All Banners saved successfully!', 'success');
}

// Save Native
async function saveNativeAd() {
    const code = document.getElementById('script_native').value.trim();
    await db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID).set({
        nativeAd: { code: code, active: true }
    }, { merge: true });
    showToast('Native Ad saved!', 'success');
}

// Logic for Smartlinks (Modified version of your old addAdService)
async function addSmartLink() {
    const name = document.getElementById('adName').value.trim();
    const code = document.getElementById('adCode').value.trim();
    const reward = parseFloat(document.getElementById('adReward').value) || 0;
    const duration = parseInt(document.getElementById('adDurationInput').value) || 30;

    if (!name || !code) return showToast('Fill all fields', 'error');

    const newTask = { id: Date.now().toString(), name, code, reward, duration, active: true };
    
    // Assuming you store smartlinks in the adServices array
    contentSettings.adServices = contentSettings.adServices.filter(a => a.type === 'smartlink'); // Cleanup old types
    contentSettings.adServices.push({ ...newTask, type: 'smartlink' });
    
    await saveContentSettings();
    renderSmartLinkList();
    
    // Reset inputs
    document.getElementById('adName').value = '';
    document.getElementById('adCode').value = '';
}

function renderSmartLinkList() {
    const list = document.getElementById('smartLinkList');
    
    // 1. Guard against missing HTML element
    if (!list) return; 

    // 2. Guard against adServices not being initialized yet
    if (!contentSettings.adServices) {
        contentSettings.adServices = [];
    }

    const links = contentSettings.adServices.filter(a => a.type === 'smartlink');
    
    if (links.length === 0) {
        list.innerHTML = '<div class="p-4 text-center text-gray-400 bg-gray-50 rounded-lg border border-dashed border-gray-200">No tasks added yet</div>';
        return;
    }

    let html = '';
    links.forEach((ad, idx) => {
        // Find the index in the original array to delete correctly
        const originalIndex = contentSettings.adServices.findIndex(item => item.id === ad.id);
        
        html += `
            <div class="list-item border-l-4 border-amber-400 bg-white shadow-sm p-3 mb-2 rounded-r-lg flex justify-between items-center border border-gray-100">
                <div class="flex-1">
                    <div class="font-bold text-gray-800">${ad.name}</div>
                    <div class="text-xs text-gray-500 font-medium">
                        <span class="text-emerald-600">${ad.reward} BDT</span> ‚Ä¢ 
                        <span class="text-blue-600">${ad.duration}s Wait</span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="deleteAdService(${originalIndex})" class="btn bg-red-50 text-red-500 hover:bg-red-500 hover:text-white transition-all p-2 rounded-lg">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>`;
    });
    list.innerHTML = html;
}

async function toggleAdGroup(type) {
    const btn = event.target;
    let isActive = btn.textContent.trim() === 'ON';
    
    // Toggle state
    isActive = !isActive;
    btn.textContent = isActive ? 'ON' : 'OFF';
    btn.className = isActive ? 'btn p-1 px-3 rounded-full bg-emerald-100 text-emerald-700' : 'btn p-1 px-3 rounded-full bg-red-100 text-red-700';

    // Save to Database
    const field = type === 'banners' ? 'bannerAds' : 'nativeAd';
    await db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID).set({
        [field]: { active: isActive }
    }, { merge: true });

    showToast(`${type} status updated!`, 'info');
}
    </script>
</body>
</html>
