<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdVault Admin Panel</title>
    
    <!-- Firestore SDK only -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --color-primary: #1A5237;
            --color-secondary: #3B7A57;
            --color-accent: #FFD700;
            --color-success: #28a745;
            --color-danger: #dc2626;
            --color-warning: #f59e0b;
            --color-info: #3b82f6;
            --sidebar-width: 280px;
            --header-height: 80px;
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-card: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border-color: #475569;
        }

        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --border-color: #e2e8f0;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: all 0.3s ease;
            min-height: 100vh;
        }

        /* Loading Screen */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--border-color);
            border-top: 5px solid var(--color-info);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--bg-secondary);
            position: fixed;
            left: 0;
            top: 0;
            border-right: 1px solid var(--border-color);
            padding: 1.5rem 1rem;
            overflow-y: auto;
            transition: transform 0.3s ease;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #1A5237, #3B7A57);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .nav-links {
            list-style: none;
            margin-bottom: 1rem;
            flex: 1;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        /* UPDATED NAV STYLES FOR DIVS */
.nav-link-item {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 12px 16px;
    text-decoration: none;
    color: var(--text-secondary);
    border-radius: 10px;
    font-weight: 500;
    transition: all 0.3s;
    cursor: pointer; /* Ensure it looks clickable */
    
    /* Disable Selection & Long Press Highlight */
    -webkit-tap-highlight-color: transparent;
    user-select: none;
    -webkit-user-select: none;
}

.nav-item:hover .nav-link-item {
    background: var(--bg-card);
    color: var(--text-primary);
}

.nav-item.active .nav-link-item {
    background: linear-gradient(135deg, #1A5237, #3B7A57);
    color: white;
    box-shadow: 0 4px 12px rgba(26, 82, 55, 0.3);
}

.nav-link-item i {
    width: 20px;
    text-align: center;
}
        .sidebar-footer {
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        /* Mobile Admin Info in Sidebar */
        .mobile-admin-info {
            display: none;
            padding: 1rem;
            background: var(--bg-card);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }

        .mobile-admin-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #1A5237, #3B7A57);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 0.5rem;
        }

        /* Main Content */
        .main-content {
            margin-left: var(--sidebar-width);
            padding: calc(var(--header-height) + 1rem) 2rem 2rem 2rem;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }

        /* Fixed Header */
        .fixed-header {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            height: var(--header-height);
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            padding: 0 1rem;
            z-index: 99;
            transition: left 0.3s ease;
            gap: 1rem;
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            gap: 1rem;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
            flex: 1;
            min-width: 0;
        }

        .header-left-text {
            min-width: 0;
        }

        .header-left h1 {
            font-size: 1.25rem;
            font-weight: 700;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .header-left p {
            color: var(--text-secondary);
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.2;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-shrink: 0;
        }

        .theme-toggle {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.3s;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .desktop-admin-info {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 6px 12px;
            background: var(--bg-card);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .desktop-admin-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #1A5237, #3B7A57);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            flex-shrink: 0;
        }

        .desktop-admin-info-text {
            display: flex;
            flex-direction: column;
        }

        .desktop-admin-info-text div:first-child {
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .desktop-admin-info-text div:last-child {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            transition: transform 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .icon-users { background: #dbeafe; color: #1d4ed8; }
        .icon-balance { background: #dcfce7; color: #166534; }
        .icon-earnings { background: #fef3c7; color: #92400e; }
        .icon-withdrawals { background: #fee2e2; color: #991b1b; }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* Charts Container - Fixed Height */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(min(100%, 400px), 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .chart-card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            height: 350px; /* Fixed height for charts */
            position: relative;
        }

        .chart-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-primary);
        }

        .chart-wrapper {
            position: relative;
            height: calc(100% - 2rem);
            width: 100%;
        }

        /* Users Table */
        .users-table-container {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .search-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            width: 300px;
            max-width: 100%;
        }

        .search-box input {
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            width: 100%;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th {
            text-align: left;
            padding: 12px 16px;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        tr:hover {
            background: var(--bg-secondary);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            background: linear-gradient(135deg, #1A5237, #3B7A57);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-active { background: #dcfce7; color: #166534; }
        .status-inactive { background: #fee2e2; color: #991b1b; }

        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn {
            padding: 6px 12px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .btn-edit {
            background: #dbeafe;
            color: #1d4ed8;
        }

        .btn-edit:hover {
            background: #bfdbfe;
        }

        .btn-delete {
            background: #fee2e2;
            color: #dc2626;
        }

        .btn-delete:hover {
            background: #fecaca;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 2rem;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--border-color);
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .form-control {
            width: 100%;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .form-control:disabled {
            background: var(--bg-primary);
            color: var(--text-secondary);
            cursor: not-allowed;
        }

        .form-control:focus {
            outline: none;
            border-color: #3B7A57;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1A5237, #3B7A57);
            color: white;
            padding: 10px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 1rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 82, 55, 0.3);
        }

        /* Mobile Menu Toggle */
        .menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-primary);
            cursor: pointer;
            flex-shrink: 0;
            width: 40px;
            height: 40px;
            align-items: center;
            justify-content: center;
        }

        /* Mobile theme toggle in menu */
        .mobile-theme-toggle {
            display: none;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            margin: 0.5rem 0;
            cursor: pointer;
            transition: all 0.3s;
            align-items: center;
            justify-content: space-between;
        }

        .mobile-theme-toggle:hover {
            background: var(--bg-secondary);
        }

        .mobile-theme-toggle span {
            font-weight: 500;
            color: var(--text-primary);
        }

        /* Analytics Top Users Table - Mobile Optimized */
        .top-users-container {
            width: 100%;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .top-users-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 350px; /* Minimum width for small screens */
        }

        .top-users-table th {
            text-align: left;
            padding: 12px 8px;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem;
            white-space: nowrap;
        }

        .top-users-table td {
            padding: 12px 8px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            white-space: nowrap;
        }

        .top-users-table tr:hover {
            background: var(--bg-secondary);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                z-index: 101;
            }
            
            .sidebar.active {
                transform: translateX(0);
            }
            
            .fixed-header {
                left: 0;
                padding: 0 1rem;
            }
            
            .main-content {
                margin-left: 0;
                padding: calc(var(--header-height) + 1rem) 1rem 1rem 1rem;
            }
            
            .menu-toggle {
                display: flex;
            }
            
            .chart-card {
                height: 300px;
            }
            
            .header-left-text h1 {
                font-size: 1.1rem;
            }
            
            .header-left-text p {
                font-size: 0.8rem;
            }
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .search-box {
                width: 100%;
            }
            
            .table-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .fixed-header {
                padding: 0 0.75rem;
            }
            
            .chart-card {
                height: 280px;
                padding: 1rem;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .header-right {
                gap: 0.5rem;
            }
            
            .desktop-admin-info {
                padding: 4px 8px;
            }
            
            .desktop-admin-info-text div:first-child {
                font-size: 0.85rem;
            }
            
            .desktop-admin-info-text div:last-child {
                font-size: 0.7rem;
            }
        }

        /* Mobile Styles (phones) */
        @media (max-width: 640px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .fixed-header {
                justify-content: space-between;
                padding: 0 0.5rem;
            }
            
            .header-left-text {
                display: none; /* Hide title on mobile */
            }
            
            .desktop-admin-info {
                display: none; /* Hide admin info from header on mobile */
            }
            
            .mobile-admin-info {
                display: block; /* Show mobile admin info in sidebar */
            }
            
            .mobile-theme-toggle {
                display: flex; /* Show theme toggle in sidebar on mobile */
            }
            
            .header-right .theme-toggle {
                display: none; /* Hide theme toggle from header on mobile */
            }
            
            .chart-card {
                height: 250px;
            }
            
            /* Optimize top users table for mobile */
            .top-users-table th,
            .top-users-table td {
                padding: 8px 6px;
                font-size: 0.8rem;
            }
            
            .top-users-table th:nth-child(3),
            .top-users-table td:nth-child(3) {
                text-align: right;
            }
        }

        @media (max-width: 480px) {
            .fixed-header {
                height: 60px; /* Smaller header on mobile */
                justify-content: space-between;
            }
            
            .main-content {
                padding: calc(60px + 1rem) 0.5rem 0.5rem 0.5rem;
            }
            
            .header-left-text h1 {
                font-size: 1rem;
            }
            
            .header-left-text p {
                font-size: 0.75rem;
            }
            
            .theme-toggle, .menu-toggle {
                width: 36px;
                height: 36px;
                padding: 6px;
                font-size: 1.25rem;
            }
            
            .desktop-admin-avatar {
                width: 32px;
                height: 32px;
                font-size: 0.9rem;
            }
            
            .chart-card {
                padding: 0.75rem;
                height: 220px;
            }
            
            .stat-card {
                padding: 1rem;
            }
            
            .stat-value {
                font-size: 1.5rem;
            }
            
            .stat-icon {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }
            
            /* Further optimize top users table */
            .top-users-table {
                min-width: 300px;
            }
            
            .top-users-table th,
            .top-users-table td {
                padding: 6px 4px;
                font-size: 0.75rem;
            }
        }

        /* Settings Page */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .setting-card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #1A5237;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 0.5rem;
            margin-top: 2rem;
        }

        .page-btn {
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.3s;
        }

        .page-btn:hover:not(:disabled) {
            background: var(--bg-card);
        }

        .page-btn.active {
            background: #1A5237;
            color: white;
            border-color: #1A5237;
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Alert */
        .alert {
            padding: 1rem;
            border-radius: 10px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #86efac;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }

        /* Login Screen */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #1A5237, #3B7A57);
        }

        .login-box {
            background: white;
            padding: 2.5rem;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }

        .login-title {
            text-align: center;
            margin-bottom: 2rem;
            color: #1A5237;
        }

        .login-input {
            width: 100%;
            padding: 12px 16px;
            margin-bottom: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .login-input:focus {
            outline: none;
            border-color: #1A5237;
        }

        .login-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #1A5237, #3B7A57);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 82, 55, 0.3);
        }

        .login-error {
            color: #dc2626;
            font-size: 0.9rem;
            margin-top: 0.5rem;
            text-align: center;
        }

        /* Forgot Password */
        .forgot-password-link {
            text-align: center;
            margin-top: 1rem;
            color: #3b82f6;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .forgot-password-link:hover {
            text-decoration: underline;
        }

        .back-to-login {
            text-align: center;
            margin-top: 1rem;
            color: #64748b;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .back-to-login:hover {
            text-decoration: underline;
        }

        /* Field Disabled Info */
        .field-info {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            font-style: italic;
        }

        /* Overlay for mobile */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 99;
            display: none;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 1rem 1.5rem;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 9999;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            max-width: 300px;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast-success {
            border-left: 4px solid #10b981;
        }

        .toast-error {
            border-left: 4px solid #ef4444;
        }

        .toast-info {
            border-left: 4px solid #3b82f6;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .toast-message {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        /* Save Settings Button */
        .save-settings-btn {
            background: linear-gradient(135deg, #1A5237, #3B7A57);
            color: white;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .save-settings-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(26, 82, 55, 0.3);
        }

        .save-settings-btn i {
            font-size: 1rem;
        }

        /* Settings Changed Indicator */
        .settings-changed {
            border: 2px solid #3b82f6 !important;
        }

        .save-indicator {
            font-size: 0.8rem;
            color: #3b82f6;
            margin-top: 0.5rem;
            display: none;
        }

        /* Content Management Styles */
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-secondary);
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 8px;
            border: 1px solid var(--border-color);
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            background: #e2e8f0;
            color: var(--text-primary);
        }

        .grid-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

      /* Content Section Specific - FIXED */
.content-grid {
    display: grid;
    /* Changed 400px to 280px to fit on mobile screens */
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
}
        .content-card {
            background: var(--bg-card);
            border-radius: 15px;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
        }

        /* Marquee Country Badge */
        .country-badge {
            padding: 4px 10px;
            background: linear-gradient(135deg, #1A5237, #3B7A57);
            color: white;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.8rem;
            margin-right: 8px;
        }

        /* Ad Service Status */
        .ad-active {
            opacity: 1;
        }

        .ad-inactive {
            opacity: 0.5;
        }

        .toggle-ad-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .toggle-ad-btn.active {
            color: #10b981;
        }

        .toggle-ad-btn.inactive {
            color: #9ca3af;
        }

        .ad-icon {
            background: #f3f4f6;
            padding: 10px;
            border-radius: 8px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Premium Color Swatches */
.color-swatches {
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
    margin-top: 12px;
    padding: 4px;
}

.color-swatch {
    width: 32px; 
    height: 32px; 
    border-radius: 50%; 
    cursor: pointer; 
    border: 2px solid white; 
    box-shadow: 0 0 0 2px #e2e8f0; /* Default ring */
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
}

.color-swatch:hover { 
    transform: scale(1.15); 
    box-shadow: 0 0 0 2px #94a3b8; 
}

/* Custom "Rainbow" Picker Button */
.custom-color-btn {
    width: 32px; height: 32px; 
    border-radius: 50%; 
    background: conic-gradient(red, orange, yellow, green, blue, indigo, violet, red);
    border: 2px solid white;
    box-shadow: 0 0 0 2px #e2e8f0;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer;
    position: relative;
    transition: transform 0.2s;
}
.custom-color-btn:active { transform: scale(0.95); }

/* Invisible Native Input sitting on top of the rainbow button */
.custom-color-btn input[type="color"] {
    position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%; padding: 0;
}
    </style>
</head>
<body data-theme="light">
    
    <!-- Login Screen -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <h2 class="login-title" style="font-size: 1.75rem; font-weight: 700;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin-bottom: 10px;">
                    <div class="logo-icon">AV</div>
                    AdVault Admin
                </div>
            </h2>
            <p style="text-align: center; color: #64748b; margin-bottom: 2rem;">
                Enter admin credentials to access the panel
            </p>
            

<div id="loginForm">
    <input type="email" id="adminEmail" class="login-input" placeholder="Admin Email Address">
    <input type="password" id="adminPassword" class="login-input" placeholder="Password">
    <div id="loginError" class="login-error"></div>
    <button id="loginBtn" class="login-btn">Login</button>
    <div class="forgot-password-link" id="showForgotPassword">Forgot Password?</div>
</div>

<div id="forgotPasswordForm" style="display: none;">
    <h3 style="text-align: center; margin-bottom: 1rem; color: #1A5237;">Reset Password</h3>
    <p style="font-size: 0.9rem; color: #64748b; text-align: center; margin-bottom: 1rem;">
        Enter your admin email. We will send you a password reset link.
    </p>
    <input type="email" id="resetEmail" class="login-input" placeholder="Enter Admin Email">
    <div id="recoveryError" class="login-error"></div>
    <div id="recoverySuccess" style="color: #10b981; font-size: 0.9rem; text-align: center; margin-top: 0.5rem; display: none;"></div>
    
    <button id="recoverBtn" class="login-btn">Send Reset Link</button>
    <div class="back-to-login" id="backToLogin">Back to Login</div>
</div>
            <div id="forgotPasswordForm" style="display: none;">
                <h3 style="text-align: center; margin-bottom: 1rem; color: #1A5237;">Recover Password</h3>
                <select id="securityQuestion" class="login-input">
                    <option value="">Select Security Question</option>
                    <option value="pet">What was your first pet's name?</option>
                    <option value="school">What was the name of your first school?</option>
                    <option value="city">In which city were you born?</option>
                    <option value="mother">What is your mother's maiden name?</option>
                    <option value="car">What was your first car's model?</option>
                </select>
                <input type="text" id="securityAnswer" class="login-input" placeholder="Your Answer">
                <div id="recoveryError" class="login-error"></div>
                <button id="recoverBtn" class="login-btn">Recover Account</button>
                <div class="back-to-login" id="backToLogin">Back to Login</div>
                
                <div id="recoveryResult" style="display: none; margin-top: 1rem; padding: 1rem; background: #f0fdf4; border-radius: 8px; border: 1px solid #86efac;">
                    <h4 style="color: #166534; margin-bottom: 0.5rem;">Account Details:</h4>
                    <p><strong>Username:</strong> <span id="recoveredUsername"></span></p>
                    <p><strong>Password:</strong> <span id="recoveredPassword"></span></p>
                    <p style="font-size: 0.8rem; color: #64748b; margin-top: 0.5rem;">Please save these credentials securely.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" style="display: none;">
        <div class="spinner"></div>
        <p>Loading Admin Panel...</p>
    </div>

    <!-- Toast Notification Container -->
    <div id="toastContainer"></div>

    <!-- Sidebar Overlay for Mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Admin Panel (hidden until login) -->
    <div id="adminPanel" style="display: none;">
        <!-- Sidebar -->
        <nav class="sidebar" id="sidebar">
            <div class="logo">
                <div class="logo-icon">AV</div>
                <div>
                    <h2 style="font-weight: 700; font-size: 1.2rem;">AdVault Admin</h2>
                    <p style="font-size: 0.8rem; color: var(--text-secondary);">Control Panel</p>
                </div>
            </div>
            
          <ul class="nav-links">
    <li class="nav-item active" data-section="dashboard">
        <div class="nav-link-item"><i class="fas fa-tachometer-alt"></i> Dashboard</div>
    </li>
    <li class="nav-item" data-section="analytics">
        <div class="nav-link-item"><i class="fas fa-chart-line"></i> Analytics</div>
    </li>
    <li class="nav-item" data-section="users">
        <div class="nav-link-item"><i class="fas fa-users"></i> Users</div>
    </li>
    <li class="nav-item" data-section="withdrawals">
        <div class="nav-link-item"><i class="fas fa-money-check-alt"></i> Withdrawals</div>
    </li>
    <li class="nav-item" data-section="notifications">
    <div class="nav-link-item"><i class="fas fa-bell"></i> Notifications</div>
</li>
    <li class="nav-item" data-section="content">
    <div class="nav-link-item"><i class="fas fa-newspaper"></i> Content</div>
</li>

<li class="nav-item" data-section="ads">
    <div class="nav-link-item"><i class="fas fa-ad"></i> Ads Manager</div>
</li>
    <li class="nav-item" data-section="settings">
        <div class="nav-link-item"><i class="fas fa-cog"></i> Settings</div>
    </li>
    
    <div class="mobile-theme-toggle" id="mobileThemeToggle">
        <span>Theme</span>
        <i class="fas fa-moon"></i>
    </div>
    
    <li class="nav-item" data-section="logout">
        <div class="nav-link-item"><i class="fas fa-sign-out-alt"></i> Logout</div>
    </li>
</ul>
            
            <!-- Mobile Admin Info in Sidebar -->
            <div class="mobile-admin-info">
                <div class="mobile-admin-avatar" id="mobileAdminAvatar">A</div>
                <div>
                    <div style="font-weight: 600; font-size: 1rem;" id="mobileAdminDisplayName">Admin</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">Super Admin</div>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <div style="font-size: 0.8rem; color: var(--text-secondary); text-align: center;">
                    <p>v2.1.1 â€¢ <span id="userCount">0</span> users</p>
                    <p id="settingsStatus" style="font-size: 0.75rem; margin-top: 0.25rem; color: #10b981;">Settings: Active</p>
                </div>
            </div>
        </nav>

        <!-- Fixed Header -->
        <header class="fixed-header" id="fixedHeader">
            <div class="header-content">
                <div class="header-left">
                    <button class="menu-toggle" id="menuToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="header-left-text">
                        <h1 id="pageTitle">Dashboard Overview</h1>
                        <p id="pageSubtitle">Welcome to AdVault Admin Panel</p>
                    </div>
                </div>
                <div class="header-right">
                    <button class="theme-toggle" id="themeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                    <div class="desktop-admin-info">
                        <div class="desktop-admin-avatar" id="desktopAdminAvatar">A</div>
                        <div class="desktop-admin-info-text">
                            <div id="desktopAdminDisplayName">Admin</div>
                            <div>Super Admin</div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Alert Container -->
            <div id="alertContainer"></div>

            <!-- Dashboard Section -->
            <section id="dashboardSection" class="section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <h3 class="stat-label">Total Users</h3>
                            <div class="stat-icon icon-users">
                                <i class="fas fa-users"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalUsers">0</div>
                        <div class="stat-label" id="usersGrowth">+0 this week</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <h3 class="stat-label">Total Balance</h3>
                            <div class="stat-icon icon-balance">
                                <i class="fas fa-wallet"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalBalance">BDT 0</div>
                        <div class="stat-label" id="balanceGrowth">+0 BDT today</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <h3 class="stat-label">Total Earnings</h3>
                            <div class="stat-icon icon-earnings">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalEarnings">BDT 0</div>
                        <div class="stat-label" id="earningsGrowth">+0 BDT today</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <h3 class="stat-label">Withdrawals</h3>
                            <div class="stat-icon icon-withdrawals">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalWithdrawals">BDT 0</div>
                        <div class="stat-label" id="withdrawalsGrowth">0 pending</div>
                    </div>
                </div>

                <div class="charts-container">
                    <div class="chart-card">
                        <h3 class="chart-title">User Growth</h3>
                        <div class="chart-wrapper">
                            <canvas id="userGrowthChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3 class="chart-title">Revenue Overview</h3>
                        <div class="chart-wrapper">
                            <canvas id="revenueChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="chart-card" style="height: auto; min-height: 200px;">
                    <h3 class="chart-title">Recent Activity</h3>
                    <div id="recentActivity">
                        <p>Loading recent activity...</p>
                    </div>
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="analyticsSection" class="section" style="display: none;">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-header">
                            <h3 class="stat-label">Active Users</h3>
                            <div class="stat-icon icon-users">
                                <i class="fas fa-user-check"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="activeUsers">0</div>
                        <div class="stat-label">Last 24 hours</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <h3 class="stat-label">Avg. Earnings</h3>
                            <div class="stat-icon icon-earnings">
                                <i class="fas fa-chart-bar"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="avgEarnings">BDT 0</div>
                        <div class="stat-label">Per active user</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <h3 class="stat-label">Ads Watched</h3>
                            <div class="stat-icon icon-balance">
                                <i class="fas fa-eye"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="totalAdsWatched">0</div>
                        <div class="stat-label">Today</div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-header">
                            <h3 class="stat-label">Completion Rate</h3>
                            <div class="stat-icon icon-withdrawals">
                                <i class="fas fa-percentage"></i>
                            </div>
                        </div>
                        <div class="stat-value" id="completionRate">0%</div>
                        <div class="stat-label">Task completion</div>
                    </div>
                </div>

                <div class="charts-container">
                    <div class="chart-card">
                        <h3 class="chart-title">User Distribution by Source</h3>
                        <div class="chart-wrapper">
                            <canvas id="sourceChart"></canvas>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3 class="chart-title">Daily Activity Trend</h3>
                        <div class="chart-wrapper">
                            <canvas id="activityChart"></canvas>
                        </div>
                    </div>
                </div>

                <div class="chart-card" style="height: auto; min-height: 200px;">
                    <h3 class="chart-title">Top Performing Users</h3>
                    <div class="top-users-container">
                        <table class="top-users-table">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Earnings</th>
                                    <th>Ads</th>
                                </tr>
                            </thead>
                            <tbody id="topUsersBody">
                                <tr><td colspan="3" style="text-align: center; padding: 1rem;">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Users Section -->
            <section id="usersSection" class="section" style="display: none;">
                <div class="users-table-container">
                    <div class="table-header">
                        <h2 style="font-size: 1.25rem; font-weight: 600;">All Users</h2>
                        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                            <div class="search-box">
                                <i class="fas fa-search"></i>
                                <input type="text" id="userSearch" placeholder="Search users by name or username...">
                            </div>
                            <button onclick="exportUsersData()" class="btn" style="background: #1A5237; color: white; padding: 8px 16px;">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table id="usersTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>User</th>
                                    <th>Telegram ID</th>
                                    <th>Balance</th>
                                    <th>Earnings</th>
                                    <<th>Ads</th>
<th>Country</th> <th>Source</th>
<th>Status</th>
                                    <th>Last Active</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <tr>
                                    <td colspan="10" style="text-align: center; padding: 2rem;">
                                        Loading users...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="pagination" id="pagination">
                        <button class="page-btn" id="prevPage" disabled>Previous</button>
                        <span id="pageInfo">Page 1 of 1</span>
                        <button class="page-btn" id="nextPage" disabled>Next</button>
                    </div>
                </div>
            </section>

            <!-- Withdrawals Section -->
            <section id="withdrawalsSection" class="section" style="display: none;">
                <div class="users-table-container">
                    <div class="table-header">
                        <h2 style="font-size: 1.25rem; font-weight: 600;">Withdrawal Requests</h2>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                            <select id="withdrawalFilter" class="form-control" style="width: 200px; max-width: 100%;">
                                <option value="all">All Status</option>
                                <option value="pending">Pending</option>
                                <option value="completed">Completed</option>
                                <option value="rejected">Rejected</option>
                            </select>
                            <button onclick="refreshWithdrawals()" class="btn" style="background: #1A5237; color: white; padding: 8px 16px;">
                                <i class="fas fa-sync"></i> Refresh
                            </button>
                        </div>
                    </div>
                    
                    <div style="overflow-x: auto;">
                        <table id="withdrawalsTable">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>User</th>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th>Address</th>
                                    <th>Date</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="withdrawalsTableBody">
                                <tr>
                                    <td colspan="8" style="text-align: center; padding: 2rem;">
                                        Loading withdrawal requests...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
<section id="notificationsSection" class="section" style="display: none;">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
        
        <div class="content-card">
            <h3 class="chart-title" style="margin-bottom: 1.5rem;">
                <i class="fas fa-paper-plane" style="color: #10b981; margin-right: 8px;"></i> Send Notification
            </h3>
            
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="notifTitle" class="form-control" placeholder="e.g. Weekend Bonus!">
            </div>
            
            <div class="form-group">
                <label>Message</label>
                <textarea id="notifMessage" class="form-control" rows="4" placeholder="Type your message here..."></textarea>
            </div>

            <div class="form-group" style="background: var(--bg-secondary); padding: 10px; border-radius: 8px; border: 1px solid var(--border-color);">
                <label style="margin-bottom: 8px; display: block;">Where to send?</label>
                
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="sendToApp" checked style="width: 18px; height: 18px; accent-color: #10b981;">
                        <span>ðŸ“± Show in App (Popup)</span>
                    </label>

                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="sendToTelegram" style="width: 18px; height: 18px; accent-color: #3b82f6;">
                        <span>âœˆï¸ Send Telegram DM</span>
                    </label>
                </div>
            </div>
            
            <button onclick="sendNotification()" class="btn-primary" style="margin-top: 1rem;">
                Send Notification
            </button>
        </div>

        <div class="content-card">
            <h3 class="chart-title" style="margin-bottom: 1.5rem;">
                <i class="fas fa-history" style="color: #3b82f6; margin-right: 8px;"></i> Recent History
            </h3>
            
            <div style="overflow-y: auto; max-height: 400px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border-color);">
                            <th style="text-align: left; padding: 8px; color: var(--text-secondary);">Date</th>
                            <th style="text-align: left; padding: 8px; color: var(--text-secondary);">Title</th>
                            <th style="text-align: right; padding: 8px; color: var(--text-secondary);">Action</th>
                        </tr>
                    </thead>
                    <tbody id="notificationHistoryBody">
                        <tr><td colspan="3" style="text-align: center; padding: 1rem;">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</section>
            <!-- Content & Ads Section -->
            <section id="contentSection" class="section" style="display: none;">
    <div class="content-grid">
        <div class="content-card">
            <h3 class="chart-title" style="margin-bottom: 1.5rem;">ðŸ“¢ Flash Text (Marquee)</h3>
            <div class="grid-inputs">
                <div class="form-group">
                    <label>Country Code (e.g. BD, US)</label>
                    <input type="text" id="mqCountry" class="form-control" placeholder="Country Code" maxlength="2" style="text-transform: uppercase;">
                </div>
                <div class="form-group">
                    <label>Marquee Text Message</label>
                    <input type="text" id="mqText" class="form-control" placeholder="Enter marquee text...">
                </div>
            </div>
            <button onclick="addMarquee()" class="btn-primary">
                <i class="fas fa-plus"></i> Add/Update Marquee
            </button>
            
            <div style="margin-top: 1.5rem; background: var(--bg-secondary); border-radius: 10px; padding: 1rem;">
                <h4 style="font-weight: 600; font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">Active Marquees</h4>
                <div id="marqueeList">
                    <p style="text-align: center; color: var(--text-secondary); padding: 1rem;">No marquees added yet</p>
                </div>
            </div>
        </div>

    <div class="content-card">
    <h3 class="chart-title" style="margin-bottom: 1.5rem;">ðŸ’³ Payment Methods</h3>
    
    <div class="grid-inputs">
        <div class="form-group">
            <label>Method Name</label>
            <input type="text" id="pmName" class="form-control" placeholder="e.g. bKash">
        </div>
        
        <div class="form-group">
            <label>Input Type</label>
            <select id="pmType" class="form-control" onchange="updatePmIcon()">
                <option value="number">Phone Number</option>
                <option value="email">Email Address</option>
                <option value="text">Text Input (ID/Wallet)</option>
            </select>
        </div>

        <input type="hidden" id="pmIcon" value="fas fa-mobile-alt">

        <div class="form-group" style="grid-column: 1 / -1;">
            <label>Brand Color</label>
            
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                <div id="colorPreview" style="width: 42px; height: 42px; border-radius: 10px; background: #E2136E; border: 1px solid #e2e8f0; box-shadow: 0 2px 5px rgba(0,0,0,0.05);"></div>
                
                <input type="text" id="pmColor" class="form-control" placeholder="#E2136E" value="#E2136E" oninput="setPmColor(this.value)">
            </div>

            <div class="color-swatches">
                <div class="color-swatch" style="background: #E2136E;" onclick="setPmColor('#E2136E')" title="bKash"></div>
                <div class="color-swatch" style="background: #F7921E;" onclick="setPmColor('#F7921E')" title="Nagad"></div>
                <div class="color-swatch" style="background: #8C3494;" onclick="setPmColor('#8C3494')" title="Rocket"></div>
                <div class="color-swatch" style="background: #003087;" onclick="setPmColor('#003087')" title="Bank/Upay"></div>
                <div class="color-swatch" style="background: #25D366;" onclick="setPmColor('#25D366')" title="Green"></div>
                <div class="color-swatch" style="background: #EF4444;" onclick="setPmColor('#EF4444')" title="Red"></div>
                <div class="color-swatch" style="background: #0F172A;" onclick="setPmColor('#0F172A')" title="Dark"></div>
                
                <div class="custom-color-btn" title="Custom Color">
                    <input type="color" oninput="setPmColor(this.value)">
                </div>
            </div>
        </div>

        <div class="form-group">
            <label>Min Withdraw (BDT)</label>
            <input type="number" id="pmMin" class="form-control" placeholder="100" value="100">
        </div>
    </div>

    <button onclick="addPaymentMethod()" class="btn-primary" style="margin-top: 1.5rem;">
        <i class="fas fa-plus"></i> Add Payment Method
    </button>
    
    <div style="margin-top: 1.5rem; background: var(--bg-secondary); border-radius: 10px; padding: 1rem;">
        <h4 style="font-weight: 600; font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">Available Payment Methods</h4>
        <div id="paymentMethodList">
            <p style="text-align: center; color: var(--text-secondary); padding: 1rem;">No payment methods added yet</p>
        </div>
    </div>
</div>
<div class="content-card">
    <h3 class="chart-title"><i class="fas fa-info-circle"></i> App Information</h3>
    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 1rem;">
        Set the version, dates, and community links displayed in the user profile.
    </p>

    <div class="grid-inputs">
        <div class="form-group">
            <label>App Version</label>
            <input type="text" id="infoVersion" class="form-control" placeholder="e.g. v2.5.0">
        </div>

        <div class="form-group">
            <label>Last Update</label>
            <input type="text" id="infoDate" class="form-control" placeholder="e.g. 29 Jan, 2026">
        </div>

        <div class="form-group">
            <label>Telegram Channel Link</label>
            <input type="url" id="infoChannel" class="form-control" placeholder="https://t.me/your_channel">
        </div>

        <div class="form-group">
            <label>Telegram Group Link</label>
            <input type="url" id="infoGroup" class="form-control" placeholder="https://t.me/your_group">
        </div>
    </div>
    
    <div style="margin-top: 1rem; text-align: right;">
        <button onclick="saveContentSettings()" class="btn-primary">
            <i class="fas fa-save"></i> Save Info
        </button>
    </div>
</div>
</section>

<section id="adsSection" class="section" style="display: none;">
    <div class="content-grid">
         <div class="content-card" style="border-left: 5px solid #8b5cf6;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 class="chart-title" style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-window-restore" style="color: #8b5cf6;"></i> Popunder Ads
                </h3>
                
                <button id="popunderToggleBtn" onclick="togglePopunder()" class="btn" style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
            
            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
                Paste the Popunder script (JS) here. This runs automatically in the background.
            </p>

            <div class="form-group">
                <textarea id="popunderScript" rows="4" class="form-control" placeholder="<script>...popunder code...</script>" style="font-family: monospace; font-size: 0.8rem;"></textarea>
            </div>

            <button onclick="savePopunder()" class="btn-primary" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);">
                <i class="fas fa-save"></i> Save Popunder
            </button>
        </div>

        <div class="content-card" style="border-left: 5px solid #ec4899;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h3 class="chart-title" style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-comment-alt" style="color: #ec4899;"></i> Social Bar
                </h3>
                
                <button id="socialBarToggleBtn" onclick="toggleSocialBar()" class="btn" style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
            
            <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem;">
                Paste the Social Bar script here. It floats over the app content.
            </p>

            <div class="form-group">
                <textarea id="socialBarScript" rows="4" class="form-control" placeholder="<script>...social bar code...</script>" style="font-family: monospace; font-size: 0.8rem;"></textarea>
            </div>

            <button onclick="saveSocialBar()" class="btn-primary" style="background: linear-gradient(135deg, #ec4899, #db2777);">
                <i class="fas fa-save"></i> Save Social Bar
            </button>
        </div>
        <div class="content-card" style="grid-column: 1 / -1;">
            <h3 class="chart-title" style="margin-bottom: 1.5rem;">ðŸš€ Ad Services (Adsterra)</h3>
            
            <div class="grid-inputs">
                <div class="form-group">
                    <label>Internal Name</label>
                    <input type="text" id="adName" class="form-control" placeholder="e.g. Home Banner 320x50">
                </div>
                <div class="form-group">
                    <label>Ad Type</label>
                    <select id="adType" class="form-control">
                        <option value="banner">Banner (Script)</option>
                        <option value="native">Native Banner (Script)</option>
                        <option value="smartlink">Smartlink (URL)</option>
                    </select>
                </div>
            </div>

            <div class="form-group">
                <label>Script Code or URL</label>
                <textarea id="adCode" rows="4" class="form-control" placeholder="Paste script code or URL here..."></textarea>
            </div>
           
            <div class="form-group">
                <label>Reward Amount (BDT)</label>
                <input type="number" id="adReward" class="form-control" placeholder="0.10" step="0.01" min="0.01">
                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">
                    How much user earns for this specific task
                </div>
            </div>
            <div class="form-group">
    <label>Wait Duration (Seconds)</label>
    <input type="number" id="adDurationInput" class="form-control" placeholder="30" value="30">
    <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">
        Time user must wait to get reward
    </div>
</div>

<button onclick="addAdService()" class="btn-primary">

           
                <i class="fas fa-save"></i> Save Ad Service
            </button>

            <div style="margin-top: 1.5rem; background: var(--bg-secondary); border-radius: 10px; padding: 1rem;">
                <h4 style="font-weight: 600; font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 1rem;">Active Ad Configs</h4>
                <div id="adServiceList">
                    <p style="text-align: center; color: var(--text-secondary); padding: 1rem;">No ad services added yet</p>
                </div>
            </div>
        </div>
    </div>
</section>

            <!-- Settings Section -->
            <section id="settingsSection" class="section" style="display: none;">
                <div class="settings-grid">
                    <div class="setting-card">
                        <div class="setting-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="font-size: 1.1rem; font-weight: 600;">General Settings</h3>
                            <div class="save-indicator" id="generalSaveIndicator"></div>
                        </div>
                        
                        <div class="setting-item">
                            <div>
                                <div style="font-weight: 500;">Maintenance Mode</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    Temporarily disable the app for all users
                                </div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="maintenanceMode" data-setting="maintenanceMode">
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-item">
                            <div>
                                <div style="font-weight: 500;">Auto Approve Withdrawals</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    Automatically approve withdrawal requests
                                </div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="autoApprove" data-setting="autoApprove">
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-item">
                            <div>
                                <div style="font-weight: 500;">Enable Ads Penalty</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    Penalize users for closing ads early
                                </div>
                            </div>
                            <label class="switch">
                                <input type="checkbox" id="enablePenalty" data-setting="enablePenalty" checked>
                                <span class="slider"></span>
                            </label>
                        </div>
                        
                        <div class="setting-item">
                            <div>
                                <div style="font-weight: 500;">Minimum Withdrawal</div>
                                <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                    Minimum amount for withdrawal (BDT)
                                </div>
                            </div>
                            <div>
                                <input type="number" id="minWithdrawal" class="form-control" data-setting="minWithdrawal" style="width: 120px;" value="100" min="10" step="10">
                            </div>
                        </div>

                        <button class="save-settings-btn" onclick="saveSettings('general')">
                            <i class="fas fa-save"></i> Save General Settings
                        </button>
                    </div>
                    
                    <div class="setting-card">
                        <div class="setting-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="font-size: 1.1rem; font-weight: 600;">Ad Settings</h3>
                            <div class="save-indicator" id="adSaveIndicator"></div>
                        </div>
                        
                        <div class="form-group">
                            <label>Earnings Per Ad (BDT)</label>
                            <input type="number" step="0.01" id="earningsPerAd" class="form-control" data-setting="earningsPerAd" value="0.05" min="0.01" max="10">
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                Amount user earns per completed ad
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Daily Task Limit</label>
                            <input type="number" id="dailyTasks" class="form-control" data-setting="dailyTasks" value="1000" min="10" max="10000">
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                Maximum ads a user can watch per day
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Ad Duration (seconds)</label>
                            <input type="number" id="adDuration" class="form-control" data-setting="adDuration" value="15" min="5" max="60">
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                How long users must watch each ad
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Penalty Duration (minutes)</label>
                            <input type="number" id="penaltyDuration" class="form-control" data-setting="penaltyDuration" value="2" min="1" max="60">
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.25rem;">
                                Penalty time for closing ads early
                            </div>
                        </div>

                        <button class="save-settings-btn" onclick="saveSettings('ad')">
                            <i class="fas fa-save"></i> Save Ad Settings
                        </button>
                    </div>
                    
       <div class="content-card">
    <h3 class="chart-title" style="margin-bottom: 1.5rem;">
        <i class="fas fa-shield-alt" style="color: var(--color-primary); margin-right: 8px;"></i>
        Admin Configuration
    </h3>
    
    <div class="alert alert-info" style="margin-bottom: 15px; font-size: 0.9rem;">
        <i class="fas fa-info-circle"></i> 
        To change your password, please use the "Forgot Password" link on the login screen or manage users in Firebase Console.
    </div>

    <div class="grid-inputs" style="display: grid; grid-template-columns: 1fr; gap: 1.5rem;">
        <div class="form-group">
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Telegram Admin ID (Auto-Login)</label>
            <div style="display: flex; gap: 8px;">
                <input type="number" id="adminTelegramId" class="form-control" placeholder="e.g. 123456789">
                <button onclick="detectMyTelegramId()" class="btn" style="background: #0088cc; color: white; width: 50px; display: flex; align-items: center; justify-content: center;">
                    <i class="fab fa-telegram-plane"></i>
                </button>
            </div>
            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 5px;">
                Enter your Telegram ID here to enable automatic login when opening the panel inside Telegram.
            </div>
        </div>
    </div>

    <button onclick="saveAdminSecurity()" class="btn-primary" style="margin-top: 1.5rem;">
        <i class="fas fa-save"></i> Save Configuration
    </button>
</div>
                
                <div class="setting-card" style="margin-top: 1.5rem;">
    <div class="setting-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h3 style="font-size: 1.1rem; font-weight: 600;">System Information</h3>
        <div class="save-indicator" id="systemSaveIndicator"></div>
    </div>

    <div class="grid-inputs" style="margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1.5rem;">
        <div class="form-group">
            <label>App Version</label>
            <input type="text" id="appVersion" class="form-control" data-setting="appVersion" placeholder="2.1.1">
        </div>
        <div class="form-group">
            <label>Build Number</label>
            <input type="text" id="buildNumber" class="form-control" data-setting="buildNumber" placeholder="AV20250902">
        </div>
        <div style="display: flex; align-items: flex-end;">
            <button class="btn-primary" onclick="saveSettings('system')" style="margin-top: 0; padding: 10px 15px;">
                <i class="fas fa-save"></i> Update Info
            </button>
        </div>
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <div>
            <div style="font-size: 0.85rem; color: var(--text-secondary);">Database</div>
            <div style="font-weight: 500;">Firestore</div>
        </div>
        <div>
            <div style="font-size: 0.85rem; color: var(--text-secondary);">Total Users</div>
            <div style="font-weight: 500;" id="systemUserCount">0</div>
        </div>
        <div>
            <div style="font-size: 0.85rem; color: var(--text-secondary);">Settings Last Updated</div>
            <div style="font-weight: 500;" id="lastSettingsUpdate">Never</div>
        </div>
    </div>

    <div style="margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);">
        <button class="btn" style="background: #3b82f6; color: white; padding: 8px 16px; margin-right: 1rem;" onclick="testSettings()">
            <i class="fas fa-vial"></i> Test Settings
        </button>
        <button class="btn" style="background: #dc2626; color: white; padding: 8px 16px;" onclick="resetToDefaults()">
            <i class="fas fa-undo"></i> Reset to Defaults
        </button>
    </div>
</div>
            </section>
        </main>
    </div>

    <!-- Edit User Modal -->
    <div class="modal" id="editUserModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Edit User</h3>
                <button class="close-modal" onclick="closeEditUserModal()">&times;</button>
            </div>
            <form id="editUserForm">
                <div class="form-group">
                    <label>User ID</label>
                    <input type="text" id="editUserId" class="form-control" readonly>
                </div>
                
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="editName" class="form-control">
                    <div class="field-info" id="nameInfo">Managed by Telegram</div>
                </div>
                
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="editUsername" class="form-control">
                    <div class="field-info" id="usernameInfo">Managed by Telegram</div>
                </div>
                
                <div class="form-group">
                    <label>Telegram ID</label>
                    <input type="text" id="editTelegramId" class="form-control" readonly>
                    <div class="field-info">Unique Telegram identifier</div>
                </div>
                
                <div class="form-group">
                    <label>Balance (BDT)</label>
                    <input type="number" step="0.01" id="editBalance" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>Total Earnings (BDT)</label>
                    <input type="number" step="0.01" id="editTotalEarnings" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>Ads Watched</label>
                    <input type="number" id="editAdsWatched" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>Completed Tasks</label>
                    <input type="number" id="editCompletedTasks" class="form-control">
                </div>
                
                <div class="form-group">
                    <label>Account Source</label>
                    <input type="text" id="editSource" class="form-control" readonly>
                    <div class="field-info">Cannot be changed</div>
                </div>
                
                <div class="form-group">
                    <label>Telegram Detected</label>
                    <input type="text" id="editTelegramDetected" class="form-control" readonly>
                    <div class="field-info">Auto-detected from Telegram</div>
                </div>
                
                <button type="submit" class="btn-primary">Save Changes</button>
            </form>
        </div>
    </div>

    <!-- Withdrawal Action Modal -->
    <div class="modal" id="withdrawalModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Process Withdrawal</h3>
                <button class="close-modal" onclick="closeWithdrawalModal()">&times;</button>
            </div>
            <div id="withdrawalDetails">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Firebase Configuration -->
    <script>
        // Firebase configuration
        const firebaseConfig = {
  apiKey: "AIzaSyAH-6VEsx8Jp2KVeltSlvBFU1nn6M-2r1w",
  authDomain: "adbot-s4.firebaseapp.com",
  projectId: "adbot-s4",
  storageBucket: "adbot-s4.firebasestorage.app",
  messagingSenderId: "422990164333",
  appId: "1:422990164333:web:34c170382c4a87915f2a64"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // Collections
        const USERS_COLLECTION = "adv2_users";
        const WITHDRAWALS_COLLECTION = "adv2_withdrawals";
        const ADMIN_SETTINGS_DOC_ID = "_admin_settings_";

       // ==========================================
        // 1. GLOBAL VARIABLES (Replace your old list with this)
        // ==========================================
        
        const TELEGRAM_BOT_TOKEN = "8314081756:AAEHtIG4dDL6HzvTTKr2OVr0nh2EDayqMj8"; // Keep your token
        
        // --- AUTH VARIABLES ---
        let currentUser = null;      // Stores the logged-in Firebase User
        let adminLoggedIn = false;   // Tracks if admin is logged in
        
        // --- DATA VARIABLES ---
        let users = [];
        let withdrawals = [];
        let currentPage = 1;
        const itemsPerPage = 15;
        let filteredUsers = [];
        let charts = {};
        let settings = {};

        // --- CONTENT SETTINGS ---
        let contentSettings = {
            marqueeSettings: {},
            paymentMethods: [],
            adServices: [],
            popunder: { code: '', active: false },
            socialBar: { code: '', active: false },
            appInfo: {} 
        };
        
        // NOTE: We deleted 'adminCredentials' because we use Firebase Auth now.
        // Check login from localStorage
        // --- AUTH STATE LISTENER (Runs on load) ---
// --- AUTH STATE LISTENER (Runs on load) ---
auth.onAuthStateChanged(async (user) => {
    if (user) {
        // Check if user has an email (Anonymous users don't)
        if (!user.email) {
            console.log("Anonymous user detected. Signing out to force Email Login...");
            auth.signOut(); // Force logout so you can log in with Email/Pass
            return;
        }

        console.log("User is signed in:", user.email);
        currentUser = user;
        adminLoggedIn = true;
        
        // Show Admin Panel
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
        
        // Safe Name Display (Fixes the split error)
        const displayName = user.email ? user.email.split('@')[0] : 'Admin';
        
        const desktopNameEl = document.getElementById('desktopAdminDisplayName');
        if(desktopNameEl) desktopNameEl.textContent = displayName;
        
        const mobileNameEl = document.getElementById('mobileAdminDisplayName');
        if(mobileNameEl) mobileNameEl.textContent = displayName;
        
        // Initialize the panel
        initAdminPanel();
    } else {
        // --- SCENARIO 2: NOT LOGGED IN ---
        console.log("No Firebase user. Checking Telegram...");
        
        // Check Telegram Auto-Login
        const telegramSuccess = await checkTelegramAutoLogin();
        
        if (!telegramSuccess) {
            adminLoggedIn = false;
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('adminPanel').style.display = 'none';
        }
    }
});
        // Update admin display in header
        function updateAdminDisplay() {
            const adminName = adminCredentials.username;
            const firstLetter = adminName.charAt(0).toUpperCase();
            
            // Update desktop admin info
            document.getElementById('desktopAdminDisplayName').textContent = adminName;
            document.getElementById('desktopAdminAvatar').textContent = firstLetter;
            
            // Update mobile admin info
            document.getElementById('mobileAdminDisplayName').textContent = adminName;
            document.getElementById('mobileAdminAvatar').textContent = firstLetter;
            
            // Update admin info in settings
            if (document.getElementById('adminNewUsername')) {
                document.getElementById('adminNewUsername').value = adminCredentials.username;
                document.getElementById('adminSecurityQuestion').value = adminCredentials.securityQuestion;
                document.getElementById('adminSecurityAnswer').value = adminCredentials.securityAnswer;
            }
        }

        // UPDATED: Login Logic (Checks Firestore)
        // --- NEW LOGIN LOGIC (Firebase Auth) ---
// --- NEW LOGIN LOGIC (Firebase Auth) ---
document.getElementById('loginBtn').addEventListener('click', function() {
    const email = document.getElementById('adminEmail').value.trim();
    // FIX: Added space between 'const' and 'password'
    const password = document.getElementById('adminPassword').value.trim(); 
    const loginBtn = document.getElementById('loginBtn');
    const errorDiv = document.getElementById('loginError');
    
    if (!email || !password) {
        errorDiv.textContent = 'Please enter email and password';
        return;
    }

    // UI Loading State
    const originalText = loginBtn.innerHTML;
    loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
    loginBtn.disabled = true;
    errorDiv.textContent = '';

    // Firebase Sign In
    auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
            console.log("Logged in as:", userCredential.user.email);
            // The authStateChanged listener will handle the redirect automatically
        })
        .catch((error) => {
            console.error("Login Error:", error);
            let msg = error.message;
            if(error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password') {
                msg = "Invalid Email or Password.";
            } else if(error.code === 'auth/too-many-requests') {
                msg = "Too many failed attempts. Please try again later.";
            }
            errorDiv.textContent = msg;
            loginBtn.innerHTML = originalText;
            loginBtn.disabled = false;
        });
});

       
        // Show forgot password form
        document.getElementById('showForgotPassword').addEventListener('click', function() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('forgotPasswordForm').style.display = 'block';
        });

        // Back to login
        document.getElementById('backToLogin').addEventListener('click', function() {
            document.getElementById('forgotPasswordForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('recoveryResult').style.display = 'none';
            document.getElementById('recoveryError').textContent = '';
        });

        // Recover password
        // UPDATED: Recover Password (Fetches from Firestore)
        // --- NEW PASSWORD RESET (Firebase Email) ---
document.getElementById('recoverBtn').addEventListener('click', function() {
    const email = document.getElementById('resetEmail').value.trim();
    const errorDiv = document.getElementById('recoveryError');
    const successDiv = document.getElementById('recoverySuccess');
    const btn = document.getElementById('recoverBtn');

    if (!email) {
        errorDiv.textContent = 'Please enter your admin email.';
        return;
    }

    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
    btn.disabled = true;
    errorDiv.textContent = '';
    successDiv.style.display = 'none';

    auth.sendPasswordResetEmail(email)
        .then(() => {
            successDiv.textContent = `Reset link sent to ${email}. Check your inbox.`;
            successDiv.style.display = 'block';
            document.getElementById('resetEmail').value = '';
        })
        .catch((error) => {
            errorDiv.textContent = error.message;
        })
        .finally(() => {
            btn.innerHTML = 'Send Reset Link';
            btn.disabled = false;
        });
});
        // Update admin credentials
        async function updateAdminCredentials() {
            const newUsername = document.getElementById('adminNewUsername').value.trim();
            const newPassword = document.getElementById('adminNewPassword').value;
            const confirmPassword = document.getElementById('adminConfirmPassword').value;
            const securityQuestion = document.getElementById('adminSecurityQuestion').value;
            const securityAnswer = document.getElementById('adminSecurityAnswer').value.trim();
            
            if (!newUsername || !newPassword || !confirmPassword || !securityQuestion || !securityAnswer) {
                showAlert('Please fill all fields', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showAlert('Passwords do not match', 'error');
                return;
            }
            
            adminCredentials = {
                username: newUsername,
                password: newPassword,
                securityQuestion: securityQuestion,
                securityAnswer: securityAnswer
            };
            
            localStorage.setItem('advault_admin_credentials', JSON.stringify(adminCredentials));
            updateAdminDisplay();
            showToast('Admin credentials updated successfully!', 'success');
            
            // Clear password fields
            document.getElementById('adminNewPassword').value = '';
            document.getElementById('adminConfirmPassword').value = '';
        }

        // Logout
        function logout() {
    auth.signOut().then(() => {
        // Sign-out successful.
        adminLoggedIn = false;
        // The onAuthStateChanged listener will automatically show the login screen
        window.location.reload(); // Reload to clear any Telegram session states
    }).catch((error) => {
        console.error("Logout Error:", error);
    });
}
        // Initialize Admin Panel
        // Initialize Admin Panel
        async function initAdminPanel() {
            try {
                document.getElementById('loadingScreen').style.display = 'flex';
                
                // REMOVED: await auth.signInAnonymously(); 
                // Reason: We are already logged in via Email/Password or Telegram. 
                // calling this would log us out!

                // Load settings
                await loadSettings();
                
                // Load content settings
                await loadContentSettings();
                
                // Load initial data
                await loadDashboardData();
                await loadUsers();
                await loadWithdrawals();
                
                // Initialize charts
                initializeCharts();
                
                // Update UI
                updateDashboardStats();
                updateRecentActivity();
                updateUsersTable();
                updateWithdrawalsTable();
                updateTopUsers();
                
                // Hide loading screen
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.display = 'none';
                }, 500);
                
            } catch (error) {
                console.error("Error initializing admin panel:", error);
                // Do not use showAlert here as it might not be defined yet or cause issues during init
                console.log("Failed to initialize panel");
            }
        }

        // Load settings
        async function loadSettings() {
            try {
                const snapshot = await db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID).get();
                if (snapshot.exists) {
                    settings = snapshot.data();
                    applySettingsToUI();
                    
                    // Update last settings update time
                    if (settings.lastUpdated) {
                        const date = new Date(settings.lastUpdated);
                        document.getElementById('lastSettingsUpdate').textContent = date.toLocaleString();
                    }
                } else {
                    // Default settings
                    settings = {
                        maintenanceMode: false,
                        autoApprove: false,
                        enablePenalty: true,
                        minWithdrawal: 100,
                        earningsPerAd: 0.05,
                        dailyTasks: 1000,
                        adDuration: 15,
                        penaltyDuration: 2,
                        lastUpdated: new Date().toISOString(),
                        isAdminSettings: true
                    };
                    await db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID).set(settings);
                    applySettingsToUI();
                    
                    document.getElementById('lastSettingsUpdate').textContent = 'Just now';
                }
                
                // Set up real-time listener for settings changes
                setupSettingsListener();
                
            } catch (error) {
                console.error("Error loading settings:", error);
                showToast('Failed to load settings', 'error');
            }
        }
// ================= NOTIFICATION LOGIC =================

// Make sure to add your token at the top of the script if you haven't yet:
    // const TELEGRAM_BOT_TOKEN = "YOUR_BOT_TOKEN_HERE"; 

    async function sendNotification() {
        const title = document.getElementById('notifTitle').value.trim();
        const message = document.getElementById('notifMessage').value.trim();
        
        // Get Checkbox Values
        const sendToApp = document.getElementById('sendToApp').checked;
        const sendToTelegram = document.getElementById('sendToTelegram').checked;

        if(!title || !message) {
            showToast("Please enter a Title and Message", "error");
            return;
        }

        if(!sendToApp && !sendToTelegram) {
            showToast("Please select at least one destination (App or Telegram)", "error");
            return;
        }

        const btn = document.querySelector('#notificationsSection .btn-primary');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
        btn.disabled = true;

        try {
            let statusMsg = "";

            // --- 1. SEND TO APP (FIRESTORE) ---
            if (sendToApp) {
                await db.collection('adv2_notifications').add({
                    title: title,
                    message: message,
                    createdAt: new Date().toISOString(),
                    createdBy: "Admin"
                });
                statusMsg += "App Popup Sent. ";
            }

            // --- 2. SEND TO TELEGRAM (DM) ---
            if (sendToTelegram) {
                if(!TELEGRAM_BOT_TOKEN || TELEGRAM_BOT_TOKEN.includes("YOUR_BOT_TOKEN")) {
                    alert("Error: TELEGRAM_BOT_TOKEN is missing in code!");
                } else {
                    // Fetch users who have an ID that looks like a Telegram ID (numbers)
                    const snapshot = await db.collection(USERS_COLLECTION).get();
                    const telegramUsers = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.id && /^\d+$/.test(data.id)) { 
                            telegramUsers.push(data.id);
                        }
                    });

                    // Send DMs loop
                    let sentCount = 0;
                    const fullMessage = `ðŸ“¢ *${title}*\n\n${message}\n\nðŸ‘‡ _Open app to check!_`;

                    for (const userId of telegramUsers) {
                        try {
                            // Don't await the fetch result to speed it up (Fire & Forget)
                            fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
                                method: 'POST',
                                headers: {'Content-Type': 'application/json'},
                                body: JSON.stringify({
                                    chat_id: userId,
                                    text: fullMessage,
                                    parse_mode: 'Markdown'
                                })
                            });
                            sentCount++;
                            // Tiny delay to be safe
                            await new Promise(r => setTimeout(r, 20));
                        } catch (err) { console.error(err); }
                    }
                    statusMsg += `Sent to ${sentCount} Telegram users.`;
                }
            }
            
            // Clear inputs and reload list
            showToast("Success! " + statusMsg, "success");
            document.getElementById('notifTitle').value = '';
            document.getElementById('notifMessage').value = '';
            
            // Only reload list if we saved to database (otherwise list won't change)
            if(sendToApp) loadNotifications(); 

        } catch(e) {
            console.error(e);
            showToast("Error: " + e.message, "error");
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

async function loadNotifications() {
    const tbody = document.getElementById('notificationHistoryBody');
    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 1rem;">Loading...</td></tr>';
    
    try {
        const snap = await db.collection('adv2_notifications')
            .orderBy('createdAt', 'desc')
            .limit(20)
            .get();
        
        tbody.innerHTML = '';
        
        if(snap.empty) {
            tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 1rem; color: var(--text-secondary);">No notifications found</td></tr>';
            return;
        }

        snap.forEach(doc => {
            const data = doc.data();
            const date = new Date(data.createdAt).toLocaleDateString();
            const row = `
                <tr style="border-bottom: 1px solid var(--border-color);">
                    <td style="padding: 12px 8px;">${date}</td>
                    <td style="padding: 12px 8px; font-weight: 500;">${data.title}</td>
                    <td style="padding: 12px 8px; text-align: right;">
                        <button onclick="deleteNotification('${doc.id}')" class="btn btn-delete" style="padding: 4px 8px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    } catch(e) {
        console.error(e);
        tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 1rem; color: #ef4444;">Error loading history</td></tr>';
    }
}

async function deleteNotification(id) {
    if(!confirm("Are you sure? This will remove the notification for all users.")) return;
    
    try {
        await db.collection('adv2_notifications').doc(id).delete();
        showToast("Notification deleted", "success");
        loadNotifications();
    } catch(e) {
        showToast("Error deleting: " + e.message, "error");
    }
}
        // Load content settings
        // ================= CONTENT SETTINGS (LOAD & SAVE) =================

        // 1. Load Content Settings (Includes App Info now)
        async function loadContentSettings() {
            try {
                const snapshot = await db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID).get();
                if (snapshot.exists) {
                    const data = snapshot.data();
                    
                    // --- Load Arrays ---
                    if (data.marqueeSettings) contentSettings.marqueeSettings = data.marqueeSettings;
                    if (data.paymentMethods) contentSettings.paymentMethods = data.paymentMethods;
                    if (data.adServices) contentSettings.adServices = data.adServices;
                    
                    // --- Load Ad Blockers ---
                    if (data.popunder) contentSettings.popunder = data.popunder;
                    if (data.socialBar) contentSettings.socialBar = data.socialBar;
                    
                    // --- Load App Information (NEW) ---
                    if (data.appInfo) {
                        contentSettings.appInfo = data.appInfo;
                        
                        const elVersion = document.getElementById('infoVersion');
                        const elDate = document.getElementById('infoDate');
                        const elChannel = document.getElementById('infoChannel');
                        const elGroup = document.getElementById('infoGroup');

                        if (elVersion) elVersion.value = data.appInfo.version || '';
                        if (elDate) elDate.value = data.appInfo.lastUpdate || '';
                        if (elChannel) elChannel.value = data.appInfo.channel || '';
                        if (elGroup) elGroup.value = data.appInfo.group || '';
                    }

                    // --- Render UI ---
                    renderMarqueeList();
                    renderPaymentMethodList();
                    renderAdServiceList();
                    updateAdBlockUI();
                }
            } catch (error) {
                console.error("Error loading content settings:", error);
                showToast("Error loading content settings", "error");
            }
        }

        // 2. Save Content Settings (Now saves App Info too)
        async function saveContentSettings(showNotification = true) {
            try {
                // Capture App Info Values
                const appInfoData = {
                    version: document.getElementById('infoVersion').value.trim(),
                    lastUpdate: document.getElementById('infoDate').value.trim(),
                    channel: document.getElementById('infoChannel').value.trim(),
                    group: document.getElementById('infoGroup').value.trim()
                };

                // Update Local State
                contentSettings.appInfo = appInfoData;

                // Save Everything to Firestore
                await db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID).set({
                    ...settings, // Keep general settings
                    marqueeSettings: contentSettings.marqueeSettings,
                    paymentMethods: contentSettings.paymentMethods,
                    adServices: contentSettings.adServices,
                    popunder: contentSettings.popunder,
                    socialBar: contentSettings.socialBar,
                    appInfo: contentSettings.appInfo, // <--- SAVING NEW DATA
                    lastUpdated: new Date().toISOString()
                }, { merge: true });
                
                if (showNotification) {
                    showToast('Content & App Info saved successfully!', 'success');
                }
                return true;
            } catch (error) {
                console.error("Error saving content settings:", error);
                showToast('Failed to save content settings', 'error');
                return false;
            }
        }
// --- Helper: Update Color Input ---
function setPmColor(color) {
    // Update the Text Input
    document.getElementById('pmColor').value = color;
    
    // Update the Preview Box
    document.getElementById('colorPreview').style.backgroundColor = color;
}
        // Helper to update the UI state
        function updateAdBlockUI() {
            // Popunder
            document.getElementById('popunderScript').value = contentSettings.popunder.code || '';
            const popBtn = document.getElementById('popunderToggleBtn');
            if(contentSettings.popunder.active) {
                popBtn.style.background = '#dcfce7';
                popBtn.style.color = '#166534';
            } else {
                popBtn.style.background = '#fee2e2';
                popBtn.style.color = '#991b1b';
            }

            // Social Bar
            document.getElementById('socialBarScript').value = contentSettings.socialBar.code || '';
            const socialBtn = document.getElementById('socialBarToggleBtn');
            if(contentSettings.socialBar.active) {
                socialBtn.style.background = '#dcfce7';
                socialBtn.style.color = '#166534';
            } else {
                socialBtn.style.background = '#fee2e2';
                socialBtn.style.color = '#991b1b';
            }
        }
        
       // --- POPUNDER FUNCTIONS ---
        async function savePopunder() {
            const code = document.getElementById('popunderScript').value.trim();
            contentSettings.popunder.code = code;
            
            // Pass 'false' to stop the generic "Saved" message
            await saveContentSettings(false); 
            showToast('Popunder script saved!', 'success');
        }

        async function togglePopunder() {
            contentSettings.popunder.active = !contentSettings.popunder.active;
            
            // Pass 'false' here too
            await saveContentSettings(false);
            updateAdBlockUI();
            showToast(`Popunder ${contentSettings.popunder.active ? 'Enabled' : 'Disabled'}`, 'info');
        }

        // --- SOCIAL BAR FUNCTIONS ---
        async function saveSocialBar() {
            const code = document.getElementById('socialBarScript').value.trim();
            contentSettings.socialBar.code = code;
            
            await saveContentSettings(false);
            showToast('Social Bar script saved!', 'success');
        }

        async function toggleSocialBar() {
            contentSettings.socialBar.active = !contentSettings.socialBar.active;
            
            await saveContentSettings(false);
            updateAdBlockUI();
            showToast(`Social Bar ${contentSettings.socialBar.active ? 'Enabled' : 'Disabled'}`, 'info');
        }
        
        // Save content settings (Updated: Can silence notification)
        

        // Set up real-time listener for settings
        function setupSettingsListener() {
            db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID)
                .onSnapshot((doc) => {
                    if (doc.exists) {
                        const newSettings = doc.data();
                        settings = newSettings;
                        applySettingsToUI();
                        
                        // Update content settings if they exist
                        if (newSettings.marqueeSettings) contentSettings.marqueeSettings = newSettings.marqueeSettings;
                        if (newSettings.paymentMethods) contentSettings.paymentMethods = newSettings.paymentMethods;
                        if (newSettings.adServices) contentSettings.adServices = newSettings.adServices;
                        
                        // Update content UI if content section is active
                        if (document.getElementById('contentSection').style.display !== 'none') {
                            renderMarqueeList();
                            renderPaymentMethodList();
                            renderAdServiceList();
                        }
                        
                        // Update last settings update time
                        if (settings.lastUpdated) {
                            const date = new Date(settings.lastUpdated);
                            document.getElementById('lastSettingsUpdate').textContent = date.toLocaleString();
                        }
                        
                        // Update settings status
                        document.getElementById('settingsStatus').textContent = 'Settings: Active';
                        document.getElementById('settingsStatus').style.color = '#10b981';
                        
                    }
                }, (error) => {
                    console.error("Settings listener error:", error);
                    document.getElementById('settingsStatus').textContent = 'Settings: Error';
                    document.getElementById('settingsStatus').style.color = '#ef4444';
                });
        }

        // Save settings
        async function saveSettings(type = 'all') {
    try {
        let settingsData = {
            lastUpdated: new Date().toISOString(),
            isAdminSettings: true
        };

        // 1. General Settings
        if (type === 'general' || type === 'all') {
            settingsData.maintenanceMode = document.getElementById('maintenanceMode').checked;
            settingsData.autoApprove = document.getElementById('autoApprove').checked;
            settingsData.enablePenalty = document.getElementById('enablePenalty').checked;
            settingsData.minWithdrawal = parseFloat(document.getElementById('minWithdrawal').value);
        }

        // 2. Ad Settings
        if (type === 'ad' || type === 'all') {
            settingsData.earningsPerAd = parseFloat(document.getElementById('earningsPerAd').value);
            settingsData.dailyTasks = parseInt(document.getElementById('dailyTasks').value);
            settingsData.adDuration = parseInt(document.getElementById('adDuration').value);
            settingsData.penaltyDuration = parseInt(document.getElementById('penaltyDuration').value);
        }

        // 3. System Information (NEW)
        if (type === 'system' || type === 'all') {
            settingsData.appVersion = document.getElementById('appVersion').value.trim();
            settingsData.buildNumber = document.getElementById('buildNumber').value.trim();
        }

        // Merge with existing settings
        const updatedSettings = {
            ...settings,
            ...settingsData,
            marqueeSettings: contentSettings.marqueeSettings,
            paymentMethods: contentSettings.paymentMethods,
            adServices: contentSettings.adServices
        };

        await db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID).set(updatedSettings, { merge: true });
        settings = updatedSettings;
        
        // Show success indicator based on type
        if (type === 'general') showIndicator('generalSaveIndicator', 'Saved!');
        else if (type === 'ad') showIndicator('adSaveIndicator', 'Saved!');
        else if (type === 'system') showIndicator('systemSaveIndicator', 'Saved!'); // New indicator
        
        showToast(`${type === 'all' ? 'All' : 'System'} settings saved successfully!`, 'success');
        
        document.getElementById('lastSettingsUpdate').textContent = new Date().toLocaleString();
        return true;
    } catch (error) {
        console.error("Error saving settings:", error);
        showToast(`Failed to save ${type} settings.`, 'error');
        return false;
    }
}

// --- SMART AUTO-LOGIN CHECK ---
    async function checkTelegramAutoLogin() {
        // 1. Check if running inside Telegram
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe.user) {
            const tgUser = window.Telegram.WebApp.initDataUnsafe.user;
            const myTgId = tgUser.id.toString();
            
            console.log("Checking Auto-Login for ID:", myTgId);

            try {
                // 2. Check database
                const doc = await db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID).get();
                if (doc.exists) {
                    const data = doc.data();
                    // Compare saved ID with current ID
                    if (data.adminTelegramId && data.adminTelegramId.toString() === myTgId) {
                        
                        // 3. SUCCESS: Log in automatically
                        showToast(`Auto-login success! Welcome ${tgUser.first_name}`, 'success');
                        
                        // Set credentials locally so the panel works
                        adminCredentials.username = data.username || "Admin";
                        adminCredentials.password = data.password || "";
                        adminLoggedIn = true;
                        
                        // Update UI
                        document.getElementById('loginScreen').style.display = 'none';
                        document.getElementById('adminPanel').style.display = 'block';
                        updateAdminDisplay();
                        initAdminPanel();
                        return true;
                    }
                }
            } catch (e) {
                console.error("Auto-login failed:", e);
            }
        }
        return false;
    }

// --- ADMIN SECURITY FUNCTIONS ---

    // 1. Helper to auto-fill your ID if you are using the bot
    function detectMyTelegramId() {
        if (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe.user) {
            const myId = window.Telegram.WebApp.initDataUnsafe.user.id;
            document.getElementById('adminTelegramId').value = myId;
            showToast("ID Detected: " + myId, "success");
        } else {
            showToast("Open this in Telegram to detect ID automatically", "info");
        }
    }

    // 2. Save Function (Username, Password, Telegram UID)
    async function saveAdminSecurity() {
    const telegramId = document.getElementById('adminTelegramId').value.trim();
    
    // We only update the Telegram ID in the database now.
    // Password changes are handled via Firebase Console or "Forgot Password" email.
    
    const btn = event.target; 
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    btn.disabled = true;

    try {
        await db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID).set({
            adminTelegramId: telegramId,
            // We do NOT save username/password/security questions here anymore
        }, { merge: true });

        showToast('Telegram ID updated successfully!', 'success');

    } catch (error) {
        console.error("Error saving security settings:", error);
        showToast('Failed to update settings', 'error');
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}
        // Show save indicator
        function showIndicator(elementId, message) {
            const indicator = document.getElementById(elementId);
            if (indicator) {
                indicator.textContent = message;
                indicator.style.display = 'block';
                indicator.style.color = '#10b981';
                
                setTimeout(() => {
                    indicator.style.display = 'none';
                }, 2000);
            }
        }

        // Apply settings to UI
        function applySettingsToUI() {
    if (!settings) return;
    
    // General
    if(document.getElementById('maintenanceMode')) document.getElementById('maintenanceMode').checked = settings.maintenanceMode || false;
    if(document.getElementById('autoApprove')) document.getElementById('autoApprove').checked = settings.autoApprove || false;
    if(document.getElementById('enablePenalty')) document.getElementById('enablePenalty').checked = settings.enablePenalty !== false;
    if(document.getElementById('minWithdrawal')) document.getElementById('minWithdrawal').value = settings.minWithdrawal || 100;
    
    // Ad
    if(document.getElementById('earningsPerAd')) document.getElementById('earningsPerAd').value = settings.earningsPerAd || 0.05;
    if(document.getElementById('dailyTasks')) document.getElementById('dailyTasks').value = settings.dailyTasks || 1000;
    if(document.getElementById('adDuration')) document.getElementById('adDuration').value = settings.adDuration || 15;
    if(document.getElementById('penaltyDuration')) document.getElementById('penaltyDuration').value = settings.penaltyDuration || 2;
    
    // --- SECURITY FIELDS (The Fix) ---
    if (document.getElementById('newAdminName')) document.getElementById('newAdminName').value = settings.username || '';
    if (document.getElementById('newAdminPass')) document.getElementById('newAdminPass').value = settings.password || '';
    if (document.getElementById('adminTelegramId')) document.getElementById('adminTelegramId').value = settings.adminTelegramId || '';

    // System Info
    if (document.getElementById('appVersion')) document.getElementById('appVersion').value = settings.appVersion || '2.1.1';
    if (document.getElementById('buildNumber')) document.getElementById('buildNumber').value = settings.buildNumber || 'AV20250902';
    
    // Auto-fill Security Fields (The Fix)
            if (document.getElementById('newAdminName')) {
                // Try Firestore setting -> then Local Creds -> then Default
                document.getElementById('newAdminName').value = settings.username || adminCredentials.username || 'admin';
            }
            if (document.getElementById('newAdminPass')) {
                document.getElementById('newAdminPass').value = settings.password || adminCredentials.password || 'admin123';
            }
            if (document.getElementById('adminTelegramId')) {
                document.getElementById('adminTelegramId').value = settings.adminTelegramId || '';
            }
    
    updateMaintenanceStatus();
}

        // Update maintenance status display
        function updateMaintenanceStatus() {
            const statusElement = document.getElementById('settingsStatus');
            if (!statusElement) return;
            
            if (settings.maintenanceMode) {
                statusElement.textContent = 'Maintenance: ACTIVE';
                statusElement.style.color = '#f59e0b';
                statusElement.style.fontWeight = 'bold';
            } else {
                statusElement.textContent = 'Settings: Active';
                statusElement.style.color = '#10b981';
                statusElement.style.fontWeight = 'normal';
            }
        }

        // Test settings
        async function testSettings() {
            showToast('Testing settings connection...', 'info');
            
            try {
                // Test Firestore connection
                const testDoc = await db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID).get();
                
                if (testDoc.exists) {
                    showToast('Settings connection successful!', 'success');
                    
                    // Show current settings in alert
                    const currentSettings = testDoc.data();
                    let settingsSummary = 'Current Settings:\n\n';
                    
                    // General settings
                    settingsSummary += 'GENERAL SETTINGS:\n';
                    settingsSummary += `â€¢ Maintenance Mode: ${currentSettings.maintenanceMode ? 'ON' : 'OFF'}\n`;
                    settingsSummary += `â€¢ Auto Approve: ${currentSettings.autoApprove ? 'ON' : 'OFF'}\n`;
                    settingsSummary += `â€¢ Enable Penalty: ${currentSettings.enablePenalty !== false ? 'ON' : 'OFF'}\n`;
                    settingsSummary += `â€¢ Min Withdrawal: ${currentSettings.minWithdrawal || 100} BDT\n\n`;
                    
                    // Ad settings
                    settingsSummary += 'AD SETTINGS:\n';
                    settingsSummary += `â€¢ Earnings Per Ad: ${currentSettings.earningsPerAd || 0.05} BDT\n`;
                    settingsSummary += `â€¢ Daily Tasks: ${currentSettings.dailyTasks || 1000}\n`;
                    settingsSummary += `â€¢ Ad Duration: ${currentSettings.adDuration || 15} seconds\n`;
                    settingsSummary += `â€¢ Penalty Duration: ${currentSettings.penaltyDuration || 2} minutes\n\n`;
                    
                    settingsSummary += `Last Updated: ${currentSettings.lastUpdated ? new Date(currentSettings.lastUpdated).toLocaleString() : 'Never'}`;
                    
                    alert(settingsSummary);
                } else {
                    showToast('Settings document not found', 'error');
                }
            } catch (error) {
                console.error('Settings test failed:', error);
                showToast(`Test failed: ${error.message}`, 'error');
            }
        }

        // Reset to defaults
        async function resetToDefaults() {
            if (!confirm('Are you sure you want to reset all settings to defaults? This will affect all users immediately.')) {
                return;
            }

            try {
                const defaultSettings = {
                    maintenanceMode: false,
                    autoApprove: false,
                    enablePenalty: true,
                    minWithdrawal: 100,
                    earningsPerAd: 0.05,
                    dailyTasks: 1000,
                    adDuration: 15,
                    penaltyDuration: 2,
                    lastUpdated: new Date().toISOString(),
                    isAdminSettings: true
                };

                await db.collection(USERS_COLLECTION).doc(ADMIN_SETTINGS_DOC_ID).set(defaultSettings);
                settings = defaultSettings;
                applySettingsToUI();
                
                showToast('Settings reset to defaults!', 'success');
                document.getElementById('lastSettingsUpdate').textContent = new Date().toLocaleString();
            } catch (error) {
                console.error('Error resetting settings:', error);
                showToast('Failed to reset settings', 'error');
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load users data
                const usersSnapshot = await db.collection(USERS_COLLECTION).get();
                users = usersSnapshot.docs
                    .filter(doc => doc.id !== ADMIN_SETTINGS_DOC_ID && !doc.data().isAdminSettings)
                    .map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));

                // Load withdrawals data
                const withdrawalsSnapshot = await db.collection(WITHDRAWALS_COLLECTION).get();
                withdrawals = withdrawalsSnapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));

            } catch (error) {
                console.error("Error loading dashboard data:", error);
            }
        }

        // Load users
        async function loadUsers() {
            try {
                const snapshot = await db.collection(USERS_COLLECTION).get();
                users = snapshot.docs
                    .filter(doc => doc.id !== ADMIN_SETTINGS_DOC_ID && !doc.data().isAdminSettings)
                    .map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                filteredUsers = [...users];
                updateUsersTable();
                updateTopUsers();
            } catch (error) {
                console.error("Error loading users:", error);
                showAlert("Failed to load users.", "error");
            }
        }

        // Load withdrawals
        async function loadWithdrawals() {
            try {
                const snapshot = await db.collection(WITHDRAWALS_COLLECTION)
                    .orderBy('timestamp', 'desc')
                    .limit(100)
                    .get();
                withdrawals = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                updateWithdrawalsTable();
            } catch (error) {
                console.error("Error loading withdrawals:", error);
                showAlert("Failed to load withdrawals.", "error");
            }
        }

        // Refresh withdrawals
        async function refreshWithdrawals() {
            await loadWithdrawals();
            showToast("Withdrawals refreshed successfully!", "success");
        }

        // Update dashboard statistics
        // Update dashboard statistics
        function updateDashboardStats() {
            // 1. Calculate Totals
            const totalUsers = users.length;
            const totalBalance = users.reduce((sum, user) => sum + (user.balance || 0), 0);
            const totalEarnings = users.reduce((sum, user) => sum + (user.totalEarnings || 0), 0);
            const totalWithdrawals = withdrawals.reduce((sum, w) => sum + (w.amount || 0), 0);
            const pendingWithdrawals = withdrawals.filter(w => w.status === 'pending').length;

            // 2. Calculate "Today" Stats safely
            const todayStr = new Date().toISOString().split('T')[0];
            
            // Count users who joined today
            const newUsersToday = users.filter(u => {
                const date = getSafeDate(u.joinDate);
                if (!date) return false;
                return date.toISOString().startsWith(todayStr);
            }).length;

            // Count users active today
            const activeToday = users.filter(u => {
                const date = getSafeDate(u.lastUpdated);
                if (!date) return false;
                return date.toISOString().startsWith(todayStr);
            }).length;

            // 3. Update UI Elements
            if(document.getElementById('totalUsers')) document.getElementById('totalUsers').textContent = totalUsers.toLocaleString();
            if(document.getElementById('userCount')) document.getElementById('userCount').textContent = totalUsers.toLocaleString();
            if(document.getElementById('systemUserCount')) document.getElementById('systemUserCount').textContent = totalUsers.toLocaleString();
            
            if(document.getElementById('totalBalance')) document.getElementById('totalBalance').textContent = `BDT ${totalBalance.toFixed(2)}`;
            if(document.getElementById('totalEarnings')) document.getElementById('totalEarnings').textContent = `BDT ${totalEarnings.toFixed(2)}`;
            if(document.getElementById('totalWithdrawals')) document.getElementById('totalWithdrawals').textContent = `BDT ${totalWithdrawals.toFixed(2)}`;
            
            const userGrowthEl = document.getElementById('usersGrowth');
            if(userGrowthEl) {
                userGrowthEl.textContent = `+${newUsersToday} joined today`;
                userGrowthEl.style.color = newUsersToday > 0 ? '#166534' : 'var(--text-secondary)';
            }

            const balanceGrowthEl = document.getElementById('balanceGrowth');
            if(balanceGrowthEl) {
                balanceGrowthEl.textContent = `${activeToday} active today`;
                balanceGrowthEl.style.color = activeToday > 0 ? '#166534' : 'var(--text-secondary)';
            }

            const withdrawalsGrowthEl = document.getElementById('withdrawalsGrowth');
            if(withdrawalsGrowthEl) {
                withdrawalsGrowthEl.textContent = `${pendingWithdrawals} pending`;
                withdrawalsGrowthEl.style.color = pendingWithdrawals > 0 ? '#d97706' : 'var(--text-secondary)';
            }

            // Analytics stats
            const avgEarnings = activeToday > 0 ? totalEarnings / activeToday : 0;
            const totalAdsWatched = users.reduce((sum, user) => sum + (user.adsWatched || 0), 0);
            const completionRate = users.length > 0 ? (users.reduce((sum, user) => sum + (user.completedTasks || 0), 0) / (users.length * 1000)) * 100 : 0;

            if(document.getElementById('activeUsers')) document.getElementById('activeUsers').textContent = activeToday.toLocaleString();
            if(document.getElementById('avgEarnings')) document.getElementById('avgEarnings').textContent = `BDT ${avgEarnings.toFixed(2)}`;
            if(document.getElementById('totalAdsWatched')) document.getElementById('totalAdsWatched').textContent = totalAdsWatched.toLocaleString();
            if(document.getElementById('completionRate')) document.getElementById('completionRate').textContent = `${completionRate.toFixed(1)}%`;
        }
        // Helper to safely parse dates from any format (String, Timestamp, null)
function getSafeDate(dateInput) {
    if (!dateInput) return null;
    
    // Handle Firestore Timestamp objects (seconds/nanoseconds)
    if (dateInput && typeof dateInput === 'object' && dateInput.seconds) {
        return new Date(dateInput.seconds * 1000);
    }
    
    // Handle standard strings/numbers
    const date = new Date(dateInput);
    
    // Check if valid
    if (isNaN(date.getTime())) return null;
    
    return date;
}

        // Update recent activity
        function updateRecentActivity() {
            const recentWithdrawals = withdrawals
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .slice(0, 5);
            
            const container = document.getElementById('recentActivity');
            if (recentWithdrawals.length === 0) {
                container.innerHTML = '<p>No recent activity</p>';
                return;
            }

            let html = '';
            recentWithdrawals.forEach(withdrawal => {
                const date = new Date(withdrawal.timestamp).toLocaleDateString();
                const time = new Date(withdrawal.timestamp).toLocaleTimeString();
                const statusClass = withdrawal.status === 'completed' ? 'status-active' : 
                                   withdrawal.status === 'pending' ? 'status-badge' : 'status-inactive';
                
                html += `
                    <div class="setting-item">
                        <div>
                            <div style="font-weight: 500;">${withdrawal.username || 'User'}</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">
                                ${withdrawal.method} â€¢ ${date} ${time}
                            </div>
                        </div>
                        <div>
                            <div style="font-weight: 600;">BDT ${withdrawal.amount?.toFixed(2) || '0.00'}</div>
                            <span class="status-badge ${statusClass}" style="font-size: 0.75rem;">
                                ${withdrawal.status || 'pending'}
                            </span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // Update top users
        function updateTopUsers() {
            const topUsers = [...users]
                .sort((a, b) => (b.totalEarnings || 0) - (a.totalEarnings || 0))
                .slice(0, 10);
            
            const tbody = document.getElementById('topUsersBody');
            
            if (topUsers.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 1rem;">No users found</td></tr>';
                return;
            }

            let html = '';
            topUsers.forEach((user, index) => {
                html += `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div style="width: 24px; height: 24px; background: #1A5237; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem;">
                                    ${index + 1}
                                </div>
                                <div>
                                    <div style="font-weight: 500;">${user.name || user.username || 'Unknown'}</div>
                                    <div style="font-size: 0.75rem; color: var(--text-secondary);">${user.adsWatched || 0} ads</div>
                                </div>
                            </div>
                        </td>
                        <td style="font-weight: 600;">
                            BDT ${(user.totalEarnings || 0).toFixed(2)}
                        </td>
                        <td style="text-align: right;">
                            ${(user.adsWatched || 0).toLocaleString()}
                        </td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        // Update users table
        function updateUsersTable() {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedUsers = filteredUsers.slice(startIndex, endIndex);
            
            const tbody = document.getElementById('usersTableBody');
            
            if (paginatedUsers.length === 0) {
                tbody.innerHTML = `<tr><td colspan="10" style="text-align: center; padding: 2rem;">No users found</td></tr>`;
                return;
            }

            let html = '';
            paginatedUsers.forEach(user => {
                // USE SAFE DATE HERE
                const safeDate = getSafeDate(user.lastUpdated);
                const lastActive = safeDate ? safeDate.toLocaleString() : 'Never';
                    
                const statusClass = user.telegramDetected ? 'status-active' : 'status-inactive';
                const statusText = user.telegramDetected ? 'Active' : 'Inactive';
                
                let avatarHtml;
                if (user.profilePhoto) {
                    avatarHtml = `<img src="${user.profilePhoto}" class="user-avatar" alt="User">`;
                } else {
                    const initial = user.name ? user.name.charAt(0).toUpperCase() : (user.username ? user.username.charAt(0).toUpperCase() : 'U');
                    avatarHtml = `<div class="user-avatar">${initial}</div>`;
                }
                
                // ... inside updateUsersTable loop ...

html += `
    <tr>
        <td style="font-family: monospace; font-size: 0.85rem;">${user.id.substring(0, 8)}...</td>
        <td>
            <div style="display: flex; align-items: center; gap: 10px;">
                ${avatarHtml}
                <div>
                    <div style="font-weight: 500;">${user.name || 'N/A'}</div>
                    <div style="font-size: 0.85rem; color: var(--text-secondary);">
                        ${user.username || 'N/A'}
                    </div>
                </div>
            </div>
        </td>
        <td style="font-family: monospace; font-size: 0.85rem;">${user.id || 'N/A'}</td>
        <td style="font-weight: 600;">BDT ${(user.balance || 0).toFixed(2)}</td>
        <td>BDT ${(user.totalEarnings || 0).toFixed(2)}</td>
        <td>${(user.adsWatched || 0).toLocaleString()}</td>
        
        <td style="text-align: center; font-weight: 500;">
            ${user.country || '-'}
        </td>
        
        <td>${user.source === 'telegram' ? 'Telegram' : 'Web'}</td>
        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
        <td style="font-size: 0.85rem;">${lastActive}</td>
        <td>
            <div class="action-buttons">
                <button class="btn btn-edit" onclick="editUser('${user.id}')">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-delete" onclick="deleteUser('${user.id}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </td>
    </tr>
`;
            });
            
            tbody.innerHTML = html;
            updatePagination();
        }

        // Update withdrawals table
        function updateWithdrawalsTable() {
            const statusFilter = document.getElementById('withdrawalFilter').value;
            let filteredWithdrawals = withdrawals;
            
            if (statusFilter !== 'all') {
                filteredWithdrawals = withdrawals.filter(w => w.status === statusFilter);
            }
            
            const tbody = document.getElementById('withdrawalsTableBody');
            
            if (filteredWithdrawals.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 2rem;">
                            No withdrawal requests found
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            filteredWithdrawals.forEach(withdrawal => {
                const date = new Date(withdrawal.timestamp).toLocaleDateString();
                const statusClass = withdrawal.status === 'completed' ? 'status-active' : 
                                   withdrawal.status === 'pending' ? 'status-badge' : 'status-inactive';
                
                // ... inside the loop in updateWithdrawalsTable ...
                
html += `
    <tr>
        <td style="font-family: monospace; font-size: 0.85rem;">${withdrawal.id.substring(0, 8)}...</td>
        <td>${withdrawal.username || 'N/A'}</td>
        <td style="font-weight: 600;">BDT ${withdrawal.amount?.toFixed(2) || '0.00'}</td>
        <td>${withdrawal.method || 'N/A'}</td>
        <td style="font-family: monospace; font-size: 0.85rem;">
            ${withdrawal.address ? withdrawal.address.substring(0, 20) + (withdrawal.address.length > 20 ? '...' : '') : 'N/A'}
        </td>
        <td style="font-size: 0.85rem;">${date}</td>
        <td><span class="status-badge ${statusClass}">${withdrawal.status || 'pending'}</span></td>
        <td>
            <div class="action-buttons">
                ${withdrawal.status === 'pending' ? `
                <div id="row-btns-${withdrawal.id}" style="display: flex; gap: 8px;">
                    <button class="btn btn-edit" onclick="processWithdrawal('${withdrawal.id}', 'approve')">
                        <i class="fas fa-check"></i>
                    </button>
                    <button class="btn btn-delete" onclick="processWithdrawal('${withdrawal.id}', 'reject')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="row-spinner-${withdrawal.id}" style="display: none; align-items: center; justify-content: center; width: 60px; color: var(--text-secondary);">
                    <i class="fas fa-circle-notch fa-spin"></i>
                </div>
                ` : ''}
                
                <button class="btn" style="background: #dbeafe; color: #1d4ed8;" onclick="viewWithdrawal('${withdrawal.id}')">
                    <i class="fas fa-eye"></i>
                </button>
            </div>
        </td>
    </tr>
`;
            });
            
            tbody.innerHTML = html;
        }

        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
            const pageInfo = document.getElementById('pageInfo');
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages || totalPages === 0;
        }

       // --- NEW: REAL CHART DATA FUNCTIONS ---

        // Helper to get last 7 days labels (e.g., "Mon", "Tue")
        function getLast7DaysLabels() {
            const labels = [];
            for (let i = 6; i >= 0; i--) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                labels.push(d.toLocaleDateString('en-US', { weekday: 'short' }));
            }
            return labels;
        }

        // Helper to check if a date was X days ago
        function isDaysAgo(dateString, daysAgo) {
            if (!dateString) return false;
            const target = new Date();
            target.setDate(target.getDate() - daysAgo);
            const check = new Date(dateString);
            return check.getDate() === target.getDate() && 
                   check.getMonth() === target.getMonth() && 
                   check.getFullYear() === target.getFullYear();
        }

        function initializeCharts() {
            // Destroy existing charts to prevent overlays
            if (charts.userGrowth) charts.userGrowth.destroy();
            if (charts.revenue) charts.revenue.destroy();
            if (charts.source) charts.source.destroy();
            if (charts.activity) charts.activity.destroy();

            // Get contexts
            const userGrowthCtx = document.getElementById('userGrowthChart').getContext('2d');
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            const sourceCtx = document.getElementById('sourceChart').getContext('2d');
            const activityCtx = document.getElementById('activityChart').getContext('2d');

            // --- 1. CALCULATE REAL USER GROWTH (Last 7 Days) ---
            const labels = getLast7DaysLabels();
            const growthData = [];
            
            // Calculate cumulative users for each day
            let runningTotal = 0;
            
            // First, count users who joined BEFORE the last 7 days
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            runningTotal = users.filter(u => {
                const joinDate = getSafeDate(u.joinDate);
                return joinDate && joinDate < sevenDaysAgo;
            }).length;

            // Now add daily growth
            for (let i = 6; i >= 0; i--) {
                const newUsersToday = users.filter(u => {
                    const joinDate = getSafeDate(u.joinDate);
                    return joinDate && isDaysAgo(u.joinDate, i);
                }).length;
                
                runningTotal += newUsersToday;
                growthData.push(runningTotal);
            }

            // --- 2. CALCULATE REAL WITHDRAWALS (Last 7 Days) ---
            // (Note: We show Withdrawals because we don't have an "Earnings History" collection)
            const withdrawalData = [];
            for (let i = 6; i >= 0; i--) {
                const dailyTotal = withdrawals
                    .filter(w => isDaysAgo(w.timestamp, i))
                    .reduce((sum, w) => sum + (w.amount || 0), 0);
                withdrawalData.push(dailyTotal);
            }

            // --- 3. CALCULATE REAL ACTIVITY (Last 7 Days) ---
            const activityData = [];
            for (let i = 6; i >= 0; i--) {
                const activeCount = users.filter(u => {
                    const lastActive = getSafeDate(u.lastUpdated);
                    return lastActive && isDaysAgo(u.lastUpdated, i);
                }).length;
                activityData.push(activeCount);
            }

            // --- 4. SOURCE DISTRIBUTION (Real) ---
            const telegramUsers = users.filter(u => u.source === 'telegram').length;
            const webUsers = users.filter(u => u.source === 'web').length;


            // === RENDER CHARTS ===

            // 1. User Growth Chart
            charts.userGrowth = new Chart(userGrowthCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Users',
                        data: growthData,
                        borderColor: '#1A5237',
                        backgroundColor: 'rgba(26, 82, 55, 0.1)',
                        tension: 0.3,
                        fill: true,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                }
            });

            // 2. Financial Chart (Withdrawals)
            charts.revenue = new Chart(revenueCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Withdrawals (BDT)',
                        data: withdrawalData,
                        backgroundColor: '#3B7A57',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });

            // 3. Source Chart
            charts.source = new Chart(sourceCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Telegram', 'Web'],
                    datasets: [{
                        data: [telegramUsers, webUsers],
                        backgroundColor: ['#1A5237', '#3B7A57'],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });

            // 4. Activity Chart
            charts.activity = new Chart(activityCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Active Users',
                        data: activityData,
                        borderColor: '#FFD700',
                        backgroundColor: 'rgba(255, 215, 0, 0.1)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                }
            });
        }
        // Edit user with Telegram restrictions
        async function editUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;

            document.getElementById('editUserId').value = user.id;
            document.getElementById('editName').value = user.name || '';
            document.getElementById('editUsername').value = user.username || '';
            document.getElementById('editTelegramId').value = user.id || '';
            document.getElementById('editBalance').value = user.balance || 0;
            document.getElementById('editTotalEarnings').value = user.totalEarnings || 0;
            document.getElementById('editAdsWatched').value = user.adsWatched || 0;
            document.getElementById('editCompletedTasks').value = user.completedTasks || 0;
            document.getElementById('editSource').value = user.source || 'web';
            document.getElementById('editTelegramDetected').value = user.telegramDetected ? 'Yes' : 'No';

            // Handle Telegram user restrictions
            const isTelegramUser = user.source === 'telegram' && user.telegramDetected;
            
            if (isTelegramUser) {
                // Disable fields for Telegram users
                document.getElementById('editName').disabled = true;
                document.getElementById('editUsername').disabled = true;
                document.getElementById('editTelegramId').disabled = true;
                document.getElementById('editSource').disabled = true;
                document.getElementById('editTelegramDetected').disabled = true;
                
                // Show info messages
                document.getElementById('nameInfo').style.display = 'block';
                document.getElementById('usernameInfo').style.display = 'block';
            } else {
                // Enable fields for web users
                document.getElementById('editName').disabled = false;
                document.getElementById('editUsername').disabled = false;
                document.getElementById('editTelegramId').disabled = false;
                document.getElementById('editSource').disabled = false;
                document.getElementById('editTelegramDetected').disabled = false;
                
                // Hide info messages
                document.getElementById('nameInfo').style.display = 'none';
                document.getElementById('usernameInfo').style.display = 'none';
            }

            document.getElementById('editUserModal').classList.add('show');
        }

        // Delete user
        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                return;
            }

            try {
                await db.collection(USERS_COLLECTION).doc(userId).delete();
                showToast('User deleted successfully!', 'success');
                await loadUsers();
                await loadDashboardData();
                updateDashboardStats();
                updateTopUsers();
            } catch (error) {
                console.error("Error deleting user:", error);
                showToast('Failed to delete user.', 'error');
            }
        }

        // Process withdrawal - FIXED VERSION (no double deduction)
        // Process withdrawal - FIXED VERSION (Firebase Auth Compatible)
async function processWithdrawal(withdrawalId, action) {
    try {
        // --- UI FEEDBACK START ---
        // 1. Hide Table Buttons & Show Spinner
        const rowBtns = document.getElementById(`row-btns-${withdrawalId}`);
        const rowSpinner = document.getElementById(`row-spinner-${withdrawalId}`);
        if (rowBtns) rowBtns.style.display = 'none';
        if (rowSpinner) rowSpinner.style.display = 'flex';

        // 2. Hide Modal Buttons & Show Text (if modal is open)
        const modalBtns = document.getElementById(`modal-btns-${withdrawalId}`);
        if (modalBtns) {
            modalBtns.innerHTML = `
                <div style="width: 100%; text-align: center; padding: 1rem; background: #f1f5f9; border-radius: 10px; color: #64748b; font-weight: 500;">
                    <i class="fas fa-circle-notch fa-spin mr-2"></i> Processing Request...
                </div>
            `;
        }
        // --- UI FEEDBACK END ---

        console.log(`Processing withdrawal ${withdrawalId} with action: ${action}`);
        
        const withdrawal = withdrawals.find(w => w.id === withdrawalId);
        if (!withdrawal) {
            showToast('Withdrawal not found!', 'error');
            return;
        }

        const newStatus = action === 'approve' ? 'completed' : 'rejected';
        
        // FIX: Use 'currentUser.email' instead of 'adminCredentials.username'
        const adminName = currentUser && currentUser.email ? currentUser.email : 'Admin';

        // Update the withdrawal document
        await db.collection(WITHDRAWALS_COLLECTION).doc(withdrawalId).update({
            status: newStatus,
            processedAt: new Date().toISOString(),
            processedBy: adminName // <--- This was the error source
        });

        // If REJECTING, refund the user's balance
        if (action === 'reject' && withdrawal.userId) {
            try {
                const userRef = db.collection(USERS_COLLECTION).doc(withdrawal.userId);
                const userDoc = await userRef.get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    const currentBalance = userData.balance || 0;
                    const refundedBalance = currentBalance + withdrawal.amount;
                    
                    await userRef.update({ 
                        balance: refundedBalance,
                        lastUpdated: new Date().toISOString()
                    });
                }
            } catch (userError) {
                console.error('Error refunding user:', userError);
            }
        }
        
        showToast(`Withdrawal ${newStatus} successfully!`, "success");
        
        // Close modal if open
        const modal = document.getElementById('withdrawalModal');
        if (modal && modal.classList.contains('show')) {
            setTimeout(() => {
                closeWithdrawalModal();
            }, 500);
        }

        // Refresh data
        setTimeout(async () => {
            await loadWithdrawals();
            await loadUsers();
            await loadDashboardData();
            updateDashboardStats();
            updateRecentActivity();
            updateUsersTable();
            updateWithdrawalsTable(); 
        }, 1000);
        
    } catch (error) {
        console.error("Error processing withdrawal:", error);
        showToast(`Failed: ${error.message}`, 'error');
        
        // If error, reload table to restore buttons
        updateWithdrawalsTable();
    }
}

        // View withdrawal details
        async function viewWithdrawal(withdrawalId) {
            try {
                const withdrawal = withdrawals.find(w => w.id === withdrawalId);
                if (!withdrawal) {
                    showToast('Withdrawal not found!', 'error');
                    return;
                }

                const details = document.getElementById('withdrawalDetails');
                const date = new Date(withdrawal.timestamp).toLocaleString();
                const processedDate = withdrawal.processedAt ? 
                    new Date(withdrawal.processedAt).toLocaleString() : 'Not processed';
                
                details.innerHTML = `
                    <div class="form-group">
                        <label>Withdrawal ID</label>
                        <input type="text" value="${withdrawal.id || 'N/A'}" class="form-control" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>User ID</label>
                        <input type="text" value="${withdrawal.userId || 'N/A'}" class="form-control" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" value="${withdrawal.username || 'N/A'}" class="form-control" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" value="${withdrawal.name || 'N/A'}" class="form-control" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>Amount</label>
                        <input type="text" value="BDT ${withdrawal.amount?.toFixed(2) || '0.00'}" class="form-control" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>Method</label>
                        <input type="text" value="${withdrawal.method || 'N/A'}" class="form-control" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>Address</label>
                        <textarea class="form-control" rows="2" readonly>${withdrawal.address || 'N/A'}</textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Requested At</label>
                        <input type="text" value="${date}" class="form-control" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>Status</label>
                        <input type="text" value="${withdrawal.status || 'pending'}" class="form-control" readonly>
                    </div>
                    
                    ${withdrawal.processedAt ? `
                    <div class="form-group">
                        <label>Processed At</label>
                        <input type="text" value="${processedDate}" class="form-control" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label>Processed By</label>
                        <input type="text" value="${withdrawal.processedBy || 'N/A'}" class="form-control" readonly>
                    </div>
                    ` : ''}
                    
                    ${withdrawal.userBalanceBefore !== undefined ? `
                    <div class="form-group">
                        <label>User Balance Before</label>
                        <input type="text" value="BDT ${withdrawal.userBalanceBefore?.toFixed(2) || '0.00'}" class="form-control" readonly>
                    </div>
                    ` : ''}
                    
    ${withdrawal.status === 'pending' ? `
    <div id="modal-btns-${withdrawalId}" style="display: flex; gap: 1rem; margin-top: 1.5rem;">
        <button class="btn-primary" style="flex: 1; background: #1A5237;" onclick="processWithdrawal('${withdrawalId}', 'approve')">
            <i class="fas fa-check mr-2"></i> Approve
        </button>
        <button class="btn-primary" style="flex: 1; background: #dc2626;" onclick="processWithdrawal('${withdrawalId}', 'reject')">
            <i class="fas fa-times mr-2"></i> Reject
        </button>
    </div>
    ` : ''}
`;

                document.getElementById('withdrawalModal').classList.add('show');
            } catch (error) {
                console.error("Error viewing withdrawal:", error);
                showToast('Failed to load withdrawal details.', 'error');
            }
        }

        // Close modals
        function closeEditUserModal() {
            document.getElementById('editUserModal').classList.remove('show');
            // Re-enable all fields
            document.getElementById('editName').disabled = false;
            document.getElementById('editUsername').disabled = false;
            document.getElementById('editTelegramId').disabled = false;
            document.getElementById('editSource').disabled = false;
            document.getElementById('editTelegramDetected').disabled = false;
        }

        function closeWithdrawalModal() {
            document.getElementById('withdrawalModal').classList.remove('show');
        }

        // Show alert
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
            `;
            
            container.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        // Show toast notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            
            const title = type === 'success' ? 'Success!' : 
                         type === 'error' ? 'Error!' : 
                         type === 'info' ? 'Info' : 'Notification';
            
            toast.innerHTML = `
                <div class="toast-title">${title}</div>
                <div class="toast-message">${message}</div>
            `;
            
            container.appendChild(toast);
            
            // Show toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);
            
            // Remove toast after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }, 3000);
        }

        // Export users data
        function exportUsersData() {
            if (users.length === 0) {
                showToast("No users to export", "error");
                return;
            }

            const headers = ["ID", "Name", "Username", "Telegram ID", "Balance", "Earnings", "Ads Watched", "Completed Tasks", "Source", "Telegram Detected", "Last Updated"];
            
            const csvData = users.map(user => [
                user.id,
                user.name || "",
                user.username || "",
                user.id || "",
                user.balance || 0,
                user.totalEarnings || 0,
                user.adsWatched || 0,
                user.completedTasks || 0,
                user.source || "web",
                user.telegramDetected ? "Yes" : "No",
                user.lastUpdated || "Never"
            ]);

            const csvContent = [
                headers.join(","),
                ...csvData.map(row => row.map(cell => `"${cell}"`).join(","))
            ].join("\n");

            const blob = new Blob([csvContent], { type: "text/csv" });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `advault_users_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            showToast("Users data exported successfully!", "success");
        }

        // Auto-save settings when changed
        function setupAutoSaveListeners() {
            // Get all setting inputs
            const settingInputs = document.querySelectorAll('[data-setting]');
            
            settingInputs.forEach(input => {
                // Remove existing listeners to avoid duplicates
                const newInput = input.cloneNode(true);
                input.parentNode.replaceChild(newInput, input);
                
                // Add change listener
                newInput.addEventListener('change', function() {
                    const settingCard = this.closest('.setting-card');
                    if (settingCard) {
                        // Add visual feedback
                        settingCard.classList.add('settings-changed');
                        
                        // Remove feedback after 1 second
                        setTimeout(() => {
                            settingCard.classList.remove('settings-changed');
                        }, 1000);
                    }
                });
            });
        }

        // ============================================
        // CONTENT & ADS MANAGEMENT FUNCTIONS
        // ============================================

        // Marquee Management
        async function addMarquee() {
            const country = document.getElementById('mqCountry').value.toUpperCase() || 'default';
            const text = document.getElementById('mqText').value.trim();
            
            if (!text) {
                showToast('Please enter marquee text', 'error');
                return;
            }

            contentSettings.marqueeSettings[country] = text;
            await saveContentSettings();
            
            // Clear inputs
            document.getElementById('mqCountry').value = '';
            document.getElementById('mqText').value = '';
            
            renderMarqueeList();
        }

        async function deleteMarquee(country) {
            if (!confirm('Are you sure you want to delete this marquee?')) {
                return;
            }
            
            delete contentSettings.marqueeSettings[country];
            await saveContentSettings();
            renderMarqueeList();
        }

        function renderMarqueeList() {
            const list = document.getElementById('marqueeList');
            
            const marquees = Object.entries(contentSettings.marqueeSettings);
            
            if (marquees.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 1rem;">No marquees added yet</p>';
                return;
            }

            let html = '';
            marquees.forEach(([country, text]) => {
                html += `
                    <div class="list-item">
                        <div>
                            <span class="country-badge">${country}</span>
                            <span>${text}</span>
                        </div>
                        <button onclick="deleteMarquee('${country}')" class="btn btn-delete" style="padding: 4px 8px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }
// --- NEW HELPER: Auto-Update Icon based on Type ---
function updatePmIcon() {
    const type = document.getElementById('pmType').value;
    const iconInput = document.getElementById('pmIcon');
    
    if (type === 'number') {
        iconInput.value = 'fas fa-mobile-alt'; // Mobile Icon
    } else if (type === 'email') {
        iconInput.value = 'fas fa-credit-card'; // Card Icon (as requested)
    } else {
        iconInput.value = 'fas fa-wallet'; // Wallet Icon
    }
}
        // Payment Methods Management
        async function addPaymentMethod() {
    const name = document.getElementById('pmName').value.trim();
    const type = document.getElementById('pmType').value;
    // NEW: Get values from new inputs
    const icon = document.getElementById('pmIcon').value.trim() || 'fas fa-wallet';
    const color = document.getElementById('pmColor').value.trim() || '#10b981';
    const minWithdraw = parseFloat(document.getElementById('pmMin').value) || 100;
    
    if (!name) {
        showToast('Please enter payment method name', 'error');
        return;
    }

    const id = name.toLowerCase().replace(/\s+/g, '_');
    
    // Check if already exists
    const exists = contentSettings.paymentMethods.some(pm => pm.id === id);
    if (exists) {
        showToast('Payment method already exists', 'error');
        return;
    }

    // Save full object structure
    contentSettings.paymentMethods.push({ id, name, type, icon, color, minWithdraw });
    await saveContentSettings();
    
    // Clear inputs & Reset Icon
    document.getElementById('pmName').value = '';
    document.getElementById('pmColor').value = '';
    updatePmIcon(); // Reset icon to default based on current selection
    
    renderPaymentMethodList();
}

async function deletePaymentMethod(idx) {
            if (!confirm('Are you sure you want to delete this payment method?')) {
                return;
            }
            
            // Remove from array
            contentSettings.paymentMethods.splice(idx, 1);
            
            // Save to database
            await saveContentSettings();
            
            // Refresh list
            renderPaymentMethodList();
        }
        function renderPaymentMethodList() {
            const list = document.getElementById('paymentMethodList');
            
            if (contentSettings.paymentMethods.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 1rem;">No payment methods added yet</p>';
                return;
            }

            let html = '';
            contentSettings.paymentMethods.forEach((pm, idx) => {
                const typeBadge = pm.type === 'email' ? 'Email' : 
                                pm.type === 'number' ? 'Phone' : 'Text';
                
                html += `
                    <div class="list-item">
                        <div>
                            <span style="font-weight: 600;">${pm.name}</span>
                            <span class="badge ml-2">${typeBadge}</span>
                        </div>
                        <button onclick="deletePaymentMethod(${idx})" class="btn btn-delete" style="padding: 4px 8px;">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
            });
            
            list.innerHTML = html;
        }

       async function addAdService() {
    const name = document.getElementById('adName').value.trim();
    const type = document.getElementById('adType').value;
    const code = document.getElementById('adCode').value.trim();
    const reward = parseFloat(document.getElementById('adReward').value) || 0.10;
    // NEW VALUE
    const duration = parseInt(document.getElementById('adDurationInput').value) || 30;
    
    if (!name || !code) {
        showToast('Please fill all fields', 'error');
        return;
    }

    contentSettings.adServices.push({ 
        id: Date.now().toString(), 
        name, 
        type, 
        code, 
        reward,
        duration, // Save duration
        active: true 
    });
    
    await saveContentSettings();
    
    // Clear inputs
    document.getElementById('adName').value = '';
    document.getElementById('adCode').value = '';
    document.getElementById('adReward').value = '';
    
    renderAdServiceList();
}

        async function toggleAdService(idx) {
            contentSettings.adServices[idx].active = !contentSettings.adServices[idx].active;
            await saveContentSettings();
            renderAdServiceList();
        }

        async function deleteAdService(idx) {
            if (!confirm('Are you sure you want to delete this ad service?')) {
                return;
            }
            
            contentSettings.adServices.splice(idx, 1);
            await saveContentSettings();
            renderAdServiceList();
        }

        function renderAdServiceList() {
    const list = document.getElementById('adServiceList');
    
    if (contentSettings.adServices.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 1rem;">No ad services added yet</p>';
        return;
    }

    let html = '';
    contentSettings.adServices.forEach((ad, idx) => {
        const icon = ad.type === 'smartlink' ? 'fa-link' : 'fa-image';
        const opacityClass = ad.active ? 'ad-active' : 'ad-inactive';
        const toggleClass = ad.active ? 'active' : 'inactive';
        const toggleIcon = ad.active ? 'fa-power-off' : 'fa-power-off';
        const toggleColor = ad.active ? '#10b981' : '#9ca3af';
        // NEW: Format the reward
        const rewardDisplay = ad.reward ? `${parseFloat(ad.reward).toFixed(2)} BDT` : '0.10 BDT';
        
        html += `
            <div class="list-item ${opacityClass}">
                <div style="display: flex; align-items: center; gap: 12px; overflow: hidden;">
                    <div class="ad-icon" style="flex-shrink: 0;">
                        <i class="fas ${icon}"></i>
                    </div>
                    <div style="min-width: 0;">
                        <div style="font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${ad.name}</div>
                        <div style="font-size: 0.85rem; color: var(--text-secondary); display: flex; gap: 8px;">
                            <span style="text-transform: uppercase;">${ad.type}</span>
                            <span style="color: #10b981; font-weight: 600;">â€¢ ${rewardDisplay}</span>
                        </div>
                    </div>
                </div>
                <div style="display: flex; gap: 8px; flex-shrink: 0;">
                    <button onclick="toggleAdService(${idx})" class="toggle-ad-btn ${toggleClass}" style="color: ${toggleColor};">
                        <i class="fas ${toggleIcon}"></i>
                    </button>
                    <button onclick="deleteAdService(${idx})" class="btn btn-delete" style="padding: 4px 8px;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    
    list.innerHTML = html;
}
        // Event Listeners
        // Event Listeners
document.addEventListener('DOMContentLoaded', async () => {
    
    // 1. Check for Telegram Auto-Login first
    await checkTelegramAutoLogin();
    
    // REMOVED: checkLogin(); 
    // Reason: auth.onAuthStateChanged now handles this automatically.

    // 2. Navigation Logic
    document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', (e) => {
            e.preventDefault();
            const section = item.dataset.section;
            
            // Handle logout
            if (section === 'logout') {
                logout();
                return;
            }
            
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            
            // Update page titles & subtitles
            const titles = {
                dashboard: 'Dashboard Overview',
                analytics: 'Analytics & Insights',
                users: 'User Management',
                withdrawals: 'Withdrawal Requests',
                notifications: 'Push Notifications',
                content: 'Content Management',
                ads: 'Ads Manager',
                settings: 'System Settings'
            };
            
            const subtitles = {
                dashboard: 'Welcome to AdVault Admin Panel',
                analytics: 'Detailed analytics and insights',
                users: 'Manage all user accounts',
                withdrawals: 'Process withdrawal requests',
                notifications: 'Send messages to users',
                content: 'Manage marquees and payment methods',
                ads: 'Configure Adsterra scripts',
                settings: 'Configure system settings'
            };
            
            document.getElementById('pageTitle').textContent = titles[section] || 'Admin Panel';
            document.getElementById('pageSubtitle').textContent = subtitles[section] || 'Control Panel';
            
            // Show selected section
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.getElementById(`${section}Section`).style.display = 'block';
            
            // Load specific data based on section
            if (section === 'notifications') loadNotifications();
            if (section === 'settings') setTimeout(() => { setupAutoSaveListeners(); }, 100);
            if (section === 'content') {
                renderMarqueeList();
                renderPaymentMethodList();
            }
            if (section === 'ads') renderAdServiceList();
            
            // Close sidebar on mobile
            if (window.innerWidth <= 1024) {
                document.getElementById('sidebar').classList.remove('active');
                document.getElementById('sidebarOverlay').classList.remove('active');
            }
        });
    });

    // 3. Theme toggle listeners
    document.getElementById('themeToggle').addEventListener('click', () => toggleTheme());
    document.getElementById('mobileThemeToggle').addEventListener('click', () => toggleTheme());

    // Theme toggle function
    function toggleTheme() {
        const currentTheme = document.body.getAttribute('data-theme');
        const newTheme = currentTheme === 'light' ? 'dark' : 'light';
        document.body.setAttribute('data-theme', newTheme);
        
        // Update icons
        const desktopIcon = document.querySelector('#themeToggle i');
        if (desktopIcon) desktopIcon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        
        const mobileIcon = document.querySelector('#mobileThemeToggle i');
        if (mobileIcon) mobileIcon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        
        localStorage.setItem('adminTheme', newTheme);
        
        if (charts.userGrowth) initializeCharts();
    }

    // 4. Mobile menu toggle
    document.getElementById('menuToggle').addEventListener('click', () => {
        document.getElementById('sidebar').classList.add('active');
        document.getElementById('sidebarOverlay').classList.add('active');
    });

    document.getElementById('sidebarOverlay').addEventListener('click', () => {
        document.getElementById('sidebar').classList.remove('active');
        document.getElementById('sidebarOverlay').classList.remove('active');
    });

    // 5. Search & Filters
    document.getElementById('userSearch').addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        filteredUsers = users.filter(user => 
            (user.name && user.name.toLowerCase().includes(searchTerm)) ||
            (user.username && user.username.toLowerCase().includes(searchTerm)) ||
            (user.id && user.id.toLowerCase().includes(searchTerm))
        );
        currentPage = 1;
        updateUsersTable();
    });

    document.getElementById('withdrawalFilter').addEventListener('change', updateWithdrawalsTable);

    // 6. Pagination
    document.getElementById('prevPage').addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            updateUsersTable();
        }
    });

    document.getElementById('nextPage').addEventListener('click', () => {
        const totalPages = Math.ceil(filteredUsers.length / itemsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            updateUsersTable();
        }
    });

    // 7. Edit User Form Submit
    document.getElementById('editUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const userId = document.getElementById('editUserId').value;
        const user = users.find(u => u.id === userId);
        const isTelegramUser = user && user.source === 'telegram' && user.telegramDetected;
        
        const updates = {
            balance: parseFloat(document.getElementById('editBalance').value),
            totalEarnings: parseFloat(document.getElementById('editTotalEarnings').value),
            adsWatched: parseInt(document.getElementById('editAdsWatched').value),
            completedTasks: parseInt(document.getElementById('editCompletedTasks').value),
            lastUpdated: new Date().toISOString()
        };

        if (!isTelegramUser) {
            updates.name = document.getElementById('editName').value;
            updates.username = document.getElementById('editUsername').value;
            updates.source = document.getElementById('editSource').value;
            updates.telegramDetected = document.getElementById('editTelegramDetected').value === 'Yes';
        }

        try {
            await db.collection(USERS_COLLECTION).doc(userId).update(updates);
            showToast('User updated successfully!', 'success');
            closeEditUserModal();
            await loadUsers();
            await loadDashboardData();
            updateDashboardStats();
            updateTopUsers();
        } catch (error) {
            console.error("Error updating user:", error);
            showToast('Failed to update user.', 'error');
        }
    });

    // 8. Enter Key for Login
    document.getElementById('adminPassword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            document.getElementById('loginBtn').click();
        }
    });

    // 9. Add "Save All" Button
    const saveAllBtn = document.createElement('button');
    saveAllBtn.className = 'save-settings-btn';
    saveAllBtn.innerHTML = '<i class="fas fa-save"></i> Save All Settings';
    saveAllBtn.style.marginTop = '2rem';
    saveAllBtn.style.width = '100%';
    saveAllBtn.onclick = () => saveSettings('all');
    
    const settingsSection = document.getElementById('settingsSection');
    if (settingsSection) settingsSection.appendChild(saveAllBtn);

    // 10. Load Saved Theme
    const savedTheme = localStorage.getItem('adminTheme') || 'light';
    document.body.setAttribute('data-theme', savedTheme);
    
    const desktopIcon = document.querySelector('#themeToggle i');
    if (desktopIcon) desktopIcon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
    
    const mobileIcon = document.querySelector('#mobileThemeToggle i');
    if (mobileIcon) mobileIcon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';

    // 11. Auto-refresh Interval
    setInterval(async () => {
        if (adminLoggedIn) {
            await loadDashboardData();
            updateDashboardStats();
            updateRecentActivity();
            updateTopUsers();
            if (charts.userGrowth) initializeCharts();
        }
    }, 60000);
});
    </script>
</body>
</html>
